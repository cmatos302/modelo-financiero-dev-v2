<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modelo Financiero de Consultor√≠a [DEV v2.0]</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f7f9fc;
      color: #333;
    }
    /* Header */
    .header {
      text-align: center;
      padding: 20px 10px;
      border-bottom: 1px solid #ced6e0;
    }
    .header img {
      max-width: 150px;
      height: auto;
      display: block;
      margin: 0 auto 10px auto;
    }
    .header .company-name {
      font-size: 1.4em;
      font-weight: bold;
      color: #1a3665;
      margin-bottom: 5px;
    }
    .print-system-name { display: none; }

    /* Subtitle styling */
    .subtitle {
      font-size: 1.2em;
      color: #1a3665;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .header-line {
      border: none;
      border-top: 1px solid #ced6e0;
      margin: 10px auto 0 auto;
      width: 90%;
    }
    .dev-banner {
      width: 100%;
      text-align: center;
      background: #fff3cd;
      color: #7a5200;
      border-bottom: 1px solid #f5d58a;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .4px;
      padding: 6px 10px;
      box-sizing: border-box;
    }
    .dev-auth-chip {
      width: 100%;
      text-align: center;
      background: #e8f5e9;
      color: #1b5e20;
      border-bottom: 1px solid #c8e6c9;
      font-size: 12px;
      padding: 5px 10px;
      box-sizing: border-box;
    }
    .dev-auth-chip a { color: #0a66c2; text-decoration: none; font-weight: 600; }
    .dev-auth-chip a:hover { text-decoration: underline; }
    .dev-auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(242, 244, 248, .74);
      backdrop-filter: blur(10px) saturate(140%);
      -webkit-backdrop-filter: blur(10px) saturate(140%);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .dev-auth-card {
      width: min(430px, 96vw);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(60,60,67,.16);
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(0,0,0,.10);
    }
    .dev-auth-card h3 { margin: 0 0 6px 0; font-size: 1.9rem; line-height: 1.05; letter-spacing: -.02em; }
    .dev-auth-card p { margin: 0 0 14px 0; color:#6b6b70; font-size: 14px; line-height: 1.3; }
    .dev-auth-grid { display: grid; gap: 10px; }
    .dev-auth-grid label { display:block; font-size: 13px; font-weight: 600; color:#1d1d1f; }
    .dev-auth-grid input {
      margin-top: 6px;
      width: 100%;
      height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(60,60,67,.22);
      background: rgba(255,255,255,.92);
      padding: 0 12px;
      box-sizing: border-box;
      outline: none;
      font-size: 17px;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .dev-auth-grid input:focus {
      border-color: #0a84ff;
      box-shadow: 0 0 0 3px rgba(10,132,255,.18);
    }
    .dev-auth-actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 12px; }
    .hidden { display:none !important; }
    /* Navigation */
    .nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      background-color: #304a72;
      padding: 10px 0;
    }
    .nav button {
      background-color: #304a72;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    }
    .nav button.active {
      background-color: #1a3665;
    }
    .page {
      display: none;
      padding: 20px;
    }
    .page.active {
      display: block;
    }
    /* Tables and forms */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ced6e0;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background-color: #304a72;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #e7eff9;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
      border: 1px solid #b0c4de;
      border-radius: 3px;
    }
    input[type="number"] {
      text-align: right;
    }
    td.c-cost, td.pm-cost {
      text-align: right;
    }
    .results {
      background-color: #f0f4f8;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #dce4ec;
      max-width: 600px;
      margin-top: 20px;
    }

    #page-consult > .results {
      max-width: var(--content-w) !important;
      width: var(--content-w);
      margin-left: auto;
      margin-right: auto;
    }
    .results div {
      margin-bottom: 8px;
    }
    .results .label {
      font-weight: bold;
    }
    .results .value {
      float: right;
      font-weight: bold;
      color: #0a3d62;
      text-align: right;
    }
    .db-form {
      max-width: 600px;
      background-color: #f0f4f8;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #dce4ec;
      margin-bottom: 20px;
    }
    .db-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .db-form input[type="text"], .db-form input[type="number"], .db-form input[type="date"] {
      width: 100%;
      padding: 4px;
      border: 1px solid #b0c4de;
      border-radius: 3px;
      margin-top: 4px;
    }
    .db-form button {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      background-color: #304a72;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .db-form button:hover {
      background-color: #24395a;
    }
    .percent-input {
      display: flex;
      align-items: center;
    }
    .percent-input input {
      flex-grow: 1;
    }
    .percent-input span {
      margin-left: 5px;
      font-weight: bold;
    }

    /* Apple-style UI refresh */
    :root {
      --bg: #f5f5f7;
      --panel: rgba(255, 255, 255, 0.86);
      --line: rgba(60, 60, 67, 0.18);
      --text: #1d1d1f;
      --muted: #6e6e73;
      --blue: #0071e3;
      --blue-hover: #0062c3;
      --shadow: 0 8px 30px rgba(0,0,0,.08);
      --radius: 14px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top, #ffffff 0%, var(--bg) 55%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h2, h3 { color: var(--text); letter-spacing: -0.01em; }

    .apple-header {
      background: linear-gradient(180deg, rgba(255,255,255,.90), rgba(248,248,250,.82));
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--line);
      padding: 20px 16px 14px;
    }

    .apple-header-inner {
      max-width: 1280px;
      margin: 0 auto;
      text-align: center;
    }

    .apple-header .brand-logo {
      width: 98px;
      height: auto;
      margin: 0 auto 8px;
      display: block;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.12));
    }

    .apple-header .brand-meta {
      font-size: 13px;
      font-weight: 500;
      color: #8e8e93;
      letter-spacing: .01em;
      margin-bottom: 10px;
    }

    .apple-header .company-name {
      color: #1d1d1f;
      font-weight: 700;
      font-size: clamp(1.45rem, 2.3vw, 2.0rem);
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }

    .apple-header .subtitle {
      color: #6e6e73;
      font-weight: 600;
      font-size: clamp(1rem, 1.8vw, 1.65rem);
      letter-spacing: -0.01em;
      text-transform: uppercase;
      margin-bottom: 14px;
    }

    .apple-header .header-line {
      border: 0;
      border-top: 1px solid rgba(60,60,67,.20);
      margin: 0 auto;
      width: min(1200px, 92%);
    }

    .page {
      max-width: 1240px;
      margin: 0 auto;
      --content-w: min(1240px, 96%);
    }

    /* Alineaci√≥n profesional uniforme por p√°gina */
    #page-consult > h2,
    #page-consult > .db-form,
    #page-consult > .actions-bar,
    #page-consult > .kpi-grid,
    #page-consult > h3,
    #page-consult > table,
    #page-consult > .helper-text,
    #page-consult > .results {
      width: var(--content-w);
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #page-db > h2,
    #page-db > p,
    #page-db > .db-grid,
    #page-db > .section-card,
    #page-db > #cloud-config-box {
      width: var(--content-w);
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #page-history > h2,
    #page-history > p,
    #page-history > .actions-bar,
    #page-history > .kpi-grid,
    #page-history > .section-card,
    #page-history > table,
    #page-rates > h2,
    #page-rates > p,
    #page-rates > .actions-bar,
    #page-rates > .section-card,
    #page-fiscal > h2,
    #page-fiscal > p,
    #page-fiscal > .section-card,
    #page-liquidation > h2,
    #page-liquidation > p,
    #page-liquidation > .section-card,
    #page-liquidation > .results {
      width: var(--content-w);
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #page-fiscal > .db-form.section-card {
      width: var(--content-w);
      max-width: var(--content-w);
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #page-fiscal .consult-grid {
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap: 12px;
    }

    #page-fiscal .actions-bar {
      width: 100%;
      box-sizing: border-box;
    }

    /* Pulido de alineaci√≥n en hoja Hist√≥rico */
    #page-history > h2,
    #page-history > p {
      padding-left: 8px;
      padding-right: 8px;
      margin-top: 0;
      margin-bottom: 10px;
    }

    #page-history .actions-bar,
    #page-history .section-card,
    #page-history .kpi-grid,
    #page-history table {
      padding-left: 10px;
      padding-right: 10px;
    }

    #page-history .section-card > h3 {
      padding-left: 2px;
      margin-top: 2px;
      margin-bottom: 12px;
    }

    #page-history table th,
    #page-history table td {
      padding: 10px 12px;
    }

    #page-history .helper-text {
      padding-left: 2px;
      padding-right: 2px;
    }

    #page-rates .helper-text {
      text-align: left;
      padding: 0 12px;
      margin: 0;
      min-height: 34px;
      display: flex;
      align-items: center;
    }

    #page-rates .rate-note {
      padding: 10px 12px 12px;
      margin-top: -8px;
      border-top: 1px solid rgba(60,60,67,.10);
      align-items: center;
      box-sizing: border-box;
    }

    .nav {
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 8px;
      background: rgba(255,255,255,.72);
      backdrop-filter: saturate(180%) blur(18px);
      -webkit-backdrop-filter: saturate(180%) blur(18px);
      border-bottom: 1px solid var(--line);
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }

    .nav button {
      background: transparent;
      color: #1d1d1f;
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      transition: all .2s ease;
    }
    .nav button:hover {
      background: rgba(0,0,0,.05);
    }
    .nav button.active {
      background: #1d1d1f;
      color: #fff;
    }

    .db-form,
    .results,
    table,
    .section-card,
    .actions-bar,
    .kpi-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: saturate(160%) blur(12px);
      -webkit-backdrop-filter: saturate(160%) blur(12px);
    }

    table { overflow: hidden; }
    th, td { border-color: rgba(60,60,67,.12); }
    th {
      background: rgba(245,245,247,.92);
      color: #1d1d1f;
      font-weight: 650;
    }
    tr:nth-child(even) { background-color: rgba(245,245,247,.65); }

    input[type="text"],
    input[type="number"],
    select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(60,60,67,.22);
      color: var(--text);
      background: #fff;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: rgba(0,113,227,.55);
      box-shadow: 0 0 0 4px rgba(0,113,227,.14);
    }

    button {
      border: 1px solid rgba(255,255,255,.45);
      border-radius: 14px;
      padding: 11px 16px;
      background: linear-gradient(180deg, #0a84ff 0%, #0071e3 100%);
      color: #fff;
      font-weight: 650;
      letter-spacing: -0.01em;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,113,227,.25), inset 0 1px 0 rgba(255,255,255,.35);
      transition: all .18s ease;
    }
    button:hover {
      filter: brightness(1.03);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0,113,227,.28), inset 0 1px 0 rgba(255,255,255,.4);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0,113,227,.24), inset 0 1px 0 rgba(255,255,255,.32);
    }

    #page-consult .db-form {
      width: var(--content-w);
      max-width: var(--content-w);
      margin: 0 auto 14px;
      padding: 14px;
      box-sizing: border-box;
    }

    .consult-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      align-items: start;
      width: 100%;
    }

    .consult-grid label {
      min-width: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-weight: 650;
    }

    #clientSelect,
    #projectName {
      width: 100%;
      min-width: 0;
      height: 52px;
      box-sizing: border-box;
      border-radius: 14px !important;
      -webkit-appearance: none;
      appearance: none;
      padding: 0 14px;
      line-height: 52px;
    }

    #projectName {
      background: rgba(255,255,255,.98);
    }

    .actions-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
      padding: 14px;
      align-items: flex-end;
    }

    .actions-bar label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 210px;
      font-weight: 600;
      color: #2c2c2e;
    }

    .actions-bar input[type="date"],
    .actions-bar select {
      min-height: 46px;
      min-width: 220px;
      font-size: 15px;
      border-radius: 14px;
      background: rgba(255,255,255,.95);
    }

    #historyClientFilter,
    #clientSelect {
      min-width: 280px;
    }

    /* Ajustes de bloque filtros en Historial */
    .history-filters {
      display: grid;
      grid-template-columns: minmax(320px, 1.35fr) minmax(190px, 0.8fr) minmax(190px, 0.8fr) auto;
      gap: 12px;
      align-items: end;
    }

    .history-filters .filter-client select {
      min-width: 320px;
    }

    .history-filters .filter-date input[type="date"] {
      min-width: 180px;
      max-width: 220px;
    }

    .history-filter-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-self: end;
    }

    .history-filter-buttons button {
      min-width: 150px;
      width: 170px;
    }

    /* Historial de planillas: estandarizaci√≥n (scope exclusivo) */
    #page-history .page-container {
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: 100%;
      margin: 0 auto;
      padding: 0;
    }
    #page-history .page-container > * {
      margin: 0 !important;
    }
    #page-history .history-intro {
      text-align: left;
      line-height: 1.35;
    }
    #page-history .history-filters {
      grid-template-columns: minmax(320px, 1.35fr) minmax(200px, 0.85fr) minmax(200px, 0.85fr) auto;
      gap: 10px;
      align-items: end;
      padding: 8px 10px;
    }
    #page-history .history-filters label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      margin-bottom: 0;
    }
    #page-history .history-filters select,
    #page-history .history-filters input[type="date"],
    #page-history .history-filter-buttons button {
      height: 40px;
      box-sizing: border-box;
    }
    #page-history .history-filters select,
    #page-history .history-filters input[type="date"] {
      padding: 7px 10px;
    }
    #page-history .history-filters .filter-date input[type="date"] {
      width: 100%;
      min-width: 200px;
      max-width: 200px;
    }
    #page-history .history-filter-buttons {
      align-self: end;
      justify-self: end;
      align-items: stretch;
      justify-content: flex-end;
      gap: 6px;
    }

    /* KPI balance visual */
    #page-history .kpi-grid {
      grid-template-columns: minmax(140px, .78fr) minmax(180px, .95fr) minmax(180px, .95fr) minmax(260px, 1.32fr);
      align-items: stretch;
      margin: 0 !important;
      gap: 10px;
    }
    #page-history .kpi-card {
      min-height: 72px;
      height: 72px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      box-sizing: border-box;
    }
    #page-history .kpi-card .kpi-label {
      margin: 0;
      line-height: 1.1;
    }
    #page-history .kpi-card .kpi-value {
      display: block;
      margin: 0;
      text-align: right;
      font-weight: 700;
      font-size: 1.15rem;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #page-history #repTopClient {
      text-align: left;
      font-size: 1.08rem;
    }

    /* Tablas robustas sin desborde */
    #page-history #historyTable,
    #page-history #historyClientRankingTable {
      width: 100%;
      table-layout: fixed;
    }
    #page-history .history-ranking-card {
      padding-top: 12px;
      padding-bottom: 10px;
    }
    #page-history .history-ranking-card h3 {
      margin-top: 2px !important;
      margin-bottom: 8px;
    }
    #page-history #historyTable th,
    #page-history #historyTable td,
    #page-history #historyClientRankingTable th,
    #page-history #historyClientRankingTable td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }

    /* historyTable: # compacto, fecha centrada, cliente/proyecto flexibles, monto derecha */
    #page-history #historyTable th:nth-child(1),
    #page-history #historyTable td:nth-child(1) { width: 56px; text-align: center; }
    #page-history #historyTable th:nth-child(2),
    #page-history #historyTable td:nth-child(2) { width: 170px; text-align: center; }
    #page-history #historyTable th:nth-child(5),
    #page-history #historyTable td:nth-child(5) { width: 120px; text-align: right; white-space: nowrap; }
    #page-history #historyTable th:nth-child(6),
    #page-history #historyTable td:nth-child(6) { width: 110px; text-align: center; white-space: nowrap; }
    #page-history #historyTable th:nth-child(3),
    #page-history #historyTable td:nth-child(3),
    #page-history #historyTable th:nth-child(4),
    #page-history #historyTable td:nth-child(4) { text-align: left; }
    #page-history .history-actions {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      justify-content: center;
    }
    #page-history .history-actions .mini-icon-btn {
      font-size: 13px;
      line-height: 1;
      color: #4f5560;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 2px !important;
      min-width: auto !important;
      width: auto !important;
      height: auto !important;
    }

    /* ranking: m√©tricas num√©ricas a la derecha */
    #page-history #historyClientRankingTable th:nth-child(2),
    #page-history #historyClientRankingTable td:nth-child(2),
    #page-history #historyClientRankingTable th:nth-child(3),
    #page-history #historyClientRankingTable td:nth-child(3) {
      text-align: right;
      white-space: nowrap;
      width: 160px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 10px;
      margin: 10px 0 20px;
    }

    .kpi-card { padding: 12px; }
    .kpi-label { font-size: 12px; color: var(--muted); display: block; }
    .kpi-value { font-size: 1.14rem; font-weight: 700; color: var(--text); }

    .final-highlight {
      border: 1px solid rgba(0,113,227,.35);
      background: linear-gradient(180deg, rgba(0,113,227,.12), rgba(255,255,255,.9));
    }

    .helper-text {
      color: var(--muted);
      font-size: 13px;
      margin-top: 4px;
    }

    .pill {
      display: inline-block;
      background: rgba(0,0,0,.06);
      color: #3a3a3c;
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 12px;
      margin-left: 8px;
    }

    /* DB page Apple layout */
    #page-db {
      max-width: 1240px;
      margin: 0 auto;
    }

    #page-db > h2,
    #page-db > p {
      margin-left: 4px;
      margin-right: 4px;
    }
    .db-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 16px;
      margin: 12px 0 20px;
      align-items: stretch;
    }

    .db-card-title {
      margin: 2px 0 12px 0;
      padding: 0;
      font-size: 1.06rem;
      line-height: 1.28;
      letter-spacing: -0.01em;
      color: #1d1d1f;
    }

    #page-db .db-form {
      max-width: none;
      margin-bottom: 0;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-sizing: border-box;
    }

    #page-db .db-form label {
      margin-top: 0;
      display: flex;
      flex-direction: column;
      gap: 7px;
      font-weight: 640;
      line-height: 1.2;
    }

    #page-db .db-form input,
    #page-db .db-form select {
      width: 100%;
      min-height: 46px;
      box-sizing: border-box;
      border-radius: 12px;
    }

    #clientSelect {
      font-weight: 700;
      font-size: 1.03rem;
    }

    #projectName {
      font-weight: 700;
      font-size: 1.03rem;
    }

    #taxProjectSelect,
    #taxConsultorSelect {
      font-weight: 700;
      font-size: 1.03rem;
    }

    #page-fiscal input[type="text"],
    #page-fiscal input[type="number"],
    #page-fiscal input[type="date"],
    #page-fiscal select,
    #page-liquidation input[type="text"],
    #page-liquidation input[type="number"],
    #page-liquidation input[type="date"],
    #page-liquidation select {
      width: 100%;
      min-height: 46px;
      box-sizing: border-box;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(60,60,67,.20);
      background: #fff;
    }

    #page-fiscal input[type="number"],
    #page-fiscal input[type="date"],
    #page-liquidation input[type="number"],
    #page-liquidation input[type="date"] {
      text-align: right;
    }

    #page-liquidation .section-card,
    #page-liquidation .db-form {
      border-radius: 16px;
      padding: 14px 16px;
      box-sizing: border-box;
    }

    #page-liquidation > .db-form.section-card {
      width: var(--content-w);
      max-width: var(--content-w);
      margin-left: auto;
      margin-right: auto;
    }

    /* SOLO bloque superior de Liquidaci√≥n (Cliente/Proyecto/Monto venta) */
    #page-liquidation #liqHeaderBlock #liqClientFilter,
    #page-liquidation #liqHeaderBlock #liqProjectSelect,
    #page-liquidation #liqHeaderBlock #liqSaleAmount {
      font-weight: 700;
      font-size: 1.03rem;
      min-height: 50px;
    }

    #page-liquidation h3,
    #page-liquidation label,
    #page-liquidation p,
    #page-liquidation .helper-text {
      padding-left: 2px;
      padding-right: 2px;
      box-sizing: border-box;
    }

    #page-liquidation table th,
    #page-liquidation table td {
      padding: 8px 10px;
      vertical-align: middle;
      font-size: 0.92rem;
      line-height: 1.2;
      white-space: nowrap;
    }

    #page-liquidation #liqInvoicesTable th,
    #page-liquidation #liqInvoicesTable td,
    #page-liquidation #liqReceiptsTable th,
    #page-liquidation #liqReceiptsTable td {
      font-size: 0.78rem;
      padding: 5px 7px;
    }

    /* Motor Fiscal: est√°ndar de alineaci√≥n y tablas (solo este m√≥dulo) */
    #page-fiscal table {
      width: 100%;
      table-layout: fixed;
    }
    #page-fiscal th,
    #page-fiscal td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #page-fiscal th.num,
    #page-fiscal td.num,
    #page-fiscal .num {
      text-align: right;
    }
    #page-fiscal th.center,
    #page-fiscal td.center,
    #page-fiscal .center {
      text-align: center;
    }
    #page-fiscal .fiscal-num-right {
      display: inline-block;
      min-width: 72px;
      text-align: right;
    }
    /* Motor Fiscal: ocultar visualmente campo redundante sin tocar l√≥gica interna */
    #page-fiscal #taxConsultorNameLabel {
      display: none;
    }
    #page-fiscal #taxProjectLabel {
      grid-column: 1 / span 2;
    }
    #page-fiscal #taxConsultorSelectLabel {
      grid-column: 3;
    }
    #page-fiscal #taxOutput table td:first-child,
    #page-fiscal #taxOutput table th:first-child {
      text-align: left;
    }

    /* Hist√≥rico de tasas: est√°ndar tipo Liquidaci√≥n (scope exclusivo) */
    #page-rates .actions-bar {
      justify-content: flex-end;
    }
    #page-rates #fxHistoryTable {
      width: 100%;
      table-layout: fixed;
    }
    #page-rates #fxHistoryTable th,
    #page-rates #fxHistoryTable td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Fecha compacta y centrada */
    #page-rates #fxHistoryTable th:nth-child(1),
    #page-rates #fxHistoryTable td:nth-child(1) {
      width: 220px;
      text-align: center;
    }
    /* Columnas num√©ricas a la derecha */
    #page-rates #fxHistoryTable th:nth-child(2),
    #page-rates #fxHistoryTable td:nth-child(2),
    #page-rates #fxHistoryTable th:nth-child(3),
    #page-rates #fxHistoryTable td:nth-child(3),
    #page-rates #fxHistoryTable th:nth-child(4),
    #page-rates #fxHistoryTable td:nth-child(4) {
      text-align: right;
      white-space: nowrap;
      width: 140px;
    }
    /* Fuente: texto, aprovecha resto y con ellipsis */
    #page-rates #fxHistoryTable th:nth-child(5),
    #page-rates #fxHistoryTable td:nth-child(5) {
      text-align: center;
      vertical-align: middle;
      width: 88px;
      min-width: 88px;
      max-width: 88px;
    }

    #page-liquidation .table-scroll {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }

    #page-liquidation #liqReceiptsTable.liq-dense-table {
      width: 100%;
      min-width: 1480px;
      table-layout: fixed;
    }

    #page-liquidation #liqReceiptsTable th:last-child,
    #page-liquidation #liqReceiptsTable td:last-child {
      text-align: center;
    }

    /* Estandarizaci√≥n SOLO Liquidaci√≥n: fecha/tasa/acciones centradas, montos a la derecha */
    #page-liquidation #liqExpensesTable,
    #page-liquidation #liqInvoicesTable,
    #page-liquidation #liqReceiptsTable {
      width: 100%;
      table-layout: fixed;
    }

    /* Gastos adicionales */
    #page-liquidation #liqExpensesTable th:nth-child(1),
    #page-liquidation #liqExpensesTable td:nth-child(1) { width: 120px; text-align: center; }
    #page-liquidation #liqExpensesTable th:nth-child(3),
    #page-liquidation #liqExpensesTable td:nth-child(3) { width: 140px; text-align: right; }
    #page-liquidation #liqExpensesTable th:nth-child(4),
    #page-liquidation #liqExpensesTable td:nth-child(4) { width: 110px; text-align: center; }
    #page-liquidation #liqExpensesTable th:nth-child(5),
    #page-liquidation #liqExpensesTable td:nth-child(5) { width: 92px; text-align: center; }
    #page-liquidation #liqExpensesTable th:nth-child(2),
    #page-liquidation #liqExpensesTable td:nth-child(2) {
      text-align: left;
      width: auto;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    /* Pagos recibidos */
    #page-liquidation #liqReceiptsTable th:nth-child(1),
    #page-liquidation #liqReceiptsTable td:nth-child(1) { width: 120px; text-align: center; }
    #page-liquidation #liqReceiptsTable th:nth-child(3),
    #page-liquidation #liqReceiptsTable td:nth-child(3) { width: 110px; text-align: center; }
    #page-liquidation #liqReceiptsTable th:nth-child(12),
    #page-liquidation #liqReceiptsTable td:nth-child(12) { width: 92px; text-align: center; }

    /* Facturas emitidas guardadas (scope exclusivo Liquidaci√≥n) */
    #page-liquidation #liqInvoicesTable {
      width: 100%;
      table-layout: fixed;
    }
    #page-liquidation #liqInvoicesTable th,
    #page-liquidation #liqInvoicesTable td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
    /* Fecha */
    #page-liquidation #liqInvoicesTable th:nth-child(1),
    #page-liquidation #liqInvoicesTable td:nth-child(1) { width: 112px; text-align: center; }
    /* No. Factura (6 d√≠gitos) */
    #page-liquidation #liqInvoicesTable th:nth-child(2),
    #page-liquidation #liqInvoicesTable td:nth-child(2) { width: 92px; text-align: center; }
    /* Cliente / Proyecto / Ref pago: reparten espacio + ellipsis */
    #page-liquidation #liqInvoicesTable th:nth-child(3),
    #page-liquidation #liqInvoicesTable td:nth-child(3),
    #page-liquidation #liqInvoicesTable th:nth-child(4),
    #page-liquidation #liqInvoicesTable td:nth-child(4),
    #page-liquidation #liqInvoicesTable th:nth-child(5),
    #page-liquidation #liqInvoicesTable td:nth-child(5) {
      text-align: left;
    }
    /* Base / IVA / Total */
    #page-liquidation #liqInvoicesTable th:nth-child(6),
    #page-liquidation #liqInvoicesTable td:nth-child(6),
    #page-liquidation #liqInvoicesTable th:nth-child(7),
    #page-liquidation #liqInvoicesTable td:nth-child(7),
    #page-liquidation #liqInvoicesTable th:nth-child(8),
    #page-liquidation #liqInvoicesTable td:nth-child(8) {
      width: 108px;
      text-align: right;
      white-space: nowrap;
    }
    /* Acciones */
    #page-liquidation #liqInvoicesTable th:nth-child(9),
    #page-liquidation #liqInvoicesTable td:nth-child(9) { width: 92px; text-align: center; }

    /* Montos alineados a la derecha en Liquidaci√≥n */
    #page-liquidation #liqInvoicesTable th:nth-child(6),
    #page-liquidation #liqInvoicesTable td:nth-child(6),
    #page-liquidation #liqInvoicesTable th:nth-child(7),
    #page-liquidation #liqInvoicesTable td:nth-child(7),
    #page-liquidation #liqInvoicesTable th:nth-child(8),
    #page-liquidation #liqInvoicesTable td:nth-child(8),
    #page-liquidation #liqTeamTable th:nth-child(4),
    #page-liquidation #liqTeamTable td:nth-child(4),
    #page-liquidation #liqTeamTable th:nth-child(3),
    #page-liquidation #liqTeamTable td:nth-child(3) {
      text-align: right;
    }

    #page-liquidation #liqReceiptsTable th:nth-child(11),
    #page-liquidation #liqReceiptsTable td:nth-child(11) {
      width: 86px;
      min-width: 86px;
      max-width: 86px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: right;
    }

    @media (max-width: 980px) {
      #page-liquidation #liqReceiptsTable th:nth-child(6),
      #page-liquidation #liqReceiptsTable td:nth-child(6),
      #page-liquidation #liqReceiptsTable th:nth-child(9),
      #page-liquidation #liqReceiptsTable td:nth-child(9) {
        display: none;
      }
    }

    /* Alineaci√≥n num√©rica consistente (Bs/USD/%) */
    #page-liquidation .num,
    #page-liquidation .money,
    #page-liquidation .pct,
    #page-liquidation input.money,
    #page-liquidation input.pct,
    #page-liquidation td.num,
    #page-liquidation th.num {
      text-align: right !important;
    }

    #page-liquidation .mini-icon-btn {
      min-width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 8px;
      margin-right: 4px;
      font-size: 13px;
      line-height: 1;
      background: #f5f5f7;
      color: #1d1d1f;
      border: 1px solid rgba(60,60,67,.18);
    }

    #page-liquidation .mini-icon-btn:hover {
      background: #ebebef;
    }

    #page-liquidation .print-only { display: none; }
    body.liq-printing #page-liquidation .print-only { display: block !important; }
    body.liq-printing #page-liquidation .print-hide { display: none !important; }

    @media print {
      #page-liquidation .print-only { display: block !important; }
      #page-liquidation .print-hide,
      #page-liquidation .no-print,
      #page-liquidation button,
      #page-liquidation .mini-icon-btn,
      #page-liquidation .table-scroll {
        display: none !important;
      }

      #page-liquidation .section-card,
      #page-liquidation .results {
        box-shadow: none !important;
        break-inside: avoid;
        page-break-inside: avoid;
      }

      #page-liquidation table {
        table-layout: fixed;
        width: 100%;
      }
      #page-liquidation th,
      #page-liquidation td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }

    /* Jerarqu√≠a visual SOLO para los 3 bloques de resumen de Liquidaci√≥n */
    #page-liquidation .liq-summary-wrap .liq-summary-title {
      margin-top: 0;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0;
    }

    #page-liquidation .liq-summary-wrap .label,
    #page-liquidation .liq-summary-wrap .value {
      font-weight: 400;
    }

    #page-liquidation .liq-summary-wrap .saldo-row .label,
    #page-liquidation .liq-summary-wrap .saldo-row .value {
      font-weight: 700;
    }

    #page-db .db-form button {
      width: fit-content;
      min-width: 190px;
      margin-top: 4px;
      align-self: flex-start;
    }

    #page-db .section-card {
      padding: 16px;
      box-sizing: border-box;
    }

    /* Print styles */
    @media print {
      .nav, .no-print { display: none; }
      .hide-print { display: none; }
      .header .brand-meta,
      .header .company-name,
      .header .subtitle { display: none !important; }
      .header .print-system-name {
        display: block !important;
        font-size: 16px;
        font-weight: 700;
        margin-top: 6px;
      }
    }
    @media (max-width: 900px) {
      .consult-grid { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: repeat(2, minmax(150px, 1fr)); }
      .db-grid { grid-template-columns: 1fr; }
      .history-filters { grid-template-columns: 1fr; }
      .history-filters .filter-client select,
      .history-filters .filter-date input[type="date"] { min-width: 0; max-width: none; }
      .history-filter-buttons { flex-direction: row; justify-content: flex-end; }
      .history-filter-buttons button { width: auto; }
      #page-history .kpi-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="devAuthOverlay" class="dev-auth-overlay">
    <div class="dev-auth-card">
      <h3>Iniciar sesi√≥n</h3>
      <p>Modo desarrollo activo. Puedes continuar sin credenciales para seguir probando el flujo.</p>
      <div class="dev-auth-grid">
        <label>Correo
          <input id="devLoginEmail" type="email" placeholder="usuario@empresa.com" autocomplete="email" />
        </label>
        <label>Contrase√±a
          <input id="devLoginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </label>
      </div>
      <div class="dev-auth-actions">
        <button type="button" onclick="devContinueAuth(false)">Iniciar sesi√≥n</button>
        <button type="button" onclick="devContinueAuth(true)">Continuar (simulado)</button>
      </div>
    </div>
  </div>

  <div class="dev-banner">MODO DESARROLLO ¬∑ DEV v2.0 ¬∑ NO USAR COMO PRODUCCI√ìN</div>
  <div id="devAuthChip" class="dev-auth-chip hidden">Autenticaci√≥n de prueba activa: sesi√≥n simulada</div>
  <div class="header apple-header">
    <div class="apple-header-inner">
      <img src="Logo_Hardsoft.png" alt="Logo Hardsoft" class="brand-logo" />
      <div class="company-name">GESTION FINANCIERA DE PROYECTOS</div>
      <div class="print-system-name">Gesti√≥n de Proyectos</div>
    </div>
  </div>
  <!-- Navigation bar -->
  <div class="nav no-print">
    <button id="nav-consult" class="active" onclick="showPage('consult')">Formulario de consultor√≠a</button>
    <button id="nav-db" onclick="showPage('db')">Base de Datos</button>
    <button id="nav-history" onclick="showPage('history')">Historial de planillas</button>
    <button id="nav-rates" onclick="showPage('rates')">Hist√≥rico de tasas</button>
    <button id="nav-fiscal" onclick="showPage('fiscal')">Motor Fiscal</button>
    <button id="nav-liquidation" onclick="showPage('liquidation')">Liquidaci√≥n</button>
  </div>

  <script>
    // DEV v2.0: autenticaci√≥n simulada para pruebas (sin pedir credenciales)
    window.APP_AUTH = {
      enabled: true,
      simulated: true,
      isAuthenticated: false,
      user: {
        email: 'socio.demo@hardsoft.local',
        name: 'Usuario Demo',
        role: 'admin'
      }
    };
    window.requireAuth = function() { return !!window.APP_AUTH.isAuthenticated; };
    window.applyRoleUI = window.applyRoleUI || function() {};
    const __origin = window.location?.origin || '';
    const __isFile = window.location?.protocol === 'file:';
    window.API_BASE_URL = __isFile ? 'http://127.0.0.1:4000/api/v1' : `${__origin}/api/v1`;
    window.API_BASE_FALLBACK = __isFile ? 'http://localhost:4000/api/v1' : `${__origin}/api/v1`;
    window.apiLogin = async function(email, password) {
      const bases = [window.API_BASE_URL, window.API_BASE_FALLBACK].filter(Boolean);
      let lastErr = null;
      for (const base of bases) {
        try {
          const res = await fetch(`${base}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          if (!res.ok) {
            const tx = await res.text();
            throw new Error(`Login inv√°lido (${res.status}): ${tx}`);
          }
          window.API_BASE_URL = base;
          return res.json();
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('No se pudo conectar con API');
    };
    window.apiMe = async function(token) {
      const res = await fetch(`${window.API_BASE_URL}/me`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error('Token inv√°lido');
      return res.json();
    };
    window.devContinueAuth = async function(simulated = true) {
      const email = (document.getElementById('devLoginEmail')?.value || '').trim();
      const password = (document.getElementById('devLoginPassword')?.value || '').trim();

      if (!simulated && (!email || !password)) {
        alert('Completa correo y contrase√±a para login real.');
        return;
      }

      try {
        if (!simulated) {
          const data = await window.apiLogin(email, password);
          localStorage.setItem('gf_access_token', data.access_token || '');
          localStorage.setItem('gf_refresh_token', data.refresh_token || '');
          window.APP_AUTH.user = data.user || window.APP_AUTH.user;
          window.APP_AUTH.simulated = false;
        } else {
          if (email) window.APP_AUTH.user.email = email;
          window.APP_AUTH.simulated = true;
        }

        window.APP_AUTH.isAuthenticated = true;
        document.getElementById('devAuthOverlay')?.classList.add('hidden');
        const chip = document.getElementById('devAuthChip');
        if (chip) {
          chip.classList.remove('hidden');
          chip.innerHTML = window.APP_AUTH.simulated
            ? 'Autenticaci√≥n de prueba activa: sesi√≥n simulada ¬∑ <a href="#" onclick="devLogoutAuth();return false;">Cerrar sesi√≥n</a>'
            : `Sesi√≥n autenticada API: ${window.APP_AUTH.user?.email || 'usuario'} ¬∑ <a href="#" onclick="devLogoutAuth();return false;">Cerrar sesi√≥n</a>`;
        }
        if (typeof window.applyRoleUI === 'function') window.applyRoleUI();
      } catch (e) {
        alert(`Login API fall√≥: ${e?.message || e}`);
      }
    };

    // Fallback de navegaci√≥n: mantiene operativas las pesta√±as aunque falle otro script
    window.showPage = window.showPage || function(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById('page-' + page);
      if (target) target.classList.add('active');
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      const nav = document.getElementById('nav-' + page);
      if (nav) nav.classList.add('active');
    };
  

    // DEV v2.0: Historial de planillas (API + respaldo local)
    async function historyFetchPlanillas() {
      const token = localStorage.getItem('gf_access_token');
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      const localPlans = (getDB('planillas') || []).map(p => ({
        correlativo: p.correlativo,
        fecha: p.fecha,
        cliente: p.cliente,
        proyecto: p.proyecto,
        monto_bruto_usd: Number(parseMoney(p?.totales?.precioFinal) || 0),
        _source: 'local'
      }));

      if (token && window.APP_AUTH && !window.APP_AUTH.simulated) {
        try {
          const q = new URLSearchParams();
          if (client) q.set('cliente', client);
          if (from) q.set('from', from);
          if (to) q.set('to', to);
          q.set('limit', '500');
          const res = await fetch(`${window.API_BASE_URL}/planillas?${q.toString()}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('API planillas error');
          const data = await res.json();
          const apiPlans = (data.items || []).map(x => ({
            correlativo: x.correlativo,
            fecha: x.fecha,
            cliente: x.cliente,
            proyecto: x.proyecto,
            monto_bruto_usd: Number(x.monto_bruto_usd || 0),
            _source: 'api'
          }));

          // Si la API devuelve datos, usar SOLO API para evitar duplicados local+nube.
          if (apiPlans.length) return apiPlans;

          // Si API est√° vac√≠a temporalmente, mostrar local como respaldo.
          if (localPlans.length) return localPlans;
          return [];
        } catch (e) {
          console.warn('API historial fallback local:', e?.message || e);
        }
      }

      return localPlans;
    }

    async function loadPlanillas() {
      const tableBody = document.querySelector('#historyTable tbody');
      const rankingBody = document.querySelector('#historyClientRankingTable tbody');
      if (!tableBody || !rankingBody) return;

      let plans = await historyFetchPlanillas();

      // filtros cliente/fecha en frontend (para API y fallback)
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      if (client) plans = plans.filter(p => (p.cliente || '') === client);
      if (from) {
        const fd = new Date(from + 'T00:00:00');
        plans = plans.filter(p => new Date(p.fecha) >= fd);
      }
      if (to) {
        const td = new Date(to + 'T23:59:59');
        plans = plans.filter(p => new Date(p.fecha) <= td);
      }

      // refrescar opciones de cliente
      const clientSel = document.getElementById('historyClientFilter');
      if (clientSel && !clientSel.dataset.locked) {
        const prev = clientSel.value;
        const unique = [...new Set((plans.map(p => (p.cliente || '').trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b));
        clientSel.innerHTML = '<option value="">Todos</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        if (prev && unique.includes(prev)) clientSel.value = prev;
      }

      tableBody.innerHTML = '';
      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = `${formatCurrency(Number(p.monto_bruto_usd || 0))} USD`;
        tr.innerHTML = `<td>${p.correlativo || ''}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });
      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      // KPIs
      const total = plans.length;
      const amount = plans.reduce((s,p)=>s+Number(p.monto_bruto_usd||0),0);
      const avg = total ? (amount/total) : 0;
      const byClient = {};
      plans.forEach(p => {
        const c = (p.cliente||'').trim() || 'Sin cliente';
        byClient[c] = byClient[c] || { client:c, quotes:0, amount:0 };
        byClient[c].quotes += 1;
        byClient[c].amount += Number(p.monto_bruto_usd||0);
      });
      const ranking = Object.values(byClient).sort((a,b)=>b.amount-a.amount);
      const top = ranking[0];

      const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
      setTxt('repTotalQuotes', String(total));
      setTxt('repTotalAmount', `${formatCurrency(amount)} USD`);
      setTxt('repAvgTicket', `${formatCurrency(avg)} USD`);
      const topTxt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
      const topEl = document.getElementById('repTopClient');
      if (topEl) { topEl.textContent = topTxt; topEl.title = topTxt; }

      rankingBody.innerHTML = '';
      ranking.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td title="${fiscalEscape(r.client)}">${r.client}</td><td>${r.quotes}</td><td>${formatCurrency(r.amount)} USD</td>`;
        rankingBody.appendChild(tr);
      });
      if (ranking.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para el ranking.</td>';
        rankingBody.appendChild(tr);
      }
    }

</script>
  <!-- Consult page -->
  <div id="page-consult" class="page active">
    <!-- Section heading for data entry -->
    <h2 class="no-print">Formulario de datos de consultor√≠a</h2>
    <!-- Client selection and project name -->
    <div class="db-form no-print" style="margin-top:0;">
      <div class="consult-grid">
        <label>Cliente
          <select id="clientSelect">
            <option value="">--Seleccione cliente (Requerido)--</option>
          </select>
        </label>
        <label>Nombre del Proyecto de Consultor√≠a
          <input type="text" id="projectName" placeholder="Requerido ¬∑ Ej: Implementaci√≥n de ERP" />
        </label>
      </div>
    </div>
    <!-- Buttons -->
    <div class="actions-bar no-print">
      <button onclick="preparePrint()">üñ®Ô∏è Imprimir planilla completa</button>
      <button onclick="savePlanilla()">üíæ Guardar planilla</button>
      <button onclick="resetConsultForm()">üßπ Limpiar formulario</button>
      <span class="helper-text" id="resourceCountHint">0 recursos cargados</span>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card"><span class="kpi-label">Costo consultores</span><span class="kpi-value" id="consultantCost">0.00 USD</span></div>
      <div class="kpi-card"><span class="kpi-label">Costo gerencia de proyecto</span><span class="kpi-value" id="pmTotalCost">0.00 USD</span></div>
      <div class="kpi-card"><span class="kpi-label">Costo base</span><span class="kpi-value" id="baseCost">0.00 USD</span></div>
      <div class="kpi-card final-highlight"><span class="kpi-label">Precio bruto final</span><span class="kpi-value" id="finalPrice">0.00 USD</span></div>
    </div>
    <!-- Consultants table -->
    <h3>Consultores</h3>
    <table id="consultantsTable">
      <thead>
        <tr>
          <th>Consultor</th>
          <th>Especialidad</th>
          <th>Tarifa por hora ($)</th>
          <th>Horas estimadas</th>
          <th>Costo total</th>
        </tr>
      </thead>
      <tbody>
        <script>
          // Create 10 rows for consultants
          for (let i = 0; i < 10; i++) {
            document.write('<tr>' +
              '<td><select class="c-select"><option value="">--Seleccione--</option></select></td>' +
              '<td><input type="text" class="c-spec" /></td>' +
              '<td><input type="number" class="c-rate" step="0.01" min="0" /></td>' +
              '<td><input type="number" class="c-hours" step="0.1" min="0" /></td>' +
              '<td class="c-cost">0.00 USD</td>' +
            '</tr>');
          }
        

    // DEV v2.0: Historial de planillas (API + respaldo local)
    async function historyFetchPlanillas() {
      const token = localStorage.getItem('gf_access_token');
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      const localPlans = (getDB('planillas') || []).map(p => ({
        correlativo: p.correlativo,
        fecha: p.fecha,
        cliente: p.cliente,
        proyecto: p.proyecto,
        monto_bruto_usd: Number(parseMoney(p?.totales?.precioFinal) || 0),
        _source: 'local'
      }));

      if (token && window.APP_AUTH && !window.APP_AUTH.simulated) {
        try {
          const q = new URLSearchParams();
          if (client) q.set('cliente', client);
          if (from) q.set('from', from);
          if (to) q.set('to', to);
          q.set('limit', '500');
          const res = await fetch(`${window.API_BASE_URL}/planillas?${q.toString()}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('API planillas error');
          const data = await res.json();
          const apiPlans = (data.items || []).map(x => ({
            correlativo: x.correlativo,
            fecha: x.fecha,
            cliente: x.cliente,
            proyecto: x.proyecto,
            monto_bruto_usd: Number(x.monto_bruto_usd || 0),
            _source: 'api'
          }));

          // Si API est√° vac√≠a temporalmente, no borrar de golpe lo local en pantalla.
          if (!apiPlans.length && localPlans.length) return localPlans;

          // Merge defensivo: API manda; local rellena faltantes.
          const toNorm = (v) => String(v || '').trim().toLowerCase();
          const amount2 = (n) => Number(Number(n || 0).toFixed(2));
          const byKey = new Map();
          [...apiPlans, ...localPlans].forEach(p => {
            const k = `${toNorm(p.cliente)}|${toNorm(p.proyecto)}|${amount2(p.monto_bruto_usd)}`;
            if (!byKey.has(k) || p._source === 'api') byKey.set(k, p);
          });
          return Array.from(byKey.values());
        } catch (e) {
          console.warn('API historial fallback local:', e?.message || e);
        }
      }

      return localPlans;
    }

    async function loadPlanillas() {
      const tableBody = document.querySelector('#historyTable tbody');
      const rankingBody = document.querySelector('#historyClientRankingTable tbody');
      if (!tableBody || !rankingBody) return;

      let plans = await historyFetchPlanillas();

      // filtros cliente/fecha en frontend (para API y fallback)
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      if (client) plans = plans.filter(p => (p.cliente || '') === client);
      if (from) {
        const fd = new Date(from + 'T00:00:00');
        plans = plans.filter(p => new Date(p.fecha) >= fd);
      }
      if (to) {
        const td = new Date(to + 'T23:59:59');
        plans = plans.filter(p => new Date(p.fecha) <= td);
      }

      // refrescar opciones de cliente
      const clientSel = document.getElementById('historyClientFilter');
      if (clientSel && !clientSel.dataset.locked) {
        const prev = clientSel.value;
        const unique = [...new Set((plans.map(p => (p.cliente || '').trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b));
        clientSel.innerHTML = '<option value="">Todos</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        if (prev && unique.includes(prev)) clientSel.value = prev;
      }

      tableBody.innerHTML = '';
      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = `${formatCurrency(Number(p.monto_bruto_usd || 0))} USD`;
        tr.innerHTML = `<td>${p.correlativo || ''}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });
      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      // KPIs
      const total = plans.length;
      const amount = plans.reduce((s,p)=>s+Number(p.monto_bruto_usd||0),0);
      const avg = total ? (amount/total) : 0;
      const byClient = {};
      plans.forEach(p => {
        const c = (p.cliente||'').trim() || 'Sin cliente';
        byClient[c] = byClient[c] || { client:c, quotes:0, amount:0 };
        byClient[c].quotes += 1;
        byClient[c].amount += Number(p.monto_bruto_usd||0);
      });
      const ranking = Object.values(byClient).sort((a,b)=>b.amount-a.amount);
      const top = ranking[0];

      const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
      setTxt('repTotalQuotes', String(total));
      setTxt('repTotalAmount', `${formatCurrency(amount)} USD`);
      setTxt('repAvgTicket', `${formatCurrency(avg)} USD`);
      const topTxt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
      const topEl = document.getElementById('repTopClient');
      if (topEl) { topEl.textContent = topTxt; topEl.title = topTxt; }

      rankingBody.innerHTML = '';
      ranking.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td title="${fiscalEscape(r.client)}">${r.client}</td><td>${r.quotes}</td><td>${formatCurrency(r.amount)} USD</td>`;
        rankingBody.appendChild(tr);
      });
      if (ranking.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para el ranking.</td>';
        rankingBody.appendChild(tr);
      }
    }

</script>
      </tbody>
    </table>
    <div class="helper-text">Cargue solo las filas necesarias. Las filas vac√≠as no se imprimen.</div>
    <!-- Project managers table -->
    <h3>Gerentes de Proyecto</h3>
    <table id="pmTable">
      <thead>
        <tr>
          <th>Gerente</th>
          <th>Tarifa por hora ($)</th>
          <th>Horas estimadas</th>
          <th>Costo total</th>
        </tr>
      </thead>
      <tbody>
        <script>
          for (let i = 0; i < 5; i++) {
            document.write('<tr>' +
              '<td><select class="pm-select"><option value="">--Seleccione--</option></select></td>' +
              '<td><input type="number" class="pm-rate" step="0.01" min="0" /></td>' +
              '<td><input type="number" class="pm-hours" step="0.1" min="0" /></td>' +
              '<td class="pm-cost">0.00 USD</td>' +
            '</tr>');
          }
        

    // DEV v2.0: Historial de planillas (API + respaldo local)
    async function historyFetchPlanillas() {
      const token = localStorage.getItem('gf_access_token');
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      const localPlans = (getDB('planillas') || []).map(p => ({
        correlativo: p.correlativo,
        fecha: p.fecha,
        cliente: p.cliente,
        proyecto: p.proyecto,
        monto_bruto_usd: Number(parseMoney(p?.totales?.precioFinal) || 0),
        _source: 'local'
      }));

      if (token && window.APP_AUTH && !window.APP_AUTH.simulated) {
        try {
          const q = new URLSearchParams();
          if (client) q.set('cliente', client);
          if (from) q.set('from', from);
          if (to) q.set('to', to);
          q.set('limit', '500');
          const res = await fetch(`${window.API_BASE_URL}/planillas?${q.toString()}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('API planillas error');
          const data = await res.json();
          const apiPlans = (data.items || []).map(x => ({
            correlativo: x.correlativo,
            fecha: x.fecha,
            cliente: x.cliente,
            proyecto: x.proyecto,
            monto_bruto_usd: Number(x.monto_bruto_usd || 0),
            _source: 'api'
          }));

          // Si API est√° vac√≠a temporalmente, no borrar de golpe lo local en pantalla.
          if (!apiPlans.length && localPlans.length) return localPlans;

          // Merge defensivo: API manda; local rellena faltantes.
          const toNorm = (v) => String(v || '').trim().toLowerCase();
          const amount2 = (n) => Number(Number(n || 0).toFixed(2));
          const byKey = new Map();
          [...apiPlans, ...localPlans].forEach(p => {
            const k = `${toNorm(p.cliente)}|${toNorm(p.proyecto)}|${amount2(p.monto_bruto_usd)}`;
            if (!byKey.has(k) || p._source === 'api') byKey.set(k, p);
          });
          return Array.from(byKey.values());
        } catch (e) {
          console.warn('API historial fallback local:', e?.message || e);
        }
      }

      return localPlans;
    }

    async function loadPlanillas() {
      const tableBody = document.querySelector('#historyTable tbody');
      const rankingBody = document.querySelector('#historyClientRankingTable tbody');
      if (!tableBody || !rankingBody) return;

      let plans = await historyFetchPlanillas();

      // filtros cliente/fecha en frontend (para API y fallback)
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      if (client) plans = plans.filter(p => (p.cliente || '') === client);
      if (from) {
        const fd = new Date(from + 'T00:00:00');
        plans = plans.filter(p => new Date(p.fecha) >= fd);
      }
      if (to) {
        const td = new Date(to + 'T23:59:59');
        plans = plans.filter(p => new Date(p.fecha) <= td);
      }

      // refrescar opciones de cliente
      const clientSel = document.getElementById('historyClientFilter');
      if (clientSel && !clientSel.dataset.locked) {
        const prev = clientSel.value;
        const unique = [...new Set((plans.map(p => (p.cliente || '').trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b));
        clientSel.innerHTML = '<option value="">Todos</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        if (prev && unique.includes(prev)) clientSel.value = prev;
      }

      tableBody.innerHTML = '';
      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = `${formatCurrency(Number(p.monto_bruto_usd || 0))} USD`;
        tr.innerHTML = `<td>${p.correlativo || ''}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });
      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      // KPIs
      const total = plans.length;
      const amount = plans.reduce((s,p)=>s+Number(p.monto_bruto_usd||0),0);
      const avg = total ? (amount/total) : 0;
      const byClient = {};
      plans.forEach(p => {
        const c = (p.cliente||'').trim() || 'Sin cliente';
        byClient[c] = byClient[c] || { client:c, quotes:0, amount:0 };
        byClient[c].quotes += 1;
        byClient[c].amount += Number(p.monto_bruto_usd||0);
      });
      const ranking = Object.values(byClient).sort((a,b)=>b.amount-a.amount);
      const top = ranking[0];

      const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
      setTxt('repTotalQuotes', String(total));
      setTxt('repTotalAmount', `${formatCurrency(amount)} USD`);
      setTxt('repAvgTicket', `${formatCurrency(avg)} USD`);
      const topTxt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
      const topEl = document.getElementById('repTopClient');
      if (topEl) { topEl.textContent = topTxt; topEl.title = topTxt; }

      rankingBody.innerHTML = '';
      ranking.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td title="${fiscalEscape(r.client)}">${r.client}</td><td>${r.quotes}</td><td>${formatCurrency(r.amount)} USD</td>`;
        rankingBody.appendChild(tr);
      });
      if (ranking.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para el ranking.</td>';
        rankingBody.appendChild(tr);
      }
    }

</script>
      </tbody>
    </table>
    <!-- Modelo Venezuela: brecha cambiaria + indirectos -->
    <h3>Par√°metros del Modelo de Negocio (Venezuela)</h3>
    <table>
      <tbody>
        <tr>
          <td>Tasa oficial BCV (Bs/USD)</td>
          <td><input type="number" id="bcvRate" step="0.0001" min="0" placeholder="Ej: 39.15"></td>
        </tr>
        <tr>
          <td>Tasa paralela/no oficial (Bs/USD)</td>
          <td><input type="number" id="parallelRate" step="0.0001" min="0" placeholder="Ej: 47.80"></td>
        </tr>
        <tr>
          <td>% de costos indirectos sobre ingresos antes de impuestos</td>
          <td>
            <div class="percent-input">
              <input type="number" id="indirectPct" step="0.01" min="0" max="1" value="0.30" placeholder="0.30 para 30%">
              <span>%</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="actions-bar no-print" style="margin-top:10px; margin-bottom: 8px;">
      <button type="button" onclick="fetchDollarRates()">‚Üª Cargar tasas desde DolarAPI</button>
      <button type="button" onclick="saveRateSnapshot('manual')">üíæ Guardar tasa actual</button>
      <span class="helper-text" id="fxApiStatus">Sincronizaci√≥n de tasas pendiente.</span>
    </div>
    <div class="helper-text">El sistema calcula autom√°ticamente la p√©rdida cambiaria con base en BCV vs paralela y la incorpora al precio final.</div>
    <!-- Results summary -->
    <div class="results section-card" style="width: var(--content-w); max-width: none; margin-left: auto; margin-right: auto;">
      <div><span class="label">P√©rdida cambiaria estimada (USD):</span> <span class="value" id="exchangeCost">0.00 USD</span></div>
      <div><span class="label">% p√©rdida cambiaria impl√≠cita:</span> <span class="value" id="fxLossPct">0.00%</span></div>
      <div><span class="label">Costos indirectos (sobre ingresos):</span> <span class="value" id="adminCost">0.00 USD</span></div>
      <div><span class="label">Margen de recargo total sobre costo directo:</span> <span class="value" id="totalMarkup">0.00%</span></div>
    </div>
  </div>
  <!-- Database page -->
  <div id="page-db" class="page">
    <h2>Base de Datos</h2>
    <p>Utiliza este m√≥dulo para mantener clientes, consultores y gerentes con estilo uniforme Apple.</p>

    <div id="cloudControls" class="section-card no-print" style="margin-bottom:12px;">
      <h3 style="margin-top:0;">Sincronizaci√≥n con Nube (Supabase)</h3>
      <p id="cloudStatus" style="margin: 6px 0 10px 0; font-weight: bold;">Estado nube: inicializando...</p>
      <div class="actions-bar">
        <button type="button" id="btnCloudConfig">Configurar Supabase</button>
        <button type="button" id="btnCloudSync">Sincronizar ahora</button>
      </div>
      <div class="helper-text">Tip: configura una vez URL/ANON_KEY y luego usa ‚ÄúSincronizar ahora‚Äù.</div>
    </div>

    <div class="db-grid">
      <div class="db-form section-card">
        <h3 class="db-card-title">Agregar Consultor</h3>
        <label>Nombre del Consultor
          <input type="text" id="dbConsultName" placeholder="Ingrese el nombre" />
        </label>
        <label>Especialidad
          <input type="text" id="dbConsultSpec" placeholder="Ingrese la especialidad" />
        </label>
        <label>Correo del Consultor
          <input type="email" id="dbConsultEmail" placeholder="consultor@dominio.com" />
        </label>
        <label>Tarifa por hora ($)
          <input type="number" id="dbConsultRate" step="0.01" min="0" placeholder="Ingrese la tarifa" />
        </label>
        <button onclick="addConsultantToDB()">Agregar Consultor</button>
      </div>

      <div class="db-form section-card">
        <h3 class="db-card-title">Agregar Gerente de Proyecto</h3>
        <label>Nombre del Gerente
          <input type="text" id="dbPMName" placeholder="Ingrese el nombre" />
        </label>
        <label>Correo del Gerente
          <input type="email" id="dbPMEmail" placeholder="gerente@dominio.com" />
        </label>
        <label>Tarifa por hora ($)
          <input type="number" id="dbPMRate" step="0.01" min="0" placeholder="Ingrese la tarifa" />
        </label>
        <button onclick="addManagerToDB()">Agregar Gerente</button>
      </div>

      <div class="db-form section-card">
        <h3 class="db-card-title">Agregar Cliente</h3>
        <label>Nombre del Cliente
          <input type="text" id="dbClientName" placeholder="Ingrese el nombre del cliente" />
        </label>
        <label>RIF (√∫nico)
          <input type="text" id="dbClientRif" placeholder="J-12345678-9" />
        </label>
        <button onclick="addClientToDB()">Agregar Cliente</button>
      </div>
    </div>

    <div class="section-card">
      <h3 style="margin-top:0;">Listar datos almacenados</h3>
      <div class="actions-bar no-print" style="margin-bottom: 10px;">
        <button onclick="displayDBList('consultant')">Mostrar Consultores</button>
        <button onclick="displayDBList('pm')">Mostrar Gerentes</button>
        <button onclick="displayDBList('client')">Mostrar Clientes</button>
      </div>
      <div id="dbListOutput"></div>
    </div>
  </div>
  <!-- History page -->
  <div id="page-history" class="page historial-planillas-page">
    <div class="page-container">
      <p class="history-intro">Reportes hist√≥ricos de cotizaciones por cliente, monto y per√≠odo. Sincroniza con nube si est√° activa.</p>
      <div class="actions-bar no-print history-filters">
        <label class="filter-client">Cliente
          <select id="historyClientFilter" onchange="loadPlanillas()">
            <option value="">Todos</option>
          </select>
        </label>
        <label class="filter-date">Desde
          <input type="date" id="historyFrom" onchange="loadPlanillas()" />
        </label>
        <label class="filter-date">Hasta
          <input type="date" id="historyTo" onchange="loadPlanillas()" />
        </label>
        <div class="history-filter-buttons">
          <button type="button" onclick="resetHistoryFilters()">Limpiar filtros</button>
          <button type="button" onclick="exportHistoryCSV()">Exportar CSV</button>
          <button type="button" onclick="migrateLocalPlanillasToApi()">Migrar local ‚Üí nube</button>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card"><span class="kpi-label">Total cotizaciones</span><span class="kpi-value" id="repTotalQuotes">0</span></div>
        <div class="kpi-card"><span class="kpi-label">Monto acumulado</span><span class="kpi-value" id="repTotalAmount">0.00 USD</span></div>
        <div class="kpi-card"><span class="kpi-label">Ticket promedio</span><span class="kpi-value" id="repAvgTicket">0.00 USD</span></div>
        <div class="kpi-card final-highlight"><span class="kpi-label">Cliente top</span><span class="kpi-value" id="repTopClient">-</span></div>
      </div>

      <div class="section-card history-ranking-card">
        <h3 style="margin-top:0;">Ranking de clientes</h3>
        <table id="historyClientRankingTable">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Cotizaciones</th>
              <th>Monto acumulado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <table id="historyTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Proyecto</th>
            <th>Monto bruto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

  <div id="page-rates" class="page historico-tasas-page">
    <h2>Hist√≥rico de tasas</h2>
    <p>Consulta y guarda las tasas BCV y Paralela para trazabilidad de tus ofertas.</p>
    <div class="actions-bar no-print" style="margin-top:10px; margin-bottom: 8px;">
      <button type="button" onclick="clearRateHistory()">üóëÔ∏è Limpiar hist√≥rico</button>
    </div>
    <div class="section-card no-print" style="margin-top:10px;">
      <table id="fxHistoryTable">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>BCV (Bs/USD)</th>
            <th>Paralela (Bs/USD)</th>
            <th>Brecha</th>
            <th>Fuente</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="helper-text rate-note">Se guarda en tu navegador y se sincroniza con nube si est√° activa.</div>
    </div>
  </div>

  <div id="page-fiscal" class="page">
    <h2>Motor Contable-Fiscal (Venezuela)</h2>
    <p>Operaci√≥n determin√≠stica para c√°lculo fiscal y generaci√≥n autom√°tica de correo corporativo.</p>

    <div class="db-form section-card" style="margin-top:10px;">
      <div class="consult-grid">
        <label id="taxProjectLabel">Proyecto (desde planillas)
          <select id="taxProjectSelect" onchange="fiscalPopulateConsultorsByProject()">
            <option value="">--Seleccione proyecto--</option>
          </select>
        </label>
        <label id="taxConsultorSelectLabel">Consultor del proyecto
          <select id="taxConsultorSelect" onchange="fiscalApplyProjectConsultor()">
            <option value="">--Seleccione consultor--</option>
          </select>
        </label>
        <label id="taxConsultorNameLabel">Nombre del consultor
          <input type="text" id="taxConsultor" placeholder="Requerido" />
        </label>
        <label>Horas (editable)
          <input type="number" id="taxHoras" step="0.01" min="0" placeholder="Requerido" />
        </label>
        <label>Tarifa por hora (USD)
          <input type="number" id="taxTarifa" step="0.01" min="0" placeholder="Requerido" />
        </label>
        <label>Tasa BCV
          <input type="number" id="taxBcv" step="0.0001" min="0" placeholder="Requerido" />
        </label>
        <label>Fecha de pago
          <input type="date" id="taxFechaPago" />
        </label>
      </div>

      <div class="section-card" style="margin-top:10px; padding:10px 12px; line-height:1.35;">
        <div style="margin-bottom:4px;"><strong>Horas formuladas:</strong> <span id="taxHorasFormuladasView" class="fiscal-num-right">0,00</span> h</div>
        <div style="margin-bottom:4px;"><strong>Horas pagadas acumuladas:</strong> <span id="taxHorasPagadasView" class="fiscal-num-right">0,00</span> h</div>
        <div><strong>Horas restantes:</strong> <span id="taxHorasRestantesView" class="fiscal-num-right">0,00</span> h</div>
      </div>

      <div class="actions-bar no-print" style="margin-top:10px;">
        <button type="button" onclick="fiscalFetchBCV()">Traer BCV por API</button>
        <span class="helper-text" id="taxBcvStatus">Sincronizaci√≥n BCV pendiente.</span>
      </div>

      <label style="margin-top:8px; display:block;">Concepto
        <input type="text" id="taxConcepto" placeholder="Requerido" />
      </label>
      <label style="margin-top:8px; display:block;">Concepto de exceso (obligatorio si excede horas formuladas)
        <input type="text" id="taxConceptoExceso" placeholder="Solo requerido si hay exceso" />
      </label>

      <div class="actions-bar no-print" style="margin-top:12px;">
        <button type="button" onclick="fiscalGenerateEmail()">Generar correo de pago</button>
        <button type="button" onclick="fiscalSummaryByConsultor()">Resumen acumulado</button>
        <button type="button" onclick="fiscalDetailByReference()">Detalle por referencias</button>
        <button type="button" onclick="fiscalCopyOutput()">Copiar salida</button>
        <button type="button" onclick="fiscalSendOutlook()">Enviar por Outlook</button>
        <button type="button" onclick="fiscalPrintPlanilla()">üñ®Ô∏è Imprimir planilla</button>
      </div>

      <div class="actions-bar no-print" style="margin-top:8px;">
        <select id="taxRefSelect" style="min-width: 260px;"></select>
        <button type="button" onclick="fiscalLoadEmailByReference()">Recuperar correo guardado</button>
      </div>
    </div>

    <div class="section-card" style="margin-top:10px;">
      <div id="taxOutput" style="white-space: pre-wrap; line-height:1.5;"></div>
    </div>
  </div>

  <div id="page-liquidation" class="page">
    <h2>Liquidaci√≥n de Proyecto</h2>
    <p>Centro de cierre financiero por proyecto: cobros del cliente, pagos ejecutados y gastos extraordinarios.</p>

    <div id="liqHeaderBlock" class="db-form section-card" style="margin-top:10px;">
      <div class="consult-grid">
        <label>Cliente
          <select id="liqClientFilter" onchange="liqRefreshProjectOptions()">
            <option value="">--Seleccione cliente--</option>
          </select>
        </label>
        <label>Proyecto
          <select id="liqProjectSelect" onchange="liqLoadProject()">
            <option value="">--Seleccione proyecto--</option>
          </select>
        </label>
        <label>Monto de venta (USD)
          <input type="text" id="liqSaleAmount" readonly />
        </label>
      </div>
    </div>

    <div class="section-card no-print" style="margin-top:10px; padding:14px 16px;">
      <button type="button" onclick="liqPrintPlanilla()">üñ®Ô∏è Imprimir planilla</button>
    </div>

    <div class="section-card" style="margin-top:10px;">
      <h3 style="margin-top:0;">Factura emitida</h3>
      <div class="consult-grid">
        <label>Fecha de factura
          <input type="date" id="liqInvDate" autocomplete="off" />
        </label>
        <label>No. Factura
          <input type="text" id="liqInvNumber" placeholder="Ej: 00062 o A-00062" autocomplete="off" />
        </label>
        <label>Referencia de pago asociada
          <input type="text" id="liqInvPayRef" placeholder="Ej: Anticipo 50%" autocomplete="off" />
        </label>
        <label>Base imponible factura (USD)
          <input type="number" id="liqInvBaseUsd" class="money" step="0.01" min="0" onchange="liqSaveInvoiceConfig()" oninput="liqLoadProject()" autocomplete="off" />
        </label>
        <label>Tasa IVA (%)
          <input type="text" id="liqInvIvaPct" class="pct" value="16,00%" onchange="liqSaveInvoiceConfig()" oninput="liqLoadProject()" onblur="this.value=pctFormat(this.value)" autocomplete="off" />
        </label>
        <label>IVA factura (USD)
          <input type="text" id="liqInvIvaUsd" readonly />
        </label>
        <label>Monto total factura (USD)
          <input type="text" id="liqInvTotalUsd" readonly />
        </label>
      </div>
      <div class="actions-bar no-print" style="margin-top:10px;">
        <button type="button" onclick="liqSaveIssuedInvoice()">Guardar factura emitida</button>
      </div>
    </div>

    <div class="section-card print-hide" style="margin-top:10px;">
      <h3 style="margin-top:0;">Facturas emitidas guardadas</h3>
      <table id="liqInvoicesTable">
        <thead><tr><th>Fecha</th><th>No. Factura</th><th>Cliente</th><th>Proyecto</th><th>Ref. pago</th><th>Base USD</th><th>IVA USD</th><th>Total USD</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-card print-hide" style="margin-top:10px;">
      <h3 style="margin-top:0;">Pago Recibido</h3>
      <div class="consult-grid">
        <label>Fecha
          <input type="date" id="liqReceiptDate" />
        </label>
        <label>Monto recibido (Bs)
          <input type="number" id="liqReceiptAmountBs" class="money" step="0.01" min="0" oninput="liqPreviewReceiptUSD()" />
        </label>
        <label>Tasa del d√≠a (Bs/USD)
          <input type="number" id="liqReceiptRateDay" class="money" step="0.0001" min="0" oninput="liqPreviewReceiptUSD()" />
        </label>
        <label>Monto en $ (USD)
          <input type="text" id="liqReceiptAmountUsd" class="money" readonly />
        </label>
      </div>
      <div class="actions-bar no-print" style="margin-top:10px;">
        <button type="button" onclick="liqAddReceipt()">Pago Recibido</button>
      </div>
      <div class="table-scroll" aria-label="Scroll horizontal tabla pagos recibidos">
        <table id="liqReceiptsTable" class="liq-dense-table">
          <thead><tr><th>Fecha</th><th class="num">Monto Bs</th><th class="num">Tasa del d√≠a</th><th class="num">Pago neto USD</th><th class="num">Ret. IVA USD</th><th class="num">% IVA s/base</th><th class="num">Ret. IVA Bs</th><th class="num">Ret. ISLR USD</th><th class="num">% ISLR s/base</th><th class="num">Ret. ISLR Bs</th><th class="num">No. Factura</th><th class="num">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section-card print-only" style="margin-top:10px;">
      <h3 style="margin-top:0;">Facturas emitidas guardadas (resumen impresi√≥n)</h3>
      <table id="liqInvoicesPrintTable">
        <thead><tr><th>Fecha</th><th>No. Factura</th><th class="num">Base USD</th><th class="num">IVA USD</th><th class="num">Total USD</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-card print-only" style="margin-top:10px;">
      <h3 style="margin-top:0;">Pagos recibidos guardados (resumen impresi√≥n)</h3>
      <table id="liqReceiptsPrintTable">
        <thead><tr><th>Fecha</th><th class="num">Monto recibido Bs</th><th class="num">Tasa del d√≠a</th><th class="num">Pago neto USD</th><th class="num">Ret. IVA USD y % IVA s/base</th><th class="num">Ret. ISLR USD y % ISLR s/base</th><th class="num">No. Factura</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-card" style="margin-top:10px;">
      <h3 style="margin-top:0;">Gastos adicionales y extraordinarios</h3>
      <div class="consult-grid">
        <label>Fecha
          <input type="date" id="liqExpenseDate" />
        </label>
        <label>Concepto
          <input type="text" id="liqExpenseConcept" placeholder="Impuesto, legal, tr√°mite, etc." />
        </label>
        <label>Monto (USD)
          <input type="number" id="liqExpenseAmount" step="0.01" min="0" />
        </label>
        <label>Tasa del d√≠a
          <input type="number" id="liqExpenseRateDay" step="0.0001" min="0" placeholder="Editable" />
        </label>
      </div>
      <div class="actions-bar no-print" style="margin-top:10px;">
        <button type="button" onclick="liqAddExpense()">Agregar gasto</button>
      </div>
      <table id="liqExpensesTable">
        <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto USD</th><th>Tasa del d√≠a</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-card" style="margin-top:10px;">
      <h3 style="margin-top:0;">Pagos a Consutores y Gerentes ejecutado</h3>
      <table id="liqTeamTable">
        <thead><tr><th>Rol</th><th>Nombre</th><th>Horas pagadas (Motor Fiscal)</th><th>Pagado en Motor Fiscal (USD)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="results section-card" style="width: var(--content-w); max-width: none; margin-top:10px;">
      <div class="liq-summary-wrap">
        <h3 class="liq-summary-title">IMPUESTOS RETENIDOS</h3>
        <div><span class="label">Retenci√≥n de IVA Acumulada (USD):</span> <span class="value" id="liqRetIva">0,00 USD</span></div>
        <div><span class="label">Retenci√≥n de ISLR Acumulada (USD):</span> <span class="value" id="liqRetIslr">0,00 USD</span></div>
      </div>

      <hr style="border:none; border-top:1px solid rgba(60,60,67,.14); margin:12px 0;" />
      <div class="liq-summary-wrap">
        <h3 class="liq-summary-title">RESULTADO FINANCIERO</h3>
        <div><span class="label">Pagos recibidos acumulados (USD):</span> <span class="value" id="liqTotalReceipts">0,00 USD</span></div>
        <div><span class="label">Pago a Consultores acumulado (USD):</span> <span class="value" id="liqTotalFiscalConsultants">0,00 USD</span></div>
        <div><span class="label">Pago a Gerentes de Proyectos acumulado (USD):</span> <span class="value" id="liqTotalFiscalManagers">0,00 USD</span></div>
        <div><span class="label">Gasto Administrativo acumulado (USD):</span> <span class="value" id="liqTotalExpenses">0,00 USD</span></div>
        <div><span class="label">Total costos y gastos (USD):</span> <span class="value" id="liqTotalCosts">0,00 USD</span></div>
        <div class="saldo-row"><span class="label">Saldo de caja (USD):</span> <span class="value" id="liqCashLeft">0,00 USD</span></div>
      </div>

      <hr style="border:none; border-top:1px solid rgba(60,60,67,.14); margin:12px 0;" />
      <div class="liq-summary-wrap">
        <h3 class="liq-summary-title">FACTURACI√ìN DEL PROYECTO</h3>
        <div><span class="label">Monto bruto facturado acumulado al cliente (USD):</span> <span class="value" id="liqFacturadoAcum">0,00 USD</span></div>
        <div class="saldo-row"><span class="label">Monto bruto pendiente por facturar (USD):</span> <span class="value" id="liqSaldoPendiente">0,00 USD</span></div>
      </div>
    </div>

  </div>
  <script>
    /*
     * Simple local storage database for consultants, managers, clients and saved planillas.
     */
    function getDB(key) {
      const stored = localStorage.getItem(key);
      if (!stored) return [];
      try {
        const parsed = JSON.parse(stored);
        return parsed == null ? [] : parsed;
      } catch (e) {
        console.warn('Dato local corrupto en', key, '- se reinicia a vac√≠o.');
        localStorage.removeItem(key);
        return [];
      }
    }
    function setDB(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }
    function updateConsultantSelects() {
      const consultants = getDB('consultantDB');
      document.querySelectorAll('.c-select').forEach(select => {
        const prev = select.value;
        select.innerHTML = '<option value="">--Seleccione--</option>';
        consultants.forEach((c, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = c.name;
          select.appendChild(opt);
        });
        if (prev) select.value = prev;
      });
    }
    function updateManagerSelects() {
      const managers = getDB('pmDB');
      document.querySelectorAll('.pm-select').forEach(select => {
        const prev = select.value;
        select.innerHTML = '<option value="">--Seleccione--</option>';
        managers.forEach((m, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
        if (prev) select.value = prev;
      });
    }
    function updateClientSelect() {
      const clients = getDB('clientDB');
      const select = document.getElementById('clientSelect');
      const prev = select.value;
      select.innerHTML = '<option value="">--Seleccione cliente--</option>';
      clients.forEach((c, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = c.name || '';
        select.appendChild(opt);
      });
      if (prev) select.value = prev;
    }

    function normalizeEmail(v) {
      return String(v || '').trim().toLowerCase();
    }

    function normalizeRif(v) {
      return String(v || '').trim().toUpperCase().replace(/\s+/g, '');
    }

    function isValidEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(normalizeEmail(v));
    }

    // Add entries
    function addConsultantToDB() {
      const name = document.getElementById('dbConsultName').value.trim();
      const spec = document.getElementById('dbConsultSpec').value.trim();
      const email = normalizeEmail(document.getElementById('dbConsultEmail').value);
      const rate = parseFloat(document.getElementById('dbConsultRate').value);
      if (!name || isNaN(rate) || !email) {
        alert('Ingrese nombre, correo y tarifa del consultor.');
        return;
      }
      if (!isValidEmail(email)) {
        alert('Ingrese un correo v√°lido para el consultor.');
        return;
      }
      const list = getDB('consultantDB');
      if (list.some(c => normalizeEmail(c.email) === email)) {
        alert('Ya existe un consultor con ese correo.');
        return;
      }
      list.push({ name: name, spec: spec, email: email, rate: rate });
      setDB('consultantDB', list);
      document.getElementById('dbConsultName').value = '';
      document.getElementById('dbConsultSpec').value = '';
      document.getElementById('dbConsultEmail').value = '';
      document.getElementById('dbConsultRate').value = '';
      updateConsultantSelects();
      alert('Consultor agregado a la base de datos.');
    }
    function addManagerToDB() {
      const name = document.getElementById('dbPMName').value.trim();
      const email = normalizeEmail(document.getElementById('dbPMEmail').value);
      const rate = parseFloat(document.getElementById('dbPMRate').value);
      if (!name || isNaN(rate) || !email) {
        alert('Ingrese nombre, correo y tarifa del gerente.');
        return;
      }
      if (!isValidEmail(email)) {
        alert('Ingrese un correo v√°lido para el gerente.');
        return;
      }
      const list = getDB('pmDB');
      if (list.some(m => normalizeEmail(m.email) === email)) {
        alert('Ya existe un gerente con ese correo.');
        return;
      }
      list.push({ name: name, email: email, rate: rate });
      setDB('pmDB', list);
      document.getElementById('dbPMName').value = '';
      document.getElementById('dbPMEmail').value = '';
      document.getElementById('dbPMRate').value = '';
      updateManagerSelects();
      alert('Gerente agregado a la base de datos.');
    }
    function addClientToDB() {
      const name = document.getElementById('dbClientName').value.trim();
      const rif = normalizeRif(document.getElementById('dbClientRif').value);
      if (!name || !rif) {
        alert('Ingrese nombre y RIF del cliente.');
        return;
      }
      const list = getDB('clientDB');
      if (list.some(c => normalizeRif(c.rif) === rif)) {
        alert('Ya existe un cliente con ese RIF.');
        return;
      }
      if (list.some(c => (c.name || '').trim().toLowerCase() === name.toLowerCase())) {
        alert('Ya existe un cliente con ese nombre.');
        return;
      }
      list.push({ name: name, rif: rif });
      setDB('clientDB', list);
      document.getElementById('dbClientName').value = '';
      document.getElementById('dbClientRif').value = '';
      updateClientSelect();
      alert('Cliente agregado a la base de datos.');
    }
    // Selection handlers to update fields when selecting entries
    function attachConsultantSelectionHandler() {
      document.querySelectorAll('.c-select').forEach(select => {
        select.addEventListener('change', function() {
          const idx = this.value;
          const row = this.parentElement.parentElement;
          if (idx !== '') {
            const consultant = getDB('consultantDB')[idx];
            row.querySelector('.c-spec').value = consultant.spec;
            row.querySelector('.c-rate').value = consultant.rate;
          } else {
            row.querySelector('.c-spec').value = '';
            row.querySelector('.c-rate').value = '';
          }
          recalc();
        });
      });
    }
    function attachManagerSelectionHandler() {
      document.querySelectorAll('.pm-select').forEach(select => {
        select.addEventListener('change', function() {
          const idx = this.value;
          const row = this.parentElement.parentElement;
          if (idx !== '') {
            const manager = getDB('pmDB')[idx];
            row.querySelector('.pm-rate').value = manager.rate;
          } else {
            row.querySelector('.pm-rate').value = '';
          }
          recalc();
        });
      });
    }
    // Format helpers
    function formatCurrency(value) {
      return new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(parseFloat(value) || 0);
    }
    function formatPct(value) {
      return new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((parseFloat(value) || 0) * 100) + '%';
    }

    function round2(n) {
      return Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    }

    function fmtVE(n) {
      return new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(round2(n));
    }

    let fiscalPrintReportType = '';
    let historyEditingCorrelativo = null;

    function fiscalGetDB() {
      return getDB('fiscalOps') || [];
    }

    function fiscalSetDB(list) {
      setDB('fiscalOps', list || []);
    }

    function fiscalNextRef() {
      let counter = parseInt(localStorage.getItem('fiscalRefCounter') || '0', 10);
      counter += 1;
      localStorage.setItem('fiscalRefCounter', String(counter));
      return `REF-${String(counter).padStart(4, '0')}`;
    }

    function fiscalHoursStatus(projectKey, projectName, consultor, horasFormuladas) {
      const ops = fiscalGetDB();
      const keyNorm = (projectKey || '').trim().toLowerCase();
      const projectNorm = (projectName || '').trim().toLowerCase();
      const consultorNorm = (consultor || '').trim().toLowerCase();

      const paid = ops
        .filter(r => {
          const rConsultor = ((r.consultor || '').trim().toLowerCase() === consultorNorm);
          if (!rConsultor || r.isExceso) return false;

          const rProjectKey = (r.projectKey || '').trim().toLowerCase();
          const rProyecto = (r.projecto || r.proyecto || '').trim().toLowerCase();
          const rConcepto = (r.concepto || '').trim().toLowerCase();

          // Regla principal: clave √∫nica de proyecto
          if (keyNorm && rProjectKey) return rProjectKey === keyNorm;

          // Compatibilidad hist√≥rica (sin projectKey)
          const sameProject = projectNorm && rProyecto && rProyecto === projectNorm;
          const legacyMatch = projectNorm && !rProyecto && rConcepto && rConcepto === projectNorm;
          return sameProject || legacyMatch;
        })
        .reduce((s, r) => s + (parseFloat(r.horas) || 0), 0);

      const restantes = Math.max(0, round2(horasFormuladas - paid));
      return { horasPagadas: round2(paid), horasRestantes: restantes };
    }

    function fiscalUpdateHoursAuditUI() {
      const projectKey = (document.getElementById('taxProjectSelect')?.value || '').trim();
      const projectName = (document.getElementById('taxProjectSelect')?.selectedOptions?.[0]?.dataset?.projectName || '').trim();
      const consultor = (document.getElementById('taxConsultor')?.value || '').trim();
      const horasFormuladas = parseFloat(document.getElementById('taxHoras')?.dataset.formuladas || '0') || 0;
      const st = fiscalHoursStatus(projectKey, projectName, consultor, horasFormuladas);
      const a = document.getElementById('taxHorasFormuladasView');
      const b = document.getElementById('taxHorasPagadasView');
      const c = document.getElementById('taxHorasRestantesView');
      if (a) a.textContent = fmtVE(horasFormuladas);
      if (b) b.textContent = fmtVE(st.horasPagadas);
      if (c) c.textContent = fmtVE(st.horasRestantes);
    }

    function fiscalRequireValidInputs() {
      const projectKey = (document.getElementById('taxProjectSelect')?.value || '').trim();
      const projectName = (document.getElementById('taxProjectSelect')?.selectedOptions?.[0]?.dataset?.projectName || '').trim();
      const consultor = (document.getElementById('taxConsultor')?.value || '').trim();
      const horas = parseFloat(document.getElementById('taxHoras')?.value);
      const tarifa = parseFloat(document.getElementById('taxTarifa')?.value);
      const bcv = parseFloat(document.getElementById('taxBcv')?.value);
      const concepto = (document.getElementById('taxConcepto')?.value || '').trim();
      const conceptoExceso = (document.getElementById('taxConceptoExceso')?.value || '').trim();
      const fechaPago = (document.getElementById('taxFechaPago')?.value || '').trim();
      const horasFormuladas = parseFloat(document.getElementById('taxHoras')?.dataset.formuladas || '0') || 0;

      if (!projectKey) return { ok: false, msg: 'Proyecto' };
      if (!consultor) return { ok: false, msg: 'Nombre del consultor' };
      if (!isFinite(horas) || horas <= 0) return { ok: false, msg: 'Horas' };
      if (!isFinite(tarifa) || tarifa <= 0) return { ok: false, msg: 'Tarifa por hora' };
      if (!isFinite(bcv) || bcv <= 0) return { ok: false, msg: 'Tasa BCV' };
      if (!concepto) return { ok: false, msg: 'Concepto' };
      if (!fechaPago) return { ok: false, msg: 'Fecha de pago' };

      const st = fiscalHoursStatus(projectKey, projectName, consultor, horasFormuladas);

      return {
        ok: true,
        data: {
          projectKey,
          projectName,
          consultor,
          horas,
          tarifa,
          bcv,
          concepto,
          conceptoExceso,
          fechaPago,
          horasFormuladas,
          horasPagadasPrevias: st.horasPagadas,
          horasRestantesPrevias: st.horasRestantes
        }
      };
    }

    function fiscalCalcDeterministic(input) {
      const totalUsd = round2(input.horas * input.tarifa);
      const totalBs = round2(totalUsd * input.bcv); // IVA incluido
      let base = round2(totalBs / 1.16);
      let iva = round2(totalBs - base);
      let islr = round2(base * 0.05);
      let neto = round2(totalBs - islr);

      // validaci√≥n matem√°tica obligatoria
      const valid1 = round2(base + iva) === round2(totalBs);
      const valid2 = round2(totalBs - islr) === round2(neto);

      if (!valid1 || !valid2) {
        base = round2(totalBs / 1.16);
        iva = round2(totalBs - base);
        islr = round2(base * 0.05);
        neto = round2(totalBs - islr);
      }

      return {
        totalUsd,
        totalBs,
        base,
        iva,
        islr,
        neto
      };
    }

    function unidadesALetras(n) {
      const u = ['CERO','UN','DOS','TRES','CUATRO','CINCO','SEIS','SIETE','OCHO','NUEVE'];
      const d10 = ['DIEZ','ONCE','DOCE','TRECE','CATORCE','QUINCE','DIECIS√âIS','DIECISIETE','DIECIOCHO','DIECINUEVE'];
      const d20 = ['','', 'VEINTE','TREINTA','CUARENTA','CINCUENTA','SESENTA','SETENTA','OCHENTA','NOVENTA'];
      const c = ['','CIENTO','DOSCIENTOS','TRESCIENTOS','CUATROCIENTOS','QUINIENTOS','SEISCIENTOS','SETECIENTOS','OCHOCIENTOS','NOVECIENTOS'];

      if (n < 10) return u[n];
      if (n < 20) return d10[n - 10];
      if (n < 30) return n === 20 ? 'VEINTE' : `VEINTI${u[n - 20]}`;
      if (n < 100) {
        const dec = Math.floor(n / 10);
        const uni = n % 10;
        return uni === 0 ? d20[dec] : `${d20[dec]} Y ${u[uni]}`;
      }
      if (n === 100) return 'CIEN';
      if (n < 1000) {
        const cen = Math.floor(n / 100);
        const rem = n % 100;
        return rem === 0 ? c[cen] : `${c[cen]} ${unidadesALetras(rem)}`;
      }
      if (n < 2000) return `MIL${n % 1000 === 0 ? '' : ' ' + unidadesALetras(n % 1000)}`;
      if (n < 1000000) {
        const mil = Math.floor(n / 1000);
        const rem = n % 1000;
        return `${unidadesALetras(mil)} MIL${rem === 0 ? '' : ' ' + unidadesALetras(rem)}`;
      }
      if (n < 2000000) return `UN MILL√ìN${n % 1000000 === 0 ? '' : ' ' + unidadesALetras(n % 1000000)}`;
      const mill = Math.floor(n / 1000000);
      const rem = n % 1000000;
      return `${unidadesALetras(mill)} MILLONES${rem === 0 ? '' : ' ' + unidadesALetras(rem)}`;
    }

    function montoBsEnLetras(n) {
      const abs = Math.abs(round2(n));
      const entero = Math.floor(abs);
      const dec = Math.round((abs - entero) * 100);
      return `${unidadesALetras(entero)} CON ${String(dec).padStart(2, '0')}/100 BOL√çVARES`;
    }

    function fiscalSetOutputHTML(html) {
      const out = document.getElementById('taxOutput');
      if (!out) return;
      out.innerHTML = html;
    }

    function fiscalEscape(s) {
      return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    function fiscalGenerateEmail() {
      const input = fiscalRequireValidInputs();
      if (!input.ok) {
        fiscalSetOutputHTML(fiscalEscape(input.msg));
        return;
      }

      const d = input.data;
      const horasSolicitadas = round2(d.horas);
      const horasNormales = Math.min(horasSolicitadas, d.horasRestantesPrevias);
      const horasExceso = Math.max(0, round2(horasSolicitadas - horasNormales));

      if (horasExceso > 0 && !d.conceptoExceso) {
        fiscalSetOutputHTML('Concepto de exceso');
        fiscalSetStatus('Pago excede horas formuladas: debes indicar Concepto de exceso.', true);
        return;
      }

      const lineas = [];
      if (horasNormales > 0) {
        lineas.push({
          isExceso: false,
          tipoLinea: 'FORMULADAS',
          concepto: d.concepto,
          horas: horasNormales
        });
      }
      if (horasExceso > 0) {
        lineas.push({
          isExceso: true,
          tipoLinea: 'EXCESO / FUERA DE FORMULACI√ìN',
          concepto: d.conceptoExceso,
          horas: horasExceso
        });
      }

      const ops = fiscalGetDB();
      const registros = [];
      const paymentGroupId = `PAY-${Date.now()}-${Math.floor(Math.random()*1000)}`;

      lineas.forEach(linea => {
        const calc = fiscalCalcDeterministic({ horas: linea.horas, tarifa: d.tarifa, bcv: d.bcv });
        const ref = fiscalNextRef();
        const reg = {
          paymentGroupId,
          referencia: ref,
          fecha: new Date().toISOString(),
          fechaPago: d.fechaPago,
          projectKey: d.projectKey,
          proyecto: d.projectName,
          consultor: d.consultor,
          consultorEmail: fiscalFindConsultorEmail(d.consultor) || '',
          concepto: linea.concepto,
          tipoLinea: linea.tipoLinea,
          isExceso: linea.isExceso,
          horasFormuladas: round2(d.horasFormuladas),
          horasPagadasPrevias: round2(d.horasPagadasPrevias),
          horasRestantesPrevias: round2(d.horasRestantesPrevias),
          horas: round2(linea.horas),
          tarifa: round2(d.tarifa),
          bcv: round2(d.bcv),
          totalUsd: calc.totalUsd,
          totalBs: calc.totalBs,
          base: calc.base,
          iva: calc.iva,
          islr: calc.islr,
          neto: calc.neto
        };
        registros.push(reg);
        ops.push(reg);
      });

      fiscalSetDB(ops);
      fiscalUpdateHoursAuditUI();
      fiscalRefreshReferenceOptions();

      if (horasExceso > 0) {
        fiscalSetStatus(`Pago dividido autom√°ticamente: ${fmtVE(horasNormales)} h formuladas + ${fmtVE(horasExceso)} h exceso.`, true);
      } else {
        fiscalSetStatus('Pago registrado dentro de horas formuladas.');
      }

      fiscalSetOutputHTML(fiscalBuildEmailText(registros));
    }

    function fiscalSummaryByConsultor() {
      fiscalPrintReportType = 'resumen';
      const consultor = (document.getElementById('taxConsultor')?.value || '').trim();
      if (!consultor) {
        fiscalSetOutputHTML('Nombre del consultor');
        return;
      }
      const rows = fiscalGetDB().filter(x => (x.consultor || '').trim().toLowerCase() === consultor.toLowerCase());
      if (rows.length === 0) {
        fiscalSetOutputHTML('No existen registros acumulados para este consultor en la conversaci√≥n.');
        return;
      }
      const t = rows.reduce((a, r) => {
        a.base += r.base || 0;
        a.iva += r.iva || 0;
        a.islr += r.islr || 0;
        a.total += r.totalBs || 0;
        a.neto += r.neto || 0;
        return a;
      }, { base: 0, iva: 0, islr: 0, total: 0, neto: 0 });

      fiscalSetOutputHTML(`
        <table>
          <thead><tr><th>Concepto</th><th class="num">Monto Acumulado</th></tr></thead>
          <tbody>
            <tr><td>Base Imponible</td><td class="num"><strong>${fmtVE(t.base)} Bs</strong></td></tr>
            <tr><td>IVA 16%</td><td class="num"><strong>${fmtVE(t.iva)} Bs</strong></td></tr>
            <tr><td>ISLR retenido</td><td class="num"><strong>${fmtVE(t.islr)} Bs</strong></td></tr>
            <tr><td>Total facturado</td><td class="num"><strong>${fmtVE(t.total)} Bs</strong></td></tr>
            <tr><td>Total neto pagado</td><td class="num"><strong>${fmtVE(t.neto)} Bs</strong></td></tr>
          </tbody>
        </table>
      `);
    }

    function fiscalDetailByReference() {
      fiscalPrintReportType = 'detalle';
      const consultor = (document.getElementById('taxConsultor')?.value || '').trim();
      if (!consultor) {
        fiscalSetOutputHTML('Nombre del consultor');
        return;
      }
      const rows = fiscalGetDB().filter(x => (x.consultor || '').trim().toLowerCase() === consultor.toLowerCase());
      if (rows.length === 0) {
        fiscalSetOutputHTML('No existen registros acumulados para este consultor en la conversaci√≥n.');
        return;
      }

      let tb = '';
      const sum = { base: 0, iva: 0, total: 0, horas: 0 };
      rows.forEach(r => {
        sum.base += r.base || 0;
        sum.iva += r.iva || 0;
        sum.total += r.totalBs || 0;
        sum.horas += r.horas || 0;
        tb += `<tr><td>${fiscalEscape(r.referencia)}</td><td class="center"><strong>${fiscalEscape(r.fechaPago || '')}</strong></td><td class="center">${fiscalEscape(r.tipoLinea || 'FORMULADAS')}</td><td class="num"><strong>${fmtVE(r.horas || 0)} h</strong></td><td class="num"><strong>${fmtVE(r.base)} Bs</strong></td><td class="num"><strong>${fmtVE(r.iva)} Bs</strong></td><td class="num"><strong>${fmtVE(r.totalBs)} Bs</strong></td></tr>`;
      });
      tb += `<tr><td><strong>TOTAL</strong></td><td class="center"></td><td class="center"></td><td class="num"><strong>${fmtVE(sum.horas)} h</strong></td><td class="num"><strong>${fmtVE(sum.base)} Bs</strong></td><td class="num"><strong>${fmtVE(sum.iva)} Bs</strong></td><td class="num"><strong>${fmtVE(sum.total)} Bs</strong></td></tr>`;

      fiscalSetOutputHTML(`
        <table>
          <thead><tr><th>Referencia</th><th class="center">Fecha de pago</th><th class="center">Tipo</th><th class="num">Horas</th><th class="num">Base</th><th class="num">IVA 16%</th><th class="num">Monto Total Factura</th></tr></thead>
          <tbody>${tb}</tbody>
        </table>
      `);
    }

    function fiscalCopyOutput() {
      const out = document.getElementById('taxOutput');
      if (!out) return;
      const text = out.innerText || '';
      if (!text.trim()) return;
      navigator.clipboard.writeText(text).catch(() => {});
    }

    function fiscalFindConsultorEmail(consultorName) {
      const nameNorm = (consultorName || '').trim().toLowerCase();
      if (!nameNorm) return '';
      const consultants = getDB('consultantDB') || [];
      const found = consultants.find(c => ((c.name || '').trim().toLowerCase() === nameNorm));
      return found && found.email ? String(found.email).trim() : '';
    }

    function fiscalBuildEmailText(registros) {
      if (!registros || registros.length === 0) return '';
      const d0 = registros[0];
      const totalNeto = registros.reduce((s, r) => s + (r.neto || 0), 0);
      const montoLetras = montoBsEnLetras(totalNeto).toUpperCase();
      const refs = registros.map(r => r.referencia).join(', ');
      let detalleLineas = '';
      registros.forEach(r => {
        detalleLineas += `- ${r.referencia} | ${r.tipoLinea || 'FORMULADAS'} | Fecha: <strong>${fiscalEscape(r.fechaPago || '')}</strong> | Horas: <strong>${fmtVE(r.horas || 0)}</strong> | Tarifa: <strong>${fmtVE(r.tarifa || 0)} USD</strong> | Total Bs: <strong>${fmtVE(r.totalBs || 0)} Bs</strong>\n`;
      });

      return `Asunto: Confirmaci√≥n de Pago ‚Äì ${fiscalEscape(d0.concepto || d0.proyecto || '')} ‚Äì ${refs}\n\n` +
        `Estimado ${fiscalEscape(d0.consultor || '')},\n\n` +
        `Por medio de la presente se confirma la transferencia correspondiente a sus honorarios profesionales.\n\n` +
        `Proyecto: ${fiscalEscape(d0.proyecto || '')}\n` +
        `Fecha de pago: <strong>${fiscalEscape(d0.fechaPago || '')}</strong>\n\n` +
        `Detalle de l√≠neas registradas:\n${detalleLineas}\n` +
        `Desglose fiscal conforme a Providencia SNAT/2015/0049:\n` +
        `Base Imponible acumulada: <strong>${fmtVE(registros.reduce((s,r)=>s+(r.base||0),0))} Bs</strong>\n` +
        `IVA 16% acumulado: <strong>${fmtVE(registros.reduce((s,r)=>s+(r.iva||0),0))} Bs</strong>\n` +
        `Retenci√≥n ISLR 5% acumulada: <strong>${fmtVE(registros.reduce((s,r)=>s+(r.islr||0),0))} Bs</strong>\n` +
        `Neto depositado acumulado: <strong>${fmtVE(totalNeto)} Bs</strong>\n\n` +
        `Monto en letras: <strong>${montoLetras}</strong>\n\n` +
        `Se deja constancia de que su RIF se encuentra debidamente registrado.\n` +
        `Referencias de operaci√≥n: ${refs}\n\n` +
        `Atentamente,\nCarlos Matos\nV-6299302\nTesorero`;
    }

    function fiscalPrintPlanilla() {
      if (window.__fiscalPrintBusy) return;
      window.__fiscalPrintBusy = true;
      const src = document.getElementById('page-fiscal');
      if (!src) { window.__fiscalPrintBusy = false; return; }

      const projectVal = document.getElementById('taxProjectSelect')?.selectedOptions?.[0]?.textContent?.trim() || '';
      const consultorVal = (document.getElementById('taxConsultor')?.value || '').trim()
        || document.getElementById('taxConsultorSelect')?.selectedOptions?.[0]?.textContent?.trim()
        || '';

      const clone = src.cloneNode(true);

      // Quitar t√≠tulos descriptivos superiores del m√≥dulo en impresi√≥n (compatibilidad amplia)
      const fiscalTitle = clone.querySelector('h2');
      const fiscalDesc = clone.querySelector('p');
      if (fiscalTitle) fiscalTitle.remove();
      if (fiscalDesc) fiscalDesc.remove();

      // Ocultar bloque principal de captura (recuadro rojo) en impresi√≥n
      const fiscalFormBlock = clone.querySelector('.db-form.section-card');
      if (fiscalFormBlock) fiscalFormBlock.remove();

      // Marcar bloque del reporte para impresi√≥n compacta sin borde
      const taxOutputEl = clone.querySelector('#taxOutput');
      const reportBlock = taxOutputEl ? taxOutputEl.closest('.section-card') : null;
      if (reportBlock) reportBlock.classList.add('print-report-block');

      // Quitar controles no √∫tiles para documento
      clone.querySelectorAll('button, .no-print').forEach(el => el.remove());

      // Convertir campos interactivos a texto visible
      clone.querySelectorAll('input, select, textarea').forEach(el => {
        let value = '';
        const tag = (el.tagName || '').toLowerCase();
        if (tag === 'select') {
          value = el.selectedOptions && el.selectedOptions[0] ? (el.selectedOptions[0].textContent || '') : '';
        } else {
          value = el.value || '';
        }
        value = String(value).trim();

        // Oculta labels con inputs vac√≠os
        if (!value || value.startsWith('--Seleccione')) {
          const lbl = el.closest('label');
          if (lbl) lbl.remove();
          else el.remove();
          return;
        }

        const span = document.createElement('span');
        span.className = 'print-field';
        span.textContent = value;
        if (el.classList.contains('money') || el.classList.contains('pct') || /^\d/.test(value)) span.classList.add('num');

        const lbl = el.closest('label');
        if (lbl) {
          el.replaceWith(span);
        } else {
          el.replaceWith(span);
        }
      });

      // Remueve select de referencias vac√≠o
      const refSelect = clone.querySelector('#taxRefSelect');
      if (refSelect) refSelect.remove();

      const logoUrl = new URL('Logo_Hardsoft.png', window.location.href).href;
      const reportLabel = fiscalPrintReportType === 'detalle'
        ? 'Detalle por referencia'
        : (fiscalPrintReportType === 'resumen' ? 'Resumen acumulado' : '');
      const w = window.open('about:blank', '_blank');
      if (!w) {
        window.__fiscalPrintBusy = false;
        return alert('No se pudo abrir la vista de impresi√≥n. Permite ventanas emergentes para este sitio.');
      }

      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Planilla Motor Fiscal</title>
      <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;margin:0;color:#111}
        .motor-fiscal-print{margin:0;padding:0}
        .print-page{display:block;min-height:0;height:auto}
        .print-top{display:block}
        .print-zone{display:block}
        .report-shell{margin:0}
        .brand{text-align:center;border-bottom:1px solid #ddd;padding-bottom:6px;margin:0 0 6px 0}
        .brand img{width:74px;height:auto;display:block;margin:0 auto 2px}
        .brand .t1{font-size:12px;color:#666}.brand .t2{font-size:17px;font-weight:700;margin-top:2px}.brand .t3{font-size:14px;font-weight:700;color:#5f6368}
        h2{margin:0} h3{margin:0}
        .section-card,.db-form,.results{border:1px solid #e2e2e2;border-radius:10px;padding:6px 8px;margin:0 0 4px 0;height:auto;min-height:0}
        .print-header-block{break-inside:avoid;page-break-inside:avoid}
        .fiscal-print-content,.fiscal-print-content .section-card,.fiscal-print-content .db-form,.fiscal-print-content .results{margin-top:0 !important;margin-bottom:0 !important;padding-top:0 !important;padding-bottom:0 !important;height:auto !important;min-height:0 !important;line-height:1.2}
        .fiscal-print-content #taxOutput{padding:0 !important;margin:0 !important;min-height:0 !important;line-height:1.2}
        .fiscal-print-content .print-report-block{border:none !important;box-shadow:none !important;outline:none !important;background:transparent !important;padding:0 !important;margin:0 !important;min-height:0 !important;height:auto !important;break-inside:auto !important;page-break-inside:auto !important}
        .print-report-title{margin-top:4px !important;margin-bottom:6px !important;padding-top:0 !important;padding-bottom:0 !important;line-height:1.1;text-align:center;text-transform:uppercase;font-size:13px;font-weight:700;break-inside:avoid;page-break-inside:avoid}
        table{width:100%;border-collapse:collapse;table-layout:fixed;margin:0 0 4px 0}
        th,td{border:1px solid #d8d8d8;padding:6px 8px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        th{background:#f3f3f3;text-align:left}
        .num, th.num, td.num{text-align:right}
        .center, th.center, td.center{text-align:center}
        label{display:flex;flex-direction:column;gap:4px;font-weight:600;font-size:12px}
        .print-field{display:block;border:1px solid #ddd;border-radius:8px;padding:6px 8px;background:#fff;font-weight:700;font-size:13px}
        .consult-grid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:8px}
        @media print {
          @page{size:letter;margin:8mm}
          .motor-fiscal-print,.print-header-block,.fiscal-print-content,.fiscal-print-content .print-report-block{margin-top:0 !important;margin-bottom:0 !important;padding-top:0 !important;padding-bottom:0 !important;min-height:0 !important;height:auto !important}
          .print-page{min-height:0 !important;height:auto !important;display:block !important}
          .print-zone{display:block !important}
          .report-shell{margin:0 !important}
          .print-report-title{margin-top:12px !important;margin-bottom:10px !important;padding-top:0 !important;padding-bottom:0 !important}
        }
      </style></head><body><div class="motor-fiscal-print print-page">
        <div class="print-top">
          <div class="brand"><img src="${logoUrl}" alt="Logo Hardsoft"/><div class="t3">GESTI√ìN DE PROYECTOS</div></div>
          <div class="section-card print-header-block" style="break-inside:avoid;page-break-inside:avoid; margin-top:2px; padding:4px 8px; display:flex; align-items:center; justify-content:center; position:relative;">
          <div style="position:absolute; top:6px; left:10px; font-size:10px; font-weight:400; color:#555; text-transform:none; letter-spacing:0; line-height:1; text-align:left;">Nombre del Proyecto</div>
          <div style="text-align:center; line-height:1.1; padding:16px 16px 2px;">
            <div style="font-size:16px; font-weight:700;">${fiscalEscape(projectVal && !projectVal.startsWith('--Seleccione') ? projectVal : '‚Äî')}</div>
            <div style="margin-top:4px; font-size:12px; font-weight:400; color:#444;">Consultor: ${fiscalEscape(consultorVal || '‚Äî')}</div>
          </div>
          </div>
        </div>
        <div class="print-zone" style="margin-top:0; padding-top:0;">
          <div class="report-shell" style="margin:0; padding:0;">
            <div class="print-report-title" style="border:none; box-shadow:none; outline:none; background:transparent; font-size:18px; font-weight:700; text-transform:uppercase; letter-spacing:.25px; text-align:center; line-height:1.1; margin-top:10px; margin-bottom:8px;">${fiscalEscape(reportLabel || '‚Äî')}</div>
            <div class="fiscal-print-content" style="margin-top:0; padding-top:0;">${clone.innerHTML}</div>
          </div>
        </div>
      </div>

</body></html>`;

      w.document.open();
      w.document.write(html);
      w.document.close();
      let didPrint = false;
      const fire = () => {
        if (didPrint) return;
        didPrint = true;
        try { w.focus(); w.print(); } catch(_){}
        setTimeout(() => { window.__fiscalPrintBusy = false; }, 300);
      };
      w.addEventListener('load', fire, { once: true });
      setTimeout(fire, 700);
      setTimeout(() => { window.__fiscalPrintBusy = false; }, 1500);
    }

    function fiscalRefreshReferenceOptions() {
      const sel = document.getElementById('taxRefSelect');
      if (!sel) return;
      const projectKey = (document.getElementById('taxProjectSelect')?.value || '').trim().toLowerCase();
      const consultor = (document.getElementById('taxConsultor')?.value || '').trim().toLowerCase();
      const rows = fiscalGetDB()
        .filter(r => (!projectKey || ((r.projectKey || '').trim().toLowerCase() === projectKey))
          && (!consultor || ((r.consultor || '').trim().toLowerCase() === consultor)))
        .sort((a,b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));

      sel.innerHTML = '';
      const first = document.createElement('option');
      first.value = '';
      first.textContent = '--Seleccione referencia guardada--';
      sel.appendChild(first);

      rows.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.referencia;
        opt.textContent = `${r.referencia} ¬∑ ${(r.fechaPago || '').slice(0,10)} ¬∑ ${r.tipoLinea || 'FORMULADAS'}`;
        sel.appendChild(opt);
      });
    }

    function fiscalLoadEmailByReference() {
      const ref = (document.getElementById('taxRefSelect')?.value || '').trim();
      if (!ref) {
        alert('Selecciona una referencia.');
        return;
      }
      const ops = fiscalGetDB();
      const base = ops.find(r => r.referencia === ref);
      if (!base) {
        alert('Referencia no encontrada.');
        return;
      }
      let registros = [];
      if (base.paymentGroupId) {
        registros = ops.filter(r => r.paymentGroupId === base.paymentGroupId);
      } else {
        registros = [base];
      }
      registros.sort((a,b)=>String(a.referencia).localeCompare(String(b.referencia)));
      const r0 = registros[0] || base;
      const taxConsultorEl = document.getElementById('taxConsultor');
      if (taxConsultorEl && r0?.consultor) taxConsultorEl.value = r0.consultor;
      fiscalSetOutputHTML(fiscalBuildEmailText(registros));
      fiscalSetStatus(`Correo recuperado desde referencia ${ref}.`);
    }

    function fiscalSendOutlook() {
      const out = document.getElementById('taxOutput');
      const text = (out?.innerText || '').trim();
      if (!text) {
        alert('Primero genera o recupera un correo de pago.');
        return;
      }

      const consultor = (document.getElementById('taxConsultor')?.value || '').trim();
      let to = fiscalFindConsultorEmail(consultor);

      // Fallback: usa referencia seleccionada para recuperar email hist√≥rico del registro
      if (!to) {
        const ref = (document.getElementById('taxRefSelect')?.value || '').trim();
        if (ref) {
          const hit = fiscalGetDB().find(r => r.referencia === ref);
          if (hit) {
            to = (hit.consultorEmail || '').trim() || fiscalFindConsultorEmail(hit.consultor || '');
            if (!consultor && hit.consultor) {
              const taxConsultorEl = document.getElementById('taxConsultor');
              if (taxConsultorEl) taxConsultorEl.value = hit.consultor;
            }
          }
        }
      }

      if (!to) {
        alert('No se encontr√≥ correo del consultor en la base de datos ni en la referencia seleccionada. Verifica el registro del consultor.');
        return;
      }

      const lines = text.split('\n');
      let subject = '';
      let body = text;
      if (lines.length > 0 && lines[0].toLowerCase().startsWith('asunto:')) {
        subject = lines[0].replace(/^Asunto:\s*/i, '').trim();
        body = lines.slice(1).join('\n').trim();
      }

      const outlookDesktopUrl = `ms-outlook://compose?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      const mailtoUrl = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

      // Intento 1: Outlook app (nuevo Outlook)
      window.location.href = outlookDesktopUrl;
      fiscalSetStatus(`Intentando abrir Outlook app para: ${to}`);

      // Fallback autom√°tico: si el protocolo no abre, usa cliente de correo por defecto
      setTimeout(() => {
        window.location.href = mailtoUrl;
        fiscalSetStatus(`Fallback a app de correo predeterminada para: ${to}`);
      }, 1200);
    }

    function fiscalSetStatus(msg, isError = false) {
      const el = document.getElementById('taxBcvStatus');
      if (!el) return;
      el.textContent = msg;
      el.style.color = isError ? '#b42318' : '';
    }

    function fiscalGetPlanillas() {
      return getDB('planillas') || [];
    }

    function fiscalRefreshProjectOptions() {
      const sel = document.getElementById('taxProjectSelect');
      if (!sel) return;
      const plans = fiscalGetPlanillas();
      const prev = sel.value;

      sel.innerHTML = '<option value="">--Seleccione proyecto--</option>';

      plans
        .filter(p => (p.proyecto || '').trim())
        .sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0))
        .forEach((p, idx) => {
          const key = (p.projectKey || '').trim() || `LEGACY-${p.correlativo || idx + 1}`;
          const projectName = (p.proyecto || '').trim();
          const clientName = (p.cliente || '').trim();
          const opt = document.createElement('option');
          opt.value = key;
          opt.dataset.projectName = projectName;
          opt.dataset.clientName = clientName;
          opt.textContent = projectName;
          sel.appendChild(opt);
        });

      if ([...sel.options].some(o => o.value === prev)) sel.value = prev;
      fiscalPopulateConsultorsByProject();
    }

    function fiscalPopulateConsultorsByProject() {
      const projectKey = (document.getElementById('taxProjectSelect')?.value || '').trim();
      const projectName = (document.getElementById('taxProjectSelect')?.selectedOptions?.[0]?.dataset?.projectName || '').trim();
      const sel = document.getElementById('taxConsultorSelect');
      if (!sel) return;

      sel.innerHTML = '<option value="">--Seleccione consultor--</option>';
      if (!projectKey && !projectName) {
        fiscalUpdateHoursAuditUI();
        return;
      }

      const plans = fiscalGetPlanillas().filter((p, idx) => {
        const key = (p.projectKey || '').trim() || `LEGACY-${p.correlativo || idx + 1}`;
        if (projectKey) return key === projectKey;
        return (p.proyecto || '').trim() === projectName;
      });

      const map = new Map();
      plans.forEach((p, pIdx) => {
        const key = (p.projectKey || '').trim() || `LEGACY-${p.correlativo || pIdx + 1}`;
        (p.consultores || []).forEach(c => {
          const name = (c.nombre || '').trim();
          if (!name) return;
          const rowKey = `${name}__${round2(c.tarifa || 0)}__${round2(c.horas || 0)}__${key}`;
          map.set(rowKey, {
            nombre: name,
            tarifa: round2(c.tarifa || 0),
            horas: round2(c.horas || 0),
            projectKey: key,
            projectName: (p.proyecto || '').trim()
          });
        });
      });

      Array.from(map.values()).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach((item, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.dataset.nombre = item.nombre;
        opt.dataset.tarifa = String(item.tarifa);
        opt.dataset.horas = String(item.horas);
        opt.dataset.projectKey = item.projectKey;
        opt.dataset.projectName = item.projectName;
        opt.textContent = item.nombre;
        sel.appendChild(opt);
      });
    }

    function fiscalApplyProjectConsultor() {
      const projectKey = (document.getElementById('taxProjectSelect')?.value || '').trim();
      const projectName = (document.getElementById('taxProjectSelect')?.selectedOptions?.[0]?.dataset?.projectName || '').trim();
      const sel = document.getElementById('taxConsultorSelect');
      const opt = sel?.selectedOptions?.[0];
      if (!opt || !opt.dataset) return;

      const nombre = opt.dataset.nombre || '';
      const tarifa = parseFloat(opt.dataset.tarifa || '0') || 0;
      const horasFormuladas = parseFloat(opt.dataset.horas || '0') || 0;
      const st = fiscalHoursStatus(projectKey, projectName, nombre, horasFormuladas);

      document.getElementById('taxConsultor').value = nombre;
      document.getElementById('taxTarifa').value = tarifa > 0 ? tarifa : '';
      document.getElementById('taxHoras').value = st.horasRestantes > 0 ? st.horasRestantes : '';
      document.getElementById('taxHoras').dataset.formuladas = String(horasFormuladas);

      const conceptoEl = document.getElementById('taxConcepto');
      if (conceptoEl && !conceptoEl.value.trim() && projectName) {
        conceptoEl.value = projectName;
      }

      const fechaEl = document.getElementById('taxFechaPago');
      if (fechaEl && !fechaEl.value) {
        fechaEl.value = new Date().toISOString().slice(0, 10);
      }

      fiscalUpdateHoursAuditUI();
      fiscalRefreshReferenceOptions();
    }

    async function fiscalFetchBCV() {
      try {
        fiscalSetStatus('Consultando tasa BCV...');
        const res = await fetch('https://ve.dolarapi.com/v1/dolares/oficial');
        if (!res.ok) throw new Error('No se pudo consultar la API.');
        const data = await res.json();
        const bcv = parseFloat(data.promedio);
        if (!isFinite(bcv) || bcv <= 0) throw new Error('API devolvi√≥ una tasa inv√°lida.');
        document.getElementById('taxBcv').value = bcv;
        fiscalSetStatus(`BCV cargado: ${fmtVE(bcv)} (${new Date().toLocaleString('es-VE')})`);
      } catch (e) {
        fiscalSetStatus('No se pudo cargar BCV por API. Ingresa la tasa manualmente.', true);
      }
    }

    let liqLastProjectKey = '';

    function liqDBReceipts() { return getDB('liquidationReceipts') || []; }
    function liqDBExpenses() { return getDB('liquidationExpenses') || []; }
    function liqDBRetentionCfg() { return getDB('liquidationRetentionCfg') || []; }
    function liqDBInvoiceCfg() { return getDB('liquidationInvoiceCfg') || []; }

    function liqNormalizeNumeroFactura(v) {
      const s = String(v || '').trim();
      return /^\d{1,6}$/.test(s) ? s : null;
    }

    function liqMigrateInvoiceNumbers() {
      const invoices = getDB('liquidationIssuedInvoices') || [];
      let changed = false;
      const migrated = invoices.map(inv => {
        const candidate = (inv.numero_factura ?? inv.numeroFactura ?? '').toString().trim();
        const normalized = liqNormalizeNumeroFactura(candidate);
        const next = {
          ...inv,
          numeroFactura: normalized,
          numero_factura: normalized
        };
        if ((inv.numeroFactura ?? null) !== next.numeroFactura || (inv.numero_factura ?? null) !== next.numero_factura) changed = true;
        return next;
      });
      if (changed) setDB('liquidationIssuedInvoices', migrated);
    }

    function liqFindInvoiceForReceipt(receipt, invoices) {
      const byId = (receipt.facturaId || '').trim();
      if (byId) {
        const hit = invoices.find(inv => (inv.id || '').trim() === byId);
        if (hit) return hit;
      }

      let candidates = invoices.filter(inv => (inv.projectKey || '').trim() === (receipt.projectKey || '').trim());

      const fFecha = (receipt.facturaFecha || '').trim();
      if (fFecha) candidates = candidates.filter(inv => (inv.fecha || '').trim() === fFecha);

      const fRef = (receipt.facturaRef || '').trim();
      if (fRef) candidates = candidates.filter(inv => (inv.referenciaPago || '').trim() === fRef);

      const fTotal = parseFloat(receipt.facturaTotalUsd);
      if (isFinite(fTotal)) {
        candidates = candidates.filter(inv => Math.abs((parseFloat(inv.totalUsd) || 0) - fTotal) <= 0.01);
      }

      return candidates.length === 1 ? candidates[0] : null;
    }

    function liqBackfillReceiptInvoiceNumbers() {
      const invoices = getDB('liquidationIssuedInvoices') || [];
      const receipts = liqDBReceipts();
      if (!receipts.length) return;

      let changed = false;
      const updated = receipts.map(r => {
        const linked = liqFindInvoiceForReceipt(r, invoices);
        const linkedNumero = linked ? liqNormalizeNumeroFactura(linked.numero_factura || linked.numeroFactura || '') : null;
        const currentNumero = liqNormalizeNumeroFactura(r.numero_factura || r.numeroFactura || '');

        let needsReview = false;
        if (!linked) needsReview = true;
        if (linked && !linkedNumero) needsReview = true;

        const next = {
          ...r,
          facturaId: linked ? (linked.id || r.facturaId || null) : (r.facturaId || null),
          numeroFactura: linkedNumero,
          numero_factura: linkedNumero,
          needsReview,
          needs_review: needsReview
        };

        if ((r.facturaId || null) !== (next.facturaId || null)
          || (r.numeroFactura || null) !== (next.numeroFactura || null)
          || (r.numero_factura || null) !== (next.numero_factura || null)
          || !!r.needsReview !== !!next.needsReview
          || !!r.needs_review !== !!next.needs_review) {
          changed = true;
        }
        return next;
      });

      if (changed) setDB('liquidationReceipts', updated);

      const nullCount = updated.filter(x => !x.numeroFactura).length;
      const mismatchCount = updated.filter(x => {
        if (!x.facturaId) return false;
        const inv = invoices.find(i => (i.id || '').trim() === (x.facturaId || '').trim());
        if (!inv) return false;
        const invN = liqNormalizeNumeroFactura(inv.numero_factura || inv.numeroFactura || '');
        const payN = liqNormalizeNumeroFactura(x.numero_factura || x.numeroFactura || '');
        return invN !== payN;
      }).length;

      const report = {
        totalPagos: updated.length,
        pagosNumeroFacturaNull: nullCount,
        pagosMismatchConFactura: mismatchCount
      };
      window.__liqBackfillReport = report;
      console.info('[Liquidaci√≥n][Backfill numero_factura]', report);
    }

    function liqCascadeInvoiceNumberToReceipts(invoiceId, numeroFactura) {
      const receipts = liqDBReceipts();
      if (!receipts.length || !invoiceId) return;
      const numero = liqNormalizeNumeroFactura(numeroFactura || '');
      let changed = false;
      const updated = receipts.map(r => {
        if ((r.facturaId || '').trim() !== String(invoiceId).trim()) return r;
        const next = { ...r, numeroFactura: numero, numero_factura: numero, needsReview: !numero, needs_review: !numero };
        if ((r.numeroFactura || null) !== (next.numeroFactura || null)
          || (r.numero_factura || null) !== (next.numero_factura || null)
          || !!r.needsReview !== !!next.needsReview
          || !!r.needs_review !== !!next.needs_review) changed = true;
        return next;
      });
      if (changed) setDB('liquidationReceipts', updated);
    }

    function pctParse(v) {
      const s = String(v ?? '').trim().replace('%','').replace(',', '.');
      const n = parseFloat(s);
      if (!isFinite(n)) return 0;
      return n <= 1 ? n * 100 : n;
    }

    function pctFormat(v) {
      const n = pctParse(v);
      return new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n) + '%';
    }

    function pctToFactor(v) {
      return pctParse(v) / 100;
    }

    function liqGetRetentionConfig(projectKey) {
      const list = liqDBRetentionCfg();
      const row = list.find(x => (x.projectKey || '').trim() === (projectKey || '').trim());
      return row || { projectKey, retIvaPct: 0, retIslrPct: 0 };
    }

    function liqSaveRetentionConfig() {
      const projectKey = (document.getElementById('liqProjectSelect')?.value || '').trim();
      if (!projectKey) return;
      const retIvaPct = parseFloat(document.getElementById('liqRetIvaPct')?.value);
      const retIslrPct = parseFloat(document.getElementById('liqRetIslrPct')?.value);
      const iva = isFinite(retIvaPct) && retIvaPct >= 0 ? retIvaPct : 0;
      const islr = isFinite(retIslrPct) && retIslrPct >= 0 ? retIslrPct : 0;

      const list = liqDBRetentionCfg();
      const idx = list.findIndex(x => (x.projectKey || '').trim() === projectKey);
      const row = { projectKey, retIvaPct: round2(iva), retIslrPct: round2(islr) };
      if (idx >= 0) list[idx] = row; else list.push(row);
      setDB('liquidationRetentionCfg', list);
      liqLoadProject();
    }

    function liqGetInvoiceConfig(projectKey, defaultSale = 0) {
      const list = liqDBInvoiceCfg();
      const row = list.find(x => (x.projectKey || '').trim() === (projectKey || '').trim());
      if (row) return row;
      return {
        projectKey,
        baseUsd: round2(defaultSale / 1.16),
        ivaPct: 16
      };
    }

    function liqSaveInvoiceConfig() {
      const projectKey = (document.getElementById('liqProjectSelect')?.value || '').trim();
      if (!projectKey) return;
      const baseUsd = parseFloat(document.getElementById('liqInvBaseUsd')?.value);
      const ivaPct = parseFloat(document.getElementById('liqInvIvaPct')?.value);
      const base = isFinite(baseUsd) && baseUsd >= 0 ? baseUsd : 0;
      const iva = isFinite(ivaPct) && ivaPct >= 0 ? ivaPct : 16;

      const list = liqDBInvoiceCfg();
      const idx = list.findIndex(x => (x.projectKey || '').trim() === projectKey);
      const row = { projectKey, baseUsd: round2(base), ivaPct: round2(iva) };
      if (idx >= 0) list[idx] = row; else list.push(row);
      setDB('liquidationInvoiceCfg', list);
      liqLoadProject();
    }

    function liqSaveIssuedInvoice() {
      const p = liqCurrentProject();
      const projectKey = (document.getElementById('liqProjectSelect')?.value || '').trim();
      if (!p || !projectKey) return alert('Selecciona un proyecto.');

      const fecha = (document.getElementById('liqInvDate')?.value || '').trim();
      const numeroFacturaRaw = (document.getElementById('liqInvNumber')?.value || '').trim();
      const refPago = (document.getElementById('liqInvPayRef')?.value || '').trim();
      const baseUsd = parseFloat(document.getElementById('liqInvBaseUsd')?.value) || 0;
      const ivaPct = parseFloat(document.getElementById('liqInvIvaPct')?.value) || 16;
      if (!fecha) return alert('Fecha de factura es obligatoria.');
      const numeroFactura = liqNormalizeNumeroFactura(numeroFacturaRaw);
      if (!numeroFactura) return alert('No. Factura es obligatorio y debe tener entre 1 y 6 d√≠gitos.');

      const invoices = getDB('liquidationIssuedInvoices') || [];
      if (invoices.some(x => String(x.numero_factura || x.numeroFactura || '').trim() === numeroFactura)) {
        return alert('No. Factura duplicado. Debe ser √∫nico.');
      }

      const ivaUsd = round2(baseUsd * pctToFactor(ivaPct));
      const totalUsd = round2(baseUsd + ivaUsd);

      invoices.push({
        id: `INV-${Date.now()}`,
        createdAt: new Date().toISOString(),
        fecha,
        numeroFactura,
        numero_factura: numeroFactura,
        projectKey,
        cliente: (p.cliente || '').trim(),
        proyecto: (p.proyecto || '').trim(),
        referenciaPago: refPago,
        baseUsd: round2(baseUsd),
        ivaPct: round2(ivaPct),
        ivaUsd,
        totalUsd
      });
      setDB('liquidationIssuedInvoices', invoices);
      liqBackfillReceiptInvoiceNumbers();

      alert('Factura emitida guardada en base de datos.');
      liqLoadProject();

      // Limpiar campos de captura luego de guardar
      const invDateEl = document.getElementById('liqInvDate');
      const invNumEl = document.getElementById('liqInvNumber');
      const invRefEl = document.getElementById('liqInvPayRef');
      const invBaseEl = document.getElementById('liqInvBaseUsd');
      const invPctEl = document.getElementById('liqInvIvaPct');
      const invIvaOut = document.getElementById('liqInvIvaUsd');
      const invTotalOut = document.getElementById('liqInvTotalUsd');
      if (invDateEl) invDateEl.value = '';
      if (invNumEl) invNumEl.value = '';
      if (invRefEl) invRefEl.value = '';
      if (invBaseEl) invBaseEl.value = '';
      if (invPctEl) invPctEl.value = '';
      if (invIvaOut) invIvaOut.value = '';
      if (invTotalOut) invTotalOut.value = '';
    }

    function liqDeleteIssuedInvoice(id) {
      if (!confirm('¬øEliminar factura emitida?')) return;
      const list = (getDB('liquidationIssuedInvoices') || []).filter(x => x.id !== id);
      setDB('liquidationIssuedInvoices', list);
      liqLoadProject();
    }

    function liqEditIssuedInvoice(id) {
      const list = getDB('liquidationIssuedInvoices') || [];
      const idx = list.findIndex(x => x.id === id);
      if (idx < 0) return;
      const row = list[idx];
      const fecha = prompt('Fecha (YYYY-MM-DD):', row.fecha || '');
      if (fecha === null) return;
      const numeroActual = (row.numeroFactura || row.numero_factura || '').trim();
      const numeroFacturaInput = prompt('No. Factura:', numeroActual);
      if (numeroFacturaInput === null) return;
      const ref = prompt('Referencia de pago:', row.referenciaPago || '');
      if (ref === null) return;
      const base = prompt('Base imponible USD:', String(row.baseUsd || 0));
      if (base === null) return;
      const ivaPct = prompt('Tasa IVA (%):', String(row.ivaPct || 16));
      if (ivaPct === null) return;
      const b = parseFloat(base);
      const p = parseFloat(ivaPct);
      const numNorm = liqNormalizeNumeroFactura((numeroFacturaInput || '').trim() || numeroActual);
      if (!fecha.trim() || !numNorm || !isFinite(b) || b < 0 || !isFinite(p) || p < 0) return alert('Datos inv√°lidos. No. Factura debe tener entre 1 y 6 d√≠gitos.');
      if (list.some((x, i) => i !== idx && String(x.numero_factura || x.numeroFactura || '').trim() === numNorm)) {
        return alert('No. Factura duplicado. Debe ser √∫nico.');
      }
      const ivaUsd = round2(b * pctToFactor(p));
      const totalUsd = round2(b + ivaUsd);
      list[idx] = { ...row, fecha: fecha.trim(), numeroFactura: numNorm, numero_factura: numNorm, referenciaPago: ref.trim(), baseUsd: round2(b), ivaPct: round2(p), ivaUsd, totalUsd };
      setDB('liquidationIssuedInvoices', list);
      liqCascadeInvoiceNumberToReceipts(row.id, numNorm);
      liqBackfillReceiptInvoiceNumbers();
      liqLoadProject();
    }

    function liqRefreshClientOptions() {
      const sel = document.getElementById('liqClientFilter');
      if (!sel) return;
      const plans = getDB('planillas') || [];
      const clients = [...new Set(plans.map(p => (p.cliente || '').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      const prev = sel.value;
      sel.innerHTML = '<option value="">--Seleccione cliente--</option>';
      clients.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
      });
      if (clients.includes(prev)) sel.value = prev;
      liqRefreshProjectOptions();
    }

    function liqRefreshProjectOptions() {
      const c = (document.getElementById('liqClientFilter')?.value || '').trim();
      const sel = document.getElementById('liqProjectSelect');
      if (!sel) return;
      const plans = (getDB('planillas') || []).filter(p => !c || (p.cliente || '').trim() === c);
      const prev = sel.value;
      sel.innerHTML = '<option value="">--Seleccione proyecto--</option>';
      plans.forEach((p, idx) => {
        const key = (p.projectKey || '').trim() || `LEGACY-${p.correlativo || idx + 1}`;
        const o = document.createElement('option');
        o.value = key;
        o.dataset.projectName = (p.proyecto || '').trim();
        o.textContent = (p.proyecto || '').trim();
        sel.appendChild(o);
      });
      if ([...sel.options].some(x => x.value === prev)) sel.value = prev;
      liqLoadProject();
    }

    function liqCurrentProject() {
      const key = (document.getElementById('liqProjectSelect')?.value || '').trim();
      if (!key) return null;
      const plans = getDB('planillas') || [];
      return plans.find((p, idx) => ((p.projectKey || '').trim() || `LEGACY-${p.correlativo || idx + 1}`) === key) || null;
    }

    function liqPreviewReceiptUSD() {
      const amountBs = parseFloat(document.getElementById('liqReceiptAmountBs')?.value);
      const rateDay = parseFloat(document.getElementById('liqReceiptRateDay')?.value);
      const out = document.getElementById('liqReceiptAmountUsd');
      if (!isFinite(amountBs) || amountBs <= 0 || !isFinite(rateDay) || rateDay <= 0) {
        if (out) out.value = '';
        return;
      }
      const amountUsd = round2(amountBs / rateDay);
      if (out) out.value = `${fmtVE(amountUsd)} USD`;
    }

    function liqGetLatestIssuedInvoice(projectKey) {
      const invoices = (getDB('liquidationIssuedInvoices') || [])
        .filter(x => (x.projectKey || '').trim() === (projectKey || '').trim())
        .sort((a, b) => new Date(b.createdAt || b.fecha || 0) - new Date(a.createdAt || a.fecha || 0));
      return invoices[0] || null;
    }

    function liqFmtRetentionPct(pct) {
      if (!isFinite(pct)) return 'N/A';
      return `${fmtVE(pct * 100)}%`;
    }

    function liqAddReceipt() {
      const projectKey = (document.getElementById('liqProjectSelect')?.value || '').trim();
      const date = (document.getElementById('liqReceiptDate')?.value || '').trim();
      const amountBs = parseFloat(document.getElementById('liqReceiptAmountBs')?.value);
      const rateDay = parseFloat(document.getElementById('liqReceiptRateDay')?.value);

      if (!projectKey) return alert('Selecciona un proyecto.');
      if (!date || !isFinite(amountBs) || amountBs <= 0 || !isFinite(rateDay) || rateDay <= 0) return alert('Fecha, monto en Bs y tasa del d√≠a son obligatorios.');

      const latestInvoice = liqGetLatestIssuedInvoice(projectKey);
      if (!latestInvoice) {
        return alert('Debes guardar una Factura Emitida antes de registrar un Pago Recibido.');
      }

      const pagoNetoUsd = round2(amountBs / rateDay);
      const baseUsd = round2(parseFloat(latestInvoice.baseUsd) || 0);
      const ivaUsd = round2(parseFloat(latestInvoice.ivaUsd) || 0);
      const totalUsd = round2(parseFloat(latestInvoice.totalUsd) || 0);

      const totalRetenidoUsd = Math.max(0, round2(totalUsd - pagoNetoUsd));
      const retIvaUsd = round2(Math.min(ivaUsd, totalRetenidoUsd));
      const retIslrUsd = round2(Math.max(0, totalRetenidoUsd - retIvaUsd));

      const pctIvaSobreBase = baseUsd > 0 ? round2(retIvaUsd / baseUsd) : null;
      const pctIslrSobreBase = baseUsd > 0 ? round2(retIslrUsd / baseUsd) : null;
      const tasaBsUsd = round2(rateDay);
      const retIvaBs = round2(retIvaUsd * tasaBsUsd);
      const retIslrBs = round2(retIslrUsd * tasaBsUsd);

      const rows = liqDBReceipts();
      rows.push({
        id: `RC-${Date.now()}`,
        projectKey,
        date,
        amountBs: round2(amountBs),
        rateDay: tasaBsUsd,
        tasaBsUsd,
        amountUsd: pagoNetoUsd,
        pagoNetoUsd,
        facturaId: latestInvoice.id || null,
        numeroFactura: String(latestInvoice.numero_factura || latestInvoice.numeroFactura || '').trim() || null,
        numero_factura: String(latestInvoice.numero_factura || latestInvoice.numeroFactura || '').trim() || null,
        needsReview: false,
        needs_review: false,
        facturaRef: latestInvoice.referenciaPago || '',
        facturaFecha: latestInvoice.fecha || '',
        facturaTotalUsd: totalUsd,
        retIvaUsd,
        retIvaBs,
        retIslrUsd,
        retIslrBs,
        pctIvaSobreBase,
        pctIslrSobreBase,
        // compatibilidad retroactiva
        pctRetIvaSobreBase: pctIvaSobreBase,
        pctRetIslrSobreBase: pctIslrSobreBase
      });
      setDB('liquidationReceipts', rows);

      document.getElementById('liqReceiptDate').value = '';
      document.getElementById('liqReceiptAmountBs').value = '';
      document.getElementById('liqReceiptRateDay').value = '';
      const out = document.getElementById('liqReceiptAmountUsd');
      if (out) out.value = '';
      liqLoadProject();
    }

    function liqEditReceipt(id) {
      const rows = liqDBReceipts();
      const idx = rows.findIndex(x => x.id === id);
      if (idx < 0) return;
      const row = rows[idx];

      const date = prompt('Fecha (YYYY-MM-DD):', row.date || '');
      if (date === null) return;
      const amountBsTxt = prompt('Monto recibido (Bs):', String(row.amountBs || 0));
      if (amountBsTxt === null) return;
      const rateDayTxt = prompt('Tasa del d√≠a (Bs/USD):', String(row.rateDay || 0));
      if (rateDayTxt === null) return;

      const amountBs = parseFloat(amountBsTxt);
      const rateDay = parseFloat(rateDayTxt);
      if (!date.trim() || !isFinite(amountBs) || amountBs <= 0 || !isFinite(rateDay) || rateDay <= 0) {
        alert('Datos inv√°lidos.');
        return;
      }

      const latestInvoice = liqGetLatestIssuedInvoice(row.projectKey);
      if (!latestInvoice) {
        alert('Debes guardar una Factura Emitida antes de registrar/editar un Pago Recibido.');
        return;
      }

      const pagoNetoUsd = round2(amountBs / rateDay);
      const baseUsd = round2(parseFloat(latestInvoice.baseUsd) || 0);
      const ivaUsd = round2(parseFloat(latestInvoice.ivaUsd) || 0);
      const totalUsd = round2(parseFloat(latestInvoice.totalUsd) || 0);

      const totalRetenidoUsd = Math.max(0, round2(totalUsd - pagoNetoUsd));
      const retIvaUsd = round2(Math.min(ivaUsd, totalRetenidoUsd));
      const retIslrUsd = round2(Math.max(0, totalRetenidoUsd - retIvaUsd));

      const pctIvaSobreBase = baseUsd > 0 ? round2(retIvaUsd / baseUsd) : null;
      const pctIslrSobreBase = baseUsd > 0 ? round2(retIslrUsd / baseUsd) : null;
      const tasaBsUsd = round2(rateDay);
      const retIvaBs = round2(retIvaUsd * tasaBsUsd);
      const retIslrBs = round2(retIslrUsd * tasaBsUsd);

      rows[idx] = {
        ...row,
        date: date.trim(),
        amountBs: round2(amountBs),
        rateDay: tasaBsUsd,
        tasaBsUsd,
        amountUsd: pagoNetoUsd,
        pagoNetoUsd,
        facturaId: latestInvoice.id || null,
        numeroFactura: String(latestInvoice.numero_factura || latestInvoice.numeroFactura || '').trim() || null,
        numero_factura: String(latestInvoice.numero_factura || latestInvoice.numeroFactura || '').trim() || null,
        needsReview: false,
        needs_review: false,
        facturaRef: latestInvoice.referenciaPago || '',
        facturaFecha: latestInvoice.fecha || '',
        facturaTotalUsd: totalUsd,
        retIvaUsd,
        retIvaBs,
        retIslrUsd,
        retIslrBs,
        pctIvaSobreBase,
        pctIslrSobreBase,
        // compatibilidad retroactiva
        pctRetIvaSobreBase: pctIvaSobreBase,
        pctRetIslrSobreBase: pctIslrSobreBase
      };

      setDB('liquidationReceipts', rows);
      liqLoadProject();
    }

    function liqDeleteReceipt(id) {
      if (!confirm('¬øEliminar este pago recibido?')) return;
      const rows = liqDBReceipts().filter(x => x.id !== id);
      setDB('liquidationReceipts', rows);
      liqLoadProject();
    }

    function liqPrintPlanilla() {
      const projectKey = (document.getElementById('liqProjectSelect')?.value || '').trim();
      const projectName = (document.getElementById('liqProjectSelect')?.selectedOptions?.[0]?.dataset?.projectName || '').trim();
      const clientName = (document.getElementById('liqClientFilter')?.value || '').trim();
      if (!projectKey) return alert('Selecciona un proyecto para imprimir la planilla.');

      const invoices = (getDB('liquidationIssuedInvoices') || [])
        .filter(x => (x.projectKey || '').trim() === projectKey)
        .sort((a,b) => (a.fecha || '').localeCompare(b.fecha || ''));
      const receipts = liqDBReceipts()
        .filter(x => (x.projectKey || '').trim() === projectKey)
        .sort((a,b) => (a.date || '').localeCompare(b.date || ''));
      const expenses = liqDBExpenses()
        .filter(x => (x.projectKey || '').trim() === projectKey)
        .sort((a,b) => (a.date || '').localeCompare(b.date || ''));

      const saleAmount = document.getElementById('liqSaleAmount')?.value || '0,00 USD';
      const logoUrl = new URL('Logo_Hardsoft.png', window.location.href).href;

      const summary = {
        retIva: document.getElementById('liqRetIva')?.textContent || '0,00 USD',
        retIslr: document.getElementById('liqRetIslr')?.textContent || '0,00 USD',
        totalReceipts: document.getElementById('liqTotalReceipts')?.textContent || '0,00 USD',
        consultants: document.getElementById('liqTotalFiscalConsultants')?.textContent || '0,00 USD',
        managers: document.getElementById('liqTotalFiscalManagers')?.textContent || '0,00 USD',
        expenses: document.getElementById('liqTotalExpenses')?.textContent || '0,00 USD',
        totalCosts: document.getElementById('liqTotalCosts')?.textContent || '0,00 USD',
        cash: document.getElementById('liqCashLeft')?.textContent || '0,00 USD',
        facturado: document.getElementById('liqFacturadoAcum')?.textContent || '0,00 USD',
        pendiente: document.getElementById('liqSaldoPendiente')?.textContent || '0,00 USD'
      };

      const teamRows = Array.from(document.querySelectorAll('#liqTeamTable tbody tr')).map(tr => tr.innerHTML).join('');

      const invRows = invoices.length
        ? invoices.map(x => `<tr><td>${fiscalEscape(x.fecha || '')}</td><td>${fiscalEscape(x.numero_factura || x.numeroFactura || '‚Äî')}</td><td class="num">${fmtVE(x.baseUsd || 0)} USD</td><td class="num">${fmtVE(x.ivaUsd || 0)} USD</td><td class="num">${fmtVE(x.totalUsd || 0)} USD</td></tr>`).join('')
        : '<tr><td colspan="5">Sin facturas emitidas guardadas.</td></tr>';

      const recRows = receipts.length
        ? receipts.map(x => {
            const amountUsd = isFinite(parseFloat(x.pagoNetoUsd)) ? parseFloat(x.pagoNetoUsd) : (isFinite(parseFloat(x.amountUsd)) ? parseFloat(x.amountUsd) : (parseFloat(x.amount) || 0));
            const pctIva = isFinite(parseFloat(x.pctIvaSobreBase)) ? parseFloat(x.pctIvaSobreBase) : (isFinite(parseFloat(x.pctRetIvaSobreBase)) ? parseFloat(x.pctRetIvaSobreBase) : NaN);
            const pctIslr = isFinite(parseFloat(x.pctIslrSobreBase)) ? parseFloat(x.pctIslrSobreBase) : (isFinite(parseFloat(x.pctRetIslrSobreBase)) ? parseFloat(x.pctRetIslrSobreBase) : NaN);
            return `<tr><td>${fiscalEscape(x.date || '')}</td><td class="num">${fmtVE(x.amountBs || 0)} Bs</td><td class="num">${fmtVE(x.tasaBsUsd || x.rateDay || 0)}</td><td class="num">${fmtVE(amountUsd)} USD</td><td class="num">${fmtVE(x.retIvaUsd || 0)} USD ¬∑ ${liqFmtRetentionPct(pctIva)}</td><td class="num">${fmtVE(x.retIslrUsd || 0)} USD ¬∑ ${liqFmtRetentionPct(pctIslr)}</td><td class="num">${fiscalEscape(String(x.numero_factura || x.numeroFactura || '‚Äî'))}</td></tr>`;
          }).join('')
        : '<tr><td colspan="7">Sin pagos recibidos guardados.</td></tr>';

      const expRows = expenses.length
        ? expenses.map(x => `<tr><td>${fiscalEscape(x.date || '')}</td><td>${fiscalEscape(x.concept || '')}</td><td class="num">${fmtVE(x.amount || 0)} USD</td><td class="num">${fmtVE(x.rateDay || 0)}</td></tr>`).join('')
        : '<tr><td colspan="4">Sin gastos extraordinarios.</td></tr>';

      const w = window.open('about:blank', '_blank');
      if (!w) return alert('No se pudo abrir la vista de impresi√≥n. Permite ventanas emergentes para este sitio.');

      const printHtml = `<!doctype html><html><head><meta charset="utf-8"><title>Planilla de Liquidaci√≥n</title>
        <style>
          body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;margin:18px;color:#111}
          h1{font-size:20px;margin:0 0 6px} h2{font-size:15px;margin:14px 0 8px}
          .meta{font-size:12px;color:#555;margin-bottom:10px}
          .brand{text-align:center;border-bottom:1px solid #ddd;padding-bottom:10px;margin-bottom:12px}
          .brand img{width:74px;height:auto;display:block;margin:0 auto 4px}
          .brand .t1{font-size:12px;color:#666}
          .brand .t2{font-size:17px;font-weight:700;margin-top:3px}
          .brand .t3{font-size:14px;font-weight:700;color:#5f6368}
          table{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:12px}
          th,td{border:1px solid #d8d8d8;padding:6px 8px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
          th{text-align:left;background:#f3f3f3}
          th.num, td.num{text-align:right;white-space:nowrap}
          #teamPrintTable th:nth-child(3),
          #teamPrintTable td:nth-child(3),
          #teamPrintTable th:nth-child(4),
          #teamPrintTable td:nth-child(4){text-align:right;white-space:nowrap}
          .blk{border:1px solid #e5e5e5;border-radius:8px;padding:10px;margin-top:10px}
          .row{display:flex;justify-content:space-between;font-size:12px;padding:3px 0}
          .saldo{font-weight:700}
          .print-block{break-inside:avoid;page-break-inside:avoid;-webkit-column-break-inside:avoid;}
          .print-block h1,.print-block h2,.print-block h3{break-after:avoid;page-break-after:avoid;}
          .print-block table{break-inside:avoid;page-break-inside:avoid;}
          @page{size:letter;margin:10mm}
        </style></head><body>
        <div class="print-block">
          <div class="brand">
            <img src="${logoUrl}" alt="Logo Hardsoft" />
            <div class="t3">GESTI√ìN DE PROYECTOS</div>
          </div>

          <h1>Liquidaci√≥n de Proyecto</h1>
          <div class="meta">Cliente: ${fiscalEscape(clientName || '‚Äî')} ¬∑ Proyecto: ${fiscalEscape(projectName || '‚Äî')} ¬∑ Fecha: ${new Date().toLocaleString('es-VE')}</div>
          <table><thead><tr><th>Cliente</th><th>Proyecto</th><th class="num">Monto de venta (USD)</th></tr></thead><tbody><tr><td>${fiscalEscape(clientName || '‚Äî')}</td><td>${fiscalEscape(projectName || '‚Äî')}</td><td class="num">${fiscalEscape(saleAmount || '0,00 USD')}</td></tr></tbody></table>
        </div>

        <div class="print-block">
          <h2>Facturas emitidas guardadas (resumen)</h2>
          <table><thead><tr><th>Fecha</th><th>No. Factura</th><th class="num">Base USD</th><th class="num">IVA USD</th><th class="num">Total USD</th></tr></thead><tbody>${invRows}</tbody></table>
        </div>

        <div class="print-block">
          <h2>Pagos recibidos guardados (resumen)</h2>
          <table><thead><tr><th>Fecha</th><th class="num">Monto recibido Bs</th><th class="num">Tasa del d√≠a</th><th class="num">Pago neto USD</th><th class="num">Ret. IVA USD y % IVA s/base</th><th class="num">Ret. ISLR USD y % ISLR s/base</th><th class="num">No. Factura</th></tr></thead><tbody>${recRows}</tbody></table>
        </div>

        <div class="print-block">
          <h2>Gastos adicionales y extraordinarios</h2>
          <table><thead><tr><th>Fecha</th><th>Concepto</th><th class="num">Monto USD</th><th class="num">Tasa del d√≠a</th></tr></thead><tbody>${expRows}</tbody></table>
        </div>

        <div class="print-block">
          <h2>Pagos a Consutores y Gerentes ejecutado</h2>
          <table id="teamPrintTable"><thead><tr><th>Rol</th><th>Nombre</th><th class="num">Horas pagadas (Motor Fiscal)</th><th class="num">Pagado en Motor Fiscal (USD)</th></tr></thead><tbody>${teamRows || '<tr><td colspan="4">Sin pagos registrados.</td></tr>'}</tbody></table>
        </div>

        <div class="blk print-block"><h2 style="margin-top:0">IMPUESTOS RETENIDOS</h2><div class="row"><span>Retenci√≥n de IVA Acumulada (USD):</span><span>${summary.retIva}</span></div><div class="row"><span>Retenci√≥n de ISLR Acumulada (USD):</span><span>${summary.retIslr}</span></div></div>
        <div class="blk print-block"><h2 style="margin-top:0">RESULTADO FINANCIERO</h2><div class="row"><span>Pagos recibidos acumulados (USD):</span><span>${summary.totalReceipts}</span></div><div class="row"><span>Pago a Consultores acumulado (USD):</span><span>${summary.consultants}</span></div><div class="row"><span>Pago a Gerentes de Proyectos acumulado (USD):</span><span>${summary.managers}</span></div><div class="row"><span>Gasto Administrativo acumulado (USD):</span><span>${summary.expenses}</span></div><div class="row"><span>Total costos y gastos (USD):</span><span>${summary.totalCosts}</span></div><div class="row saldo"><span>Saldo de caja (USD):</span><span>${summary.cash}</span></div></div>
        <div class="blk print-block"><h2 style="margin-top:0">FACTURACI√ìN DEL PROYECTO</h2><div class="row"><span>Monto bruto facturado acumulado al cliente (USD):</span><span>${summary.facturado}</span></div><div class="row saldo"><span>Monto bruto pendiente por facturar (USD):</span><span>${summary.pendiente}</span></div></div>
      
</body></html>`;

      try {
        w.document.open();
        w.document.write(printHtml);
        w.document.close();
      } catch (e) {
        alert('No se pudo construir la vista de impresi√≥n.');
        return;
      }

      let didPrint = false;
      const firePrint = () => {
        if (didPrint) return;
        didPrint = true;
        try { w.focus(); w.print(); } catch (_) {}
      };
      w.addEventListener('load', firePrint, { once: true });
      setTimeout(firePrint, 700);
    }

    function liqAddExpense() {
      const projectKey = (document.getElementById('liqProjectSelect')?.value || '').trim();
      const date = (document.getElementById('liqExpenseDate')?.value || '').trim();
      const concept = (document.getElementById('liqExpenseConcept')?.value || '').trim();
      const amount = parseFloat(document.getElementById('liqExpenseAmount')?.value);
      const rateDay = parseFloat(document.getElementById('liqExpenseRateDay')?.value);
      if (!projectKey) return alert('Selecciona un proyecto.');
      if (!date || !concept || !isFinite(amount) || amount <= 0) return alert('Fecha, concepto y monto son obligatorios.');
      if (!isFinite(rateDay) || rateDay <= 0) return alert('Debes ingresar una tasa del d√≠a v√°lida.');
      const rows = liqDBExpenses();
      rows.push({ id: `GX-${Date.now()}`, projectKey, date, concept, amount: round2(amount), rateDay: round2(rateDay) });
      setDB('liquidationExpenses', rows);
      document.getElementById('liqExpenseConcept').value = '';
      document.getElementById('liqExpenseAmount').value = '';
      document.getElementById('liqExpenseRateDay').value = '';
      liqLoadProject();
    }

    function liqDeleteExpense(id) {
      if (!confirm('¬øEliminar este gasto?')) return;
      const rows = liqDBExpenses().filter(x => x.id !== id);
      setDB('liquidationExpenses', rows);
      liqLoadProject();
    }

    function liqEditExpense(id) {
      const rows = liqDBExpenses();
      const idx = rows.findIndex(x => x.id === id);
      if (idx < 0) return;
      const row = rows[idx];
      const date = prompt('Fecha (YYYY-MM-DD):', row.date || '');
      if (date === null) return;
      const concept = prompt('Concepto:', row.concept || '');
      if (concept === null) return;
      const amount = prompt('Monto USD:', String(row.amount || 0));
      if (amount === null) return;
      const rateDay = prompt('Tasa del d√≠a:', String(row.rateDay || 0));
      if (rateDay === null) return;

      const nAmount = parseFloat(amount);
      const nRateDay = parseFloat(rateDay);
      if (!date.trim() || !concept.trim() || !isFinite(nAmount) || nAmount <= 0 || !isFinite(nRateDay) || nRateDay <= 0) {
        alert('Datos inv√°lidos.');
        return;
      }

      rows[idx] = { ...row, date: date.trim(), concept: concept.trim(), amount: round2(nAmount), rateDay: round2(nRateDay) };
      setDB('liquidationExpenses', rows);
      liqLoadProject();
    }

    function liqLoadProject() {
      const p = liqCurrentProject();
      const saleEl = document.getElementById('liqSaleAmount');
      const rtb = document.querySelector('#liqReceiptsTable tbody');
      const etb = document.querySelector('#liqExpensesTable tbody');
      const ttb = document.querySelector('#liqTeamTable tbody');
      const itb = document.querySelector('#liqInvoicesTable tbody');
      if (!saleEl || !rtb || !etb || !ttb || !itb) return;

      rtb.innerHTML = '';
      etb.innerHTML = '';
      ttb.innerHTML = '';
      itb.innerHTML = '';

      if (!p) {
        saleEl.value = '';
        const zeroIds = ['liqRetIva','liqRetIslr','liqTotalReceipts','liqTotalFiscalConsultants','liqTotalFiscalManagers','liqTotalExpenses','liqTotalCosts','liqCashLeft','liqFacturadoAcum','liqSaldoPendiente'];
        zeroIds.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '0,00 USD'; });
        const a = document.getElementById('liqRetIvaPct');
        const b = document.getElementById('liqRetIslrPct');
        const c = document.getElementById('liqInvBaseUsd');
        const d = document.getElementById('liqInvIvaPct');
        const e = document.getElementById('liqInvIvaUsd');
        const f = document.getElementById('liqInvTotalUsd');
        if (a) a.value = 0;
        if (b) b.value = 0;
        if (c) c.value = 0;
        if (d) d.value = 16;
        if (e) e.value = '0,00 USD';
        if (f) f.value = '0,00 USD';
        return;
      }

      const key = (document.getElementById('liqProjectSelect')?.value || '').trim();
      const sale = parseMoney(p?.totales?.precioFinal);
      saleEl.value = `${fmtVE(sale)} USD`;

      const rcfg = liqGetRetentionConfig(key);
      const retIvaInput = document.getElementById('liqRetIvaPct');
      const retIslrInput = document.getElementById('liqRetIslrPct');
      if (retIvaInput) retIvaInput.value = rcfg.retIvaPct ?? 0;
      if (retIslrInput) retIslrInput.value = rcfg.retIslrPct ?? 0;

      const invBaseEl = document.getElementById('liqInvBaseUsd');
      const invPctEl = document.getElementById('liqInvIvaPct');
      const invDateEl = document.getElementById('liqInvDate');
      const invNumEl = document.getElementById('liqInvNumber');
      const invRefEl = document.getElementById('liqInvPayRef');
      const invIvaOut = document.getElementById('liqInvIvaUsd');
      const invTotalOut = document.getElementById('liqInvTotalUsd');

      // Regla solicitada: al cambiar cliente/proyecto, factura siempre inicia en blanco
      if (key !== liqLastProjectKey) {
        if (invBaseEl) invBaseEl.value = '';
        if (invPctEl) invPctEl.value = '';
        if (invDateEl) invDateEl.value = '';
        if (invNumEl) invNumEl.value = '';
        if (invRefEl) invRefEl.value = '';
        if (invIvaOut) invIvaOut.value = '';
        if (invTotalOut) invTotalOut.value = '';
        liqLastProjectKey = key;
      }

      const receipts = liqDBReceipts().filter(x => x.projectKey === key).sort((a,b)=>a.date.localeCompare(b.date));
      const expenses = liqDBExpenses().filter(x => x.projectKey === key).sort((a,b)=>a.date.localeCompare(b.date));
      const fiscal = (fiscalGetDB() || []).filter(r => ((r.projectKey || '').trim() === key));

      let totalReceipts = 0;
      let pctIvaCount = 0;
      let pctIslrCount = 0;
      let pctIvaSum = 0;
      let pctIslrSum = 0;
      receipts.forEach(x => {
        const amountUsd = isFinite(parseFloat(x.pagoNetoUsd))
          ? parseFloat(x.pagoNetoUsd)
          : (isFinite(parseFloat(x.amountUsd)) ? parseFloat(x.amountUsd) : (parseFloat(x.amount) || 0));
        totalReceipts += amountUsd;

        const retIvaUsd = round2(parseFloat(x.retIvaUsd) || 0);
        const retIslrUsd = round2(parseFloat(x.retIslrUsd) || 0);
        const tasaBsUsd = round2(isFinite(parseFloat(x.tasaBsUsd)) ? parseFloat(x.tasaBsUsd) : (parseFloat(x.rateDay) || 0));
        const retIvaBs = round2(isFinite(parseFloat(x.retIvaBs)) ? parseFloat(x.retIvaBs) : (retIvaUsd * tasaBsUsd));
        const retIslrBs = round2(isFinite(parseFloat(x.retIslrBs)) ? parseFloat(x.retIslrBs) : (retIslrUsd * tasaBsUsd));
        const pctIva = isFinite(parseFloat(x.pctIvaSobreBase))
          ? parseFloat(x.pctIvaSobreBase)
          : (isFinite(parseFloat(x.pctRetIvaSobreBase)) ? parseFloat(x.pctRetIvaSobreBase) : NaN);
        const pctIslr = isFinite(parseFloat(x.pctIslrSobreBase))
          ? parseFloat(x.pctIslrSobreBase)
          : (isFinite(parseFloat(x.pctRetIslrSobreBase)) ? parseFloat(x.pctRetIslrSobreBase) : NaN);
        const numeroFactura = String(x.numero_factura || x.numeroFactura || '').trim() || '‚Äî';

        if (isFinite(pctIva)) { pctIvaSum += pctIva; pctIvaCount += 1; }
        if (isFinite(pctIslr)) { pctIslrSum += pctIslr; pctIslrCount += 1; }

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.date}</td><td class="num">${fmtVE(x.amountBs || 0)} Bs</td><td class="num">${fmtVE(tasaBsUsd)}</td><td class="num">${fmtVE(amountUsd)} USD</td><td class="num">${fmtVE(retIvaUsd)} USD</td><td class="num">${liqFmtRetentionPct(pctIva)}</td><td class="num">${fmtVE(retIvaBs)} Bs</td><td class="num">${fmtVE(retIslrUsd)} USD</td><td class="num">${liqFmtRetentionPct(pctIslr)}</td><td class="num">${fmtVE(retIslrBs)} Bs</td><td title="${fiscalEscape(numeroFactura)}">${fiscalEscape(numeroFactura)}</td><td class="num"><button type="button" class="mini-icon-btn" title="Editar" aria-label="Editar" onclick="liqEditReceipt('${x.id}')">‚úé</button><button type="button" class="mini-icon-btn" title="Eliminar" aria-label="Eliminar" onclick="liqDeleteReceipt('${x.id}')">‚å´</button></td>`;
        rtb.appendChild(tr);
      });
      if (receipts.length === 0) rtb.innerHTML = '<tr><td colspan="12" class="helper-text">Sin pagos recibidos registrados.</td></tr>';

      let totalExpenses = 0;
      expenses.forEach(x => {
        totalExpenses += x.amount || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.date}</td><td>${fiscalEscape(x.concept)}</td><td>${fmtVE(x.amount)} USD</td><td>${fmtVE(x.rateDay || 0)}</td><td><button type="button" class="mini-icon-btn" title="Editar" aria-label="Editar" onclick="liqEditExpense('${x.id}')">‚úé</button><button type="button" class="mini-icon-btn" title="Eliminar" aria-label="Eliminar" onclick="liqDeleteExpense('${x.id}')">‚å´</button></td>`;
        etb.appendChild(tr);
      });
      if (expenses.length === 0) etb.innerHTML = '<tr><td colspan="5" class="helper-text">Sin gastos extraordinarios.</td></tr>';

      const invoices = (getDB('liquidationIssuedInvoices') || [])
        .filter(x => (x.projectKey || '').trim() === key)
        .sort((a,b) => (b.fecha || '').localeCompare(a.fecha || ''));
      invoices.forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.fecha || ''}</td><td>${fiscalEscape(x.numeroFactura || x.numero_factura || '-')}</td><td title="${fiscalEscape(x.cliente || '')}">${fiscalEscape(x.cliente || '')}</td><td title="${fiscalEscape(x.proyecto || '')}">${fiscalEscape(x.proyecto || '')}</td><td title="${fiscalEscape(x.referenciaPago || '-')}">${fiscalEscape(x.referenciaPago || '-')}</td><td>${fmtVE(x.baseUsd || 0)} USD</td><td>${fmtVE(x.ivaUsd || 0)} USD</td><td>${fmtVE(x.totalUsd || 0)} USD</td><td><button type="button" class="mini-icon-btn" title="Editar" aria-label="Editar" onclick="liqEditIssuedInvoice('${x.id}')">‚úé</button><button type="button" class="mini-icon-btn" title="Eliminar" aria-label="Eliminar" onclick="liqDeleteIssuedInvoice('${x.id}')">‚å´</button></td>`;
        itb.appendChild(tr);
      });
      if (invoices.length === 0) itb.innerHTML = '<tr><td colspan="9" class="helper-text">Sin facturas emitidas guardadas.</td></tr>';

      const fiscalByResource = {};
      fiscal.forEach(r => {
        const k = (r.consultor || '').trim();
        if (!k) return;
        if (!fiscalByResource[k]) fiscalByResource[k] = { usd: 0, hours: 0 };
        fiscalByResource[k].usd += (parseFloat(r.totalUsd) || 0);
        fiscalByResource[k].hours += (parseFloat(r.horas) || 0);
      });

      const roleByName = {};
      (p.consultores || []).forEach(c => {
        const name = (c.nombre || '').trim();
        if (name) roleByName[name] = 'Consultor';
      });
      (p.gerentes || []).forEach(g => {
        const name = (g.nombre || '').trim();
        if (name && !roleByName[name]) roleByName[name] = 'Gerente';
      });

      const paidRows = Object.entries(fiscalByResource)
        .filter(([_, v]) => (v.hours || 0) > 0)
        .sort((a, b) => a[0].localeCompare(b[0]));

      paidRows.forEach(([name, v]) => {
        const role = roleByName[name] || 'Recurso';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${role}</td><td>${fiscalEscape(name)}</td><td>${fmtVE(v.hours)} h</td><td>${fmtVE(v.usd)} USD</td>`;
        ttb.appendChild(tr);
      });

      if (paidRows.length === 0) {
        ttb.innerHTML = '<tr><td colspan="4" class="helper-text">Sin pagos registrados en Motor Fiscal para este proyecto.</td></tr>';
      }

      let totalFiscalConsultants = 0;
      let totalFiscalManagers = 0;
      paidRows.forEach(([name, v]) => {
        const role = roleByName[name] || 'Recurso';
        if (role === 'Gerente') totalFiscalManagers += (v.usd || 0);
        else totalFiscalConsultants += (v.usd || 0);
      });

      const invBase = parseFloat(document.getElementById('liqInvBaseUsd')?.value) || 0;
      const invIvaPct = parseFloat(document.getElementById('liqInvIvaPct')?.value) || 16;
      const invIvaUsd = round2(invBase * pctToFactor(invIvaPct));
      const invTotal = round2(invBase + invIvaUsd);
      const invIvaOutCalc = document.getElementById('liqInvIvaUsd');
      const invTotalOutCalc = document.getElementById('liqInvTotalUsd');
      if (invIvaOutCalc) invIvaOutCalc.value = `${fmtVE(invIvaUsd)} USD`;
      if (invTotalOutCalc) invTotalOutCalc.value = `${fmtVE(invTotal)} USD`;

      // BLOQUE 1: Impuestos retenidos acumulados
      const retIva = round2(receipts.reduce((s, x) => s + (parseFloat(x.retIvaUsd) || 0), 0));
      const retIslr = round2(receipts.reduce((s, x) => s + (parseFloat(x.retIslrUsd) || 0), 0));

      // BLOQUE 2: Resultado financiero (solo cobros netos y egresos)
      const totalCosts = round2(totalFiscalConsultants + totalFiscalManagers + totalExpenses);
      const cashLeft = round2(totalReceipts - totalCosts);

      // BLOQUE 3: Facturaci√≥n del proyecto (base imponible)
      const facturadoAcum = round2(invoices.reduce((s, x) => s + (parseFloat(x.baseUsd) || 0), 0));
      const saldoPendiente = round2(Math.max(0, sale - facturadoAcum));

      const liqRetIvaEl = document.getElementById('liqRetIva');
      const liqRetIslrEl = document.getElementById('liqRetIslr');
      if (liqRetIvaEl) liqRetIvaEl.textContent = `${fmtVE(retIva)} USD`;
      if (liqRetIslrEl) liqRetIslrEl.textContent = `${fmtVE(retIslr)} USD`;

      const setUSD = (id, n) => { const el = document.getElementById(id); if (el) el.textContent = `${fmtVE(n)} USD`; };
      setUSD('liqTotalReceipts', totalReceipts);
      setUSD('liqTotalFiscalConsultants', totalFiscalConsultants);
      setUSD('liqTotalFiscalManagers', totalFiscalManagers);
      setUSD('liqTotalExpenses', totalExpenses);
      setUSD('liqTotalCosts', totalCosts);
      setUSD('liqCashLeft', cashLeft);
      setUSD('liqFacturadoAcum', facturadoAcum);
      setUSD('liqSaldoPendiente', saldoPendiente);
    }

    function setFxApiStatus(msg, isError = false) {
      const el = document.getElementById('fxApiStatus');
      if (!el) return;
      el.textContent = msg;
      el.style.color = isError ? '#b42318' : '';
    }

    function getRateHistory() {
      return getDB('fxRateHistory') || [];
    }

    function renderRateHistory() {
      const tbody = document.querySelector('#fxHistoryTable tbody');
      if (!tbody) return;

      const token = localStorage.getItem('gf_access_token');
      const useApi = token && window.APP_AUTH && !window.APP_AUTH.simulated;

      const paint = (items) => {
        tbody.innerHTML = '';
        const rows = [...(items || [])].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        rows.forEach((item) => {
          const tr = document.createElement('tr');
          const bcv = Number(item.bcv ?? 0);
          const parallel = Number(item.paralela ?? item.parallel ?? 0);
          const gapPct = bcv > 0 ? ((parallel - bcv) / bcv) : 0;
          tr.innerHTML = `
            <td class="center">${new Date(item.fecha).toLocaleString('es-VE')}</td>
            <td class="num">${formatCurrency(bcv)}</td>
            <td class="num">${formatCurrency(parallel)}</td>
            <td class="num">${formatPct(gapPct)}</td>
            <td title="${item.fuente || item.source || 'manual'}">${item.fuente || item.source || 'manual'}</td>
          `;
          tbody.appendChild(tr);
        });
        if (rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="helper-text">Sin historial de tasas.</td></tr>';
        }
      };

      if (useApi) {
        fetch(`${window.API_BASE_URL}/tasas`, { headers: { Authorization: `Bearer ${token}` } })
          .then(async (res) => {
            if (!res.ok) throw new Error('tasas api');
            const data = await res.json();
            paint(data.items || []);
          })
          .catch(() => {
            const history = getDB('fxRateHistory') || [];
            paint(history);
          });
        return;
      }

      const history = getDB('fxRateHistory') || [];
      paint(history);
    }

    function renderRateHistorySync() {
      // compatibilidad con llamadas antiguas
      renderRateHistory();
    }

    function saveRateSnapshot(source = 'manual') {
      const bcv = parseFloat(document.getElementById('bcvRate').value) || 0;
      const parallel = parseFloat(document.getElementById('parallelRate').value) || 0;
      if (bcv <= 0 || parallel <= 0) {
        setFxApiStatus('Para guardar hist√≥rico, primero carga o ingresa tasas v√°lidas.', true);
        return;
      }
      const list = getRateHistory();
      const last = list[list.length - 1];
      // evita duplicado exacto consecutivo
      if (!last || Number(last.bcv) !== Number(bcv) || Number(last.parallel) !== Number(parallel)) {
        list.push({
          fecha: new Date().toISOString(),
          bcv,
          parallel,
          source
        });
        setDB('fxRateHistory', list);
      }
      renderRateHistory();
      setFxApiStatus(`Tasa guardada en hist√≥rico (${source}).`);
    }

    function clearRateHistory() {
      if (!confirm('¬øSeguro que deseas borrar el hist√≥rico de tasas?')) return;
      setDB('fxRateHistory', []);
      renderRateHistory();
      setFxApiStatus('Hist√≥rico de tasas limpiado.');
    }

    async function fetchDollarRates() {
      try {
        setFxApiStatus('Consultando tasas en DolarAPI...');
        const [ofRes, paRes] = await Promise.all([
          fetch('https://ve.dolarapi.com/v1/dolares/oficial'),
          fetch('https://ve.dolarapi.com/v1/dolares/paralelo')
        ]);
        if (!ofRes.ok || !paRes.ok) {
          throw new Error('No se pudo consultar DolarAPI.');
        }

        const oficial = await ofRes.json();
        const paralelo = await paRes.json();

        const bcv = parseFloat(oficial.promedio);
        const par = parseFloat(paralelo.promedio);

        if (!isFinite(bcv) || !isFinite(par) || bcv <= 0 || par <= 0) {
          throw new Error('Tasas inv√°lidas recibidas desde DolarAPI.');
        }

        document.getElementById('bcvRate').value = bcv;
        document.getElementById('parallelRate').value = par;

        const latest = new Date(Math.max(
          new Date(oficial.fechaActualizacion || 0).getTime(),
          new Date(paralelo.fechaActualizacion || 0).getTime()
        ));

        setFxApiStatus(`Tasas cargadas: BCV ${formatCurrency(bcv)} | Paralela ${formatCurrency(par)} ¬∑ ${latest.toLocaleString('es-VE')}`);
        recalc();
        saveRateSnapshot('api');
      } catch (e) {
        console.error('fetchDollarRates error:', e);
        setFxApiStatus('No se pudieron cargar tasas autom√°ticamente. Puedes ingresarlas manualmente.', true);
      }
    }

    function countLoadedResources() {
      let count = 0;
      document.querySelectorAll('#consultantsTable tbody tr').forEach(row => {
        const idx = row.querySelector('.c-select').value;
        const spec = row.querySelector('.c-spec').value.trim();
        const rate = parseFloat(row.querySelector('.c-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.c-hours').value) || 0;
        if (idx !== '' || spec || rate > 0 || hours > 0) count++;
      });
      document.querySelectorAll('#pmTable tbody tr').forEach(row => {
        const idx = row.querySelector('.pm-select').value;
        const rate = parseFloat(row.querySelector('.pm-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.pm-hours').value) || 0;
        if (idx !== '' || rate > 0 || hours > 0) count++;
      });
      const hint = document.getElementById('resourceCountHint');
      if (hint) hint.textContent = `${count} recurso${count === 1 ? '' : 's'} cargado${count === 1 ? '' : 's'}`;
      return count;
    }
    // Calculate totals
    function recalc() {
      let consultantTotal = 0;
      document.querySelectorAll('#consultantsTable tbody tr').forEach(row => {
        const rate = parseFloat(row.querySelector('.c-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.c-hours').value) || 0;
        const cost = rate * hours;
        row.querySelector('.c-cost').textContent = formatCurrency(cost) + ' USD';
        consultantTotal += cost;
      });
      document.getElementById('consultantCost').textContent = formatCurrency(consultantTotal) + ' USD';
      let pmTotal = 0;
      document.querySelectorAll('#pmTable tbody tr').forEach(row => {
        const rate = parseFloat(row.querySelector('.pm-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.pm-hours').value) || 0;
        const cost = rate * hours;
        row.querySelector('.pm-cost').textContent = formatCurrency(cost) + ' USD';
        pmTotal += cost;
      });
      document.getElementById('pmTotalCost').textContent = formatCurrency(pmTotal) + ' USD';
      const base = consultantTotal + pmTotal;
      document.getElementById('baseCost').textContent = formatCurrency(base) + ' USD';
      let indirectPct = parseFloat(document.getElementById('indirectPct').value) || 0.30;
      indirectPct = indirectPct > 1 ? indirectPct / 100 : indirectPct;
      if (indirectPct >= 1) indirectPct = 0.99;

      const bcvRate = parseFloat(document.getElementById('bcvRate').value) || 0;
      const parallelRate = parseFloat(document.getElementById('parallelRate').value) || 0;

      // P√©rdida cambiaria por cobrar en BCV y recomprar USD en paralela
      // factorCoberturaFX = paralela / bcv
      let fxFactor = 1;
      if (bcvRate > 0 && parallelRate > 0) {
        fxFactor = parallelRate / bcvRate;
        if (!isFinite(fxFactor) || fxFactor <= 0) fxFactor = 1;
        if (fxFactor < 1) fxFactor = 1;
      }

      const adjustedDirectCost = base * fxFactor;
      const exchangeCost = Math.max(0, adjustedDirectCost - base);
      document.getElementById('exchangeCost').textContent = formatCurrency(exchangeCost) + ' USD';

      const fxLossPct = base > 0 ? (exchangeCost / base) : 0;
      const fxLossPctEl = document.getElementById('fxLossPct');
      if (fxLossPctEl) fxLossPctEl.textContent = formatPct(fxLossPct);

      // Indirectos = % de ingresos (antes de impuestos)
      // final = (costo_directo_ajustado_fx) / (1 - indirectPct)
      const final = (1 - indirectPct) > 0 ? (adjustedDirectCost / (1 - indirectPct)) : adjustedDirectCost;
      const adminCost = Math.max(0, final * indirectPct);
      document.getElementById('adminCost').textContent = formatCurrency(adminCost) + ' USD';

      document.getElementById('finalPrice').textContent = formatCurrency(final) + ' USD';

      const totalMarkup = base > 0 ? (final - base) / base : 0;
      const markupEl = document.getElementById('totalMarkup');
      if (markupEl) markupEl.textContent = formatPct(totalMarkup);

      countLoadedResources();
    }
    function resetConsultForm() {
      if (!confirm('¬øLimpiar todos los datos del formulario actual?')) return;
      document.getElementById('clientSelect').value = '';
      document.getElementById('projectName').value = '';
      document.querySelectorAll('#consultantsTable tbody tr').forEach(row => {
        row.querySelector('.c-select').value = '';
        row.querySelector('.c-spec').value = '';
        row.querySelector('.c-rate').value = '';
        row.querySelector('.c-hours').value = '';
      });
      document.querySelectorAll('#pmTable tbody tr').forEach(row => {
        row.querySelector('.pm-select').value = '';
        row.querySelector('.pm-rate').value = '';
        row.querySelector('.pm-hours').value = '';
      });
      document.getElementById('bcvRate').value = '';
      document.getElementById('parallelRate').value = '';
      document.getElementById('indirectPct').value = 0.30;
      recalc();
    }
    // Initialize page
    function init() {
      // Mostrar algo de inmediato para evitar pantalla en blanco
      showPage('consult');

      try {
        updateConsultantSelects();
        updateManagerSelects();
        updateClientSelect();
        attachConsultantSelectionHandler();
        attachManagerSelectionHandler();
        document.querySelectorAll('input').forEach(input => {
          input.addEventListener('input', recalc);
        });
        recalc();
        loadPlanillas();
        renderRateHistory();
        fiscalRefreshProjectOptions();
        fiscalRefreshReferenceOptions();
        liqMigrateInvoiceNumbers();
        liqBackfillReceiptInvoiceNumbers();
        liqRefreshClientOptions();

        const taxHorasEl = document.getElementById('taxHoras');
        if (taxHorasEl) taxHorasEl.addEventListener('input', fiscalUpdateHoursAuditUI);

        const bcvV = parseFloat(document.getElementById('bcvRate').value) || 0;
        const parV = parseFloat(document.getElementById('parallelRate').value) || 0;
        if (bcvV <= 0 || parV <= 0) fetchDollarRates();
      } catch (e) {
        console.error('Error en init:', e);
      }
    }
    // Page navigation
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + page).classList.add('active');
      document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('nav-' + page).classList.add('active');
      if (page === 'history') loadPlanillas();
      if (page === 'rates') renderRateHistory();
      if (page === 'fiscal') {
        fiscalRefreshProjectOptions();
        fiscalRefreshReferenceOptions();
      }
      if (page === 'liquidation') {
        liqRefreshClientOptions();
        liqLoadProject();
      }
    }
    // Prepare for printing: hide empty rows
    function preparePrint() {
      const consRows = document.querySelectorAll('#consultantsTable tbody tr');
      consRows.forEach(row => {
        const idx = row.querySelector('.c-select').value;
        const spec = row.querySelector('.c-spec').value.trim();
        const rate = parseFloat(row.querySelector('.c-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.c-hours').value) || 0;
        const hasData = (idx !== '') || spec !== '' || rate > 0 || hours > 0;
        if (!hasData) row.classList.add('hide-print');
        else row.classList.remove('hide-print');
      });
      const pmRows = document.querySelectorAll('#pmTable tbody tr');
      pmRows.forEach(row => {
        const idx = row.querySelector('.pm-select').value;
        const rate = parseFloat(row.querySelector('.pm-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.pm-hours').value) || 0;
        const hasData = (idx !== '') || rate > 0 || hours > 0;
        if (!hasData) row.classList.add('hide-print');
        else row.classList.remove('hide-print');
      });
      window.print();
      setTimeout(() => {
        document.querySelectorAll('.hide-print').forEach(r => r.classList.remove('hide-print'));
      }, 100);
    }
    // Save planilla
    function savePlanilla() {
      // RBAC hard stop: rol consulta no puede guardar
      const role = window.APP_AUTH?.user?.role;
      const isAuth = !!window.APP_AUTH?.isAuthenticated;
      const simulated = !!window.APP_AUTH?.simulated;
      const canWrite = simulated || (isAuth && (role === 'admin_gerente' || role === 'operador'));
      if (!canWrite) {
        alert('Tu rol es solo consulta. No tienes permisos para guardar planillas.');
        return;
      }

      const planilla = {};
      planilla.fecha = new Date().toISOString();
      const clientSelect = document.getElementById('clientSelect');
      const clientIdx = clientSelect.value;
      const clients = getDB('clientDB');
      planilla.cliente = clientIdx !== '' ? clients[clientIdx].name : '';
      planilla.proyecto = document.getElementById('projectName').value.trim();

      if (!planilla.cliente) {
        alert('Debe seleccionar un cliente antes de guardar.');
        return;
      }
      if (!planilla.proyecto) {
        alert('Debe ingresar el nombre del proyecto.');
        return;
      }
      if (countLoadedResources() === 0) {
        alert('Debe cargar al menos un consultor o gerente con horas/tarifa.');
        return;
      }

      planilla.consultores = [];
      document.querySelectorAll('#consultantsTable tbody tr').forEach(row => {
        const idx = row.querySelector('.c-select').value;
        const name = idx !== '' ? getDB('consultantDB')[idx].name : '';
        const spec = row.querySelector('.c-spec').value.trim();
        const rate = parseFloat(row.querySelector('.c-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.c-hours').value) || 0;
        const cost = rate * hours;
        if (name || spec || rate || hours) {
          planilla.consultores.push({ nombre: name, especialidad: spec, tarifa: rate, horas: hours, costo: cost });
        }
      });
      planilla.gerentes = [];
      document.querySelectorAll('#pmTable tbody tr').forEach(row => {
        const idx = row.querySelector('.pm-select').value;
        const name = idx !== '' ? getDB('pmDB')[idx].name : '';
        const rate = parseFloat(row.querySelector('.pm-rate').value) || 0;
        const hours = parseFloat(row.querySelector('.pm-hours').value) || 0;
        const cost = rate * hours;
        if (name || rate || hours) {
          planilla.gerentes.push({ nombre: name, tarifa: rate, horas: hours, costo: cost });
        }
      });
      planilla.parametrosModelo = {
        tasaBCV: parseFloat(document.getElementById('bcvRate').value) || 0,
        tasaParalela: parseFloat(document.getElementById('parallelRate').value) || 0,
        pctIndirectos: parseFloat(document.getElementById('indirectPct').value) || 0.30
      };
      planilla.totales = {
        costoConsultores: document.getElementById('consultantCost').textContent,
        costoGerentes: document.getElementById('pmTotalCost').textContent,
        costoBase: document.getElementById('baseCost').textContent,
        perdidaCambiaria: document.getElementById('exchangeCost').textContent,
        pctPerdidaCambiaria: document.getElementById('fxLossPct').textContent,
        costoIndirectos: document.getElementById('adminCost').textContent,
        precioFinal: document.getElementById('finalPrice').textContent
      };
      const plans = getDB('planillas');
      let correlativo = '';
      let projectKey = '';
      let editingIdx = -1;

      if (historyEditingCorrelativo) {
        editingIdx = plans.findIndex(x => String(x.correlativo) === String(historyEditingCorrelativo));
      }

      if (editingIdx >= 0) {
        correlativo = plans[editingIdx].correlativo;
        projectKey = plans[editingIdx].projectKey || '';
        planilla.fecha = plans[editingIdx].fecha || planilla.fecha;
      } else {
        // Generate correlativo number
        let counter = parseInt(localStorage.getItem('planillaCounter')) || 0;
        counter++;
        localStorage.setItem('planillaCounter', counter);
        correlativo = counter.toString().padStart(4, '0');

        let projectCounter = parseInt(localStorage.getItem('projectKeyCounter')) || 0;
        projectCounter++;
        localStorage.setItem('projectKeyCounter', projectCounter);
        projectKey = `PRJ-${String(projectCounter).padStart(5, '0')}`;
      }

      planilla.correlativo = correlativo;
      planilla.projectKey = projectKey;

      if (editingIdx >= 0) {
        plans[editingIdx] = { ...plans[editingIdx], ...planilla };
      } else {
        plans.push(planilla);
      }
      setDB('planillas', plans);

      // Download JSON file
      const blob = new Blob([JSON.stringify(planilla, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `planilla_${correlativo}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert(editingIdx >= 0
        ? ('Planilla ' + correlativo + ' actualizada correctamente.')
        : ('Planilla guardada como planilla_' + correlativo + '.json'));

      historyEditingCorrelativo = null;
      loadPlanillas();
      fiscalRefreshProjectOptions();
      liqRefreshClientOptions();
    }
    function parseMoney(value) {
      if (typeof value === 'number') return value;
      if (!value) return 0;
      let s = String(value).replace(/\s|USD|Bs|\$/gi, '');
      const lastComma = s.lastIndexOf(',');
      const lastDot = s.lastIndexOf('.');
      if (lastComma > -1 && lastDot > -1) {
        if (lastComma > lastDot) {
          s = s.replace(/\./g, '').replace(',', '.');
        } else {
          s = s.replace(/,/g, '');
        }
      } else if (lastComma > -1) {
        s = s.replace(/\./g, '').replace(',', '.');
      } else {
        s = s.replace(/,/g, '');
      }
      const n = parseFloat(s);
      return isFinite(n) ? n : 0;
    }

    function getFilteredPlanillas() {
      const plans = getDB('planillas') || [];
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = document.getElementById('historyFrom')?.value || '';
      const to = document.getElementById('historyTo')?.value || '';

      return plans.filter(p => {
        const pClient = (p.cliente || '').trim();
        const d = new Date(p.fecha);
        if (client && pClient !== client) return false;
        if (from) {
          const f = new Date(from + 'T00:00:00');
          if (d < f) return false;
        }
        if (to) {
          const t = new Date(to + 'T23:59:59');
          if (d > t) return false;
        }
        return true;
      });
    }

    function updateHistoryClientFilter() {
      const sel = document.getElementById('historyClientFilter');
      if (!sel) return;
      const plans = getDB('planillas') || [];
      const clients = [...new Set(plans.map(p => (p.cliente || '').trim()).filter(Boolean))].sort((a, b) => a.localeCompare(b));
      const prev = sel.value;
      sel.innerHTML = '<option value="">Todos</option>';
      clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      if (clients.includes(prev)) sel.value = prev;
    }

    function renderHistoryRanking(plans) {
      const tbody = document.querySelector('#historyClientRankingTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const acc = {};
      plans.forEach(p => {
        const client = (p.cliente || 'Sin cliente').trim();
        const amount = parseMoney(p?.totales?.precioFinal);
        if (!acc[client]) acc[client] = { count: 0, amount: 0 };
        acc[client].count += 1;
        acc[client].amount += amount;
      });

      const rows = Object.entries(acc)
        .map(([client, v]) => ({ client, count: v.count, amount: v.amount }))
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 10);

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.client}</td><td>${r.count}</td><td>${formatCurrency(r.amount)} USD</td>`;
        tbody.appendChild(tr);
      });

      if (rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para ranking.</td>';
        tbody.appendChild(tr);
      }

      const top = rows[0];
      const repTopClientEl = document.getElementById('repTopClient');
      if (repTopClientEl) {
        const txt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
        repTopClientEl.textContent = txt;
        repTopClientEl.title = txt;
      }
    }

    function updateHistoryKPIs(plans) {
      const totalQuotes = plans.length;
      const totalAmount = plans.reduce((sum, p) => sum + parseMoney(p?.totales?.precioFinal), 0);
      const avg = totalQuotes > 0 ? totalAmount / totalQuotes : 0;

      document.getElementById('repTotalQuotes').textContent = totalQuotes;
      document.getElementById('repTotalAmount').textContent = `${formatCurrency(totalAmount)} USD`;
      document.getElementById('repAvgTicket').textContent = `${formatCurrency(avg)} USD`;
    }

    function resetHistoryFilters() {
      document.getElementById('historyClientFilter').value = '';
      document.getElementById('historyFrom').value = '';
      document.getElementById('historyTo').value = '';
      loadPlanillas();
    }

    function exportHistoryCSV() {
      const plans = getFilteredPlanillas();
      const header = ['Correlativo', 'Fecha', 'Cliente', 'Proyecto', 'Monto_USD'];
      const lines = [header.join(',')];
      plans.forEach(p => {
        const row = [
          p.correlativo || '',
          new Date(p.fecha).toLocaleString('es-VE'),
          (p.cliente || '').replaceAll(',', ' '),
          (p.proyecto || '').replaceAll(',', ' '),
          parseMoney(p?.totales?.precioFinal).toFixed(2)
        ];
        lines.push(row.join(','));
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_planillas_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Load planillas into history table
    function historyFindPlanilla(correlativo) {
      const plans = getDB('planillas') || [];
      return plans.find(p => String(p.correlativo) === String(correlativo)) || null;
    }

    function historyActionButtons(correlativo) {
      const c = String(correlativo).replace(/'/g, "\'");
      return `<span class="history-actions">
        <button type="button" class="mini-icon-btn" title="Ver PDF oficial" aria-label="Ver PDF oficial" onclick="historyOpenPdf('${c}')">üìÑ</button>
        <button type="button" class="mini-icon-btn" title="Editar" aria-label="Editar" onclick="historyEditPlanilla('${c}')">‚úé</button>
        <button type="button" class="mini-icon-btn" title="Eliminar" aria-label="Eliminar" onclick="historyDeletePlanilla('${c}')">‚å´</button>
        <button type="button" class="mini-icon-btn" title="Imprimir" aria-label="Imprimir" onclick="historyPrintPlanilla('${c}')">üñ®Ô∏é</button>
      </span>`;
    }

    async function historyOpenPdf(correlativo) {
      const token = localStorage.getItem('gf_access_token');
      if (!token || !window.APP_AUTH || window.APP_AUTH.simulated) {
        alert('Debes iniciar sesi√≥n API para ver el PDF oficial.');
        return;
      }

      try {
        const res = await fetch(`${window.API_BASE_URL}/planillas?limit=500`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('No se pudo consultar planillas en API');
        const data = await res.json();
        const row = (data.items || []).find(x => String(x.correlativo) === String(correlativo));
        if (!row?.id) {
          alert('Esta planilla a√∫n no est√° en la nube/API.');
          return;
        }
        const pdfRes = await fetch(`${window.API_BASE_URL}/planillas/${row.id}/pdf`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!pdfRes.ok) throw new Error('No se pudo generar el PDF oficial');
        const blob = await pdfRes.blob();
        const blobUrl = URL.createObjectURL(blob);
        window.open(blobUrl, '_blank', 'noopener');
        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
      } catch (e) {
        console.error(e);
        alert(e?.message || 'No se pudo abrir el PDF oficial.');
      }
    }

    async function migrateLocalPlanillasToApi() {
      const token = localStorage.getItem('gf_access_token');
      if (!token || !window.APP_AUTH || window.APP_AUTH.simulated) {
        alert('Debes iniciar sesi√≥n API para migrar a nube.');
        return;
      }

      const localPlans = getDB('planillas') || [];
      if (!localPlans.length) {
        alert('No hay planillas locales para migrar.');
        return;
      }

      if (!confirm(`Se intentar√°n migrar ${localPlans.length} planillas locales a la nube. ¬øContinuar?`)) return;

      const parseMoneySafe = (v) => {
        if (typeof v === 'number') return v;
        if (!v) return 0;
        let text = String(v).replace(/\s|USD|Bs|\$/gi, '');
        const lastComma = text.lastIndexOf(',');
        const lastDot = text.lastIndexOf('.');
        if (lastComma > -1 && lastDot > -1) {
          text = lastComma > lastDot ? text.replace(/\./g, '').replace(',', '.') : text.replace(/,/g, '');
        } else if (lastComma > -1) {
          text = text.replace(/\./g, '').replace(',', '.');
        } else {
          text = text.replace(/,/g, '');
        }
        const n = parseFloat(text);
        return isFinite(n) ? n : 0;
      };

      let created = 0, skipped = 0, failed = 0;

      let apiItems = [];
      try {
        const r = await fetch(`${window.API_BASE_URL}/planillas?limit=500`, { headers: { Authorization: `Bearer ${token}` } });
        if (r.ok) apiItems = (await r.json()).items || [];
      } catch {}
      const norm = (v) => String(v || '').trim().toLowerCase();
      const amount2 = (n) => Number(Number(n || 0).toFixed(2));
      const apiFingerprint = new Set(apiItems.map(x => `${norm(x.cliente)}|${norm(x.proyecto)}|${amount2(x.monto_bruto_usd)}`));

      for (const p of localPlans) {
        const body = {
          cliente: String(p.cliente || '').trim(),
          proyecto: String(p.proyecto || '').trim(),
          monto_bruto_usd: parseMoneySafe(p?.totales?.precioFinal),
          items: (p.consultores || []).map(c => ({
            nombre: c.nombre,
            especialidad: c.especialidad,
            tarifaUsd: c.tarifa,
            horas: c.horas,
            costoUsd: c.costo
          }))
        };
        if (!body.cliente || !body.proyecto) { failed++; continue; }

        const fp = `${norm(body.cliente)}|${norm(body.proyecto)}|${amount2(body.monto_bruto_usd)}`;
        if (apiFingerprint.has(fp)) { skipped++; continue; }

        try {
          const res = await fetch(`${window.API_BASE_URL}/planillas`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(body)
          });
          if (res.ok) { created++; apiFingerprint.add(fp); } else failed++;
        } catch {
          failed++;
        }
      }

      alert(`Migraci√≥n finalizada.
Creadas: ${created}
Omitidas (ya estaban): ${skipped}
Fallidas: ${failed}`);
      await loadPlanillas();
    }

    function historyEditPlanilla(correlativo) {
      const plan = historyFindPlanilla(correlativo);
      if (!plan) return alert('No se encontr√≥ la planilla seleccionada.');

      historyEditingCorrelativo = String(plan.correlativo);

      const clients = getDB('clientDB') || [];
      const clientIdx = clients.findIndex(c => (c.name || '').trim() === (plan.cliente || '').trim());
      const clientSelect = document.getElementById('clientSelect');
      if (clientSelect) clientSelect.value = clientIdx >= 0 ? String(clientIdx) : '';

      const projectNameEl = document.getElementById('projectName');
      if (projectNameEl) projectNameEl.value = plan.proyecto || '';

      // Limpiar filas actuales
      document.querySelectorAll('#consultantsTable tbody tr').forEach(row => {
        row.querySelector('.c-select').value = '';
        row.querySelector('.c-spec').value = '';
        row.querySelector('.c-rate').value = '';
        row.querySelector('.c-hours').value = '';
      });
      document.querySelectorAll('#pmTable tbody tr').forEach(row => {
        row.querySelector('.pm-select').value = '';
        row.querySelector('.pm-rate').value = '';
        row.querySelector('.pm-hours').value = '';
      });

      const consultRows = Array.from(document.querySelectorAll('#consultantsTable tbody tr'));
      (plan.consultores || []).forEach((c, i) => {
        if (!consultRows[i]) return;
        const row = consultRows[i];
        const db = getDB('consultantDB') || [];
        const idx = db.findIndex(x => (x.name || '').trim() === (c.nombre || '').trim());
        if (idx >= 0) row.querySelector('.c-select').value = String(idx);
        row.querySelector('.c-spec').value = c.especialidad || '';
        row.querySelector('.c-rate').value = c.tarifa || '';
        row.querySelector('.c-hours').value = c.horas || '';
      });

      const pmRows = Array.from(document.querySelectorAll('#pmTable tbody tr'));
      (plan.gerentes || []).forEach((m, i) => {
        if (!pmRows[i]) return;
        const row = pmRows[i];
        const db = getDB('pmDB') || [];
        const idx = db.findIndex(x => (x.name || '').trim() === (m.nombre || '').trim());
        if (idx >= 0) row.querySelector('.pm-select').value = String(idx);
        row.querySelector('.pm-rate').value = m.tarifa || '';
        row.querySelector('.pm-hours').value = m.horas || '';
      });

      if (document.getElementById('bcvRate')) document.getElementById('bcvRate').value = plan?.parametrosModelo?.tasaBCV || '';
      if (document.getElementById('parallelRate')) document.getElementById('parallelRate').value = plan?.parametrosModelo?.tasaParalela || '';
      if (document.getElementById('indirectPct')) document.getElementById('indirectPct').value = plan?.parametrosModelo?.pctIndirectos || 0.30;

      recalc();
      showPage('consult');
      alert(`Modo edici√≥n activado para planilla #${plan.correlativo}. Guarda para aplicar cambios.`);
    }

    function historyDeletePlanilla(correlativo) {
      if (!confirm(`¬øEliminar la planilla #${correlativo}? Esta acci√≥n no se puede deshacer.`)) return;
      const plans = getDB('planillas') || [];
      const next = plans.filter(p => String(p.correlativo) !== String(correlativo));
      setDB('planillas', next);
      loadPlanillas();
      fiscalRefreshProjectOptions();
      liqRefreshClientOptions();
    }

    function historyPrintPlanilla(correlativo) {
      const plan = historyFindPlanilla(correlativo);
      if (!plan) return alert('No se encontr√≥ la planilla seleccionada.');

      const logoUrl = new URL('Logo_Hardsoft.png', window.location.href).href;
      const consultRows = (plan.consultores || []).map(c => `<tr><td>${fiscalEscape(c.nombre || '')}</td><td>${fiscalEscape(c.especialidad || '')}</td><td class="num">${fmtVE(c.tarifa || 0)} USD</td><td class="num">${fmtVE(c.horas || 0)}</td><td class="num">${fmtVE(c.costo || 0)} USD</td></tr>`).join('') || '<tr><td colspan="5">Sin consultores</td></tr>';
      const pmRows = (plan.gerentes || []).map(m => `<tr><td>${fiscalEscape(m.nombre || '')}</td><td class="num">${fmtVE(m.tarifa || 0)} USD</td><td class="num">${fmtVE(m.horas || 0)}</td><td class="num">${fmtVE(m.costo || 0)} USD</td></tr>`).join('') || '<tr><td colspan="4">Sin gerentes</td></tr>';

      const w = window.open('about:blank', '_blank');
      if (!w) return alert('No se pudo abrir la vista de impresi√≥n. Permite ventanas emergentes para este sitio.');

      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Planilla ${fiscalEscape(plan.correlativo || '')}</title>
      <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;margin:14px;color:#111}
        .brand{text-align:center;margin-bottom:8px}.brand img{width:70px;height:auto;display:block;margin:0 auto 6px}.brand .title{font-weight:700}
        .meta-card{border:1px solid #d8d8d8;border-radius:10px;padding:8px 10px;margin:4px 0 10px}
        .meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px}
        .meta-item{font-size:12px;line-height:1.25}
        .meta-item .lbl{font-weight:700}
        .meta-item .val{font-weight:400}
        .meta-item.project{grid-column:span 1;white-space:normal;word-break:break-word}
        table{width:100%;border-collapse:collapse;table-layout:fixed;margin:8px 0}
        th,td{border:1px solid #d8d8d8;padding:6px 8px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        th{background:#f3f3f3;text-align:left}.num{text-align:right}
        @page{size:letter;margin:10mm}
      </style></head><body>
      <div class="brand"><img src="${logoUrl}" alt="Logo"/><div class="title">GESTI√ìN FINANCIERA DE PROYECTOS</div></div>
      <div class="meta-card">
        <div class="meta-grid">
          <div class="meta-item"><span class="lbl">Planilla:</span> <span class="val">${fiscalEscape(plan.correlativo || '')}</span></div>
          <div class="meta-item"><span class="lbl">Fecha:</span> <span class="val">${new Date(plan.fecha).toLocaleString('es-VE')}</span></div>
          <div class="meta-item"><span class="lbl">Cliente:</span> <span class="val">${fiscalEscape(plan.cliente || '')}</span></div>
          <div class="meta-item project"><span class="lbl">Proyecto:</span> <span class="val">${fiscalEscape(plan.proyecto || '')}</span></div>
        </div>
      </div>
      <table><thead><tr><th colspan="5">Consultores</th></tr><tr><th>Nombre</th><th>Especialidad</th><th class="num">Tarifa</th><th class="num">Horas</th><th class="num">Costo</th></tr></thead><tbody>${consultRows}</tbody></table>
      <table><thead><tr><th colspan="4">Gerentes de Proyecto</th></tr><tr><th>Nombre</th><th class="num">Tarifa</th><th class="num">Horas</th><th class="num">Costo</th></tr></thead><tbody>${pmRows}</tbody></table>
      <table><thead><tr><th colspan="2">Totales</th></tr></thead><tbody>
        <tr><td>Costo consultores</td><td class="num">${fiscalEscape(plan?.totales?.costoConsultores || '-')}</td></tr>
        <tr><td>Costo gerentes</td><td class="num">${fiscalEscape(plan?.totales?.costoGerentes || '-')}</td></tr>
        <tr><td>Costo base</td><td class="num">${fiscalEscape(plan?.totales?.costoBase || '-')}</td></tr>
        <tr><td>Precio final</td><td class="num"><strong>${fiscalEscape(plan?.totales?.precioFinal || '-')}</strong></td></tr>
      </tbody></table>
      
</body></html>`;

      w.document.open();
      w.document.write(html);
      w.document.close();
      let done = false;
      const p = () => { if (done) return; done = true; try { w.focus(); w.print(); } catch(_){} };
      w.addEventListener('load', p, { once: true });
      setTimeout(p, 600);
    }

    function loadPlanillas() {
      updateHistoryClientFilter();
      const tableBody = document.getElementById('historyTable').querySelector('tbody');
      tableBody.innerHTML = '';
      const plans = getFilteredPlanillas();

      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = p.totales && p.totales.precioFinal ? p.totales.precioFinal : '';
        tr.innerHTML = `<td>${p.correlativo}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });

      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      updateHistoryKPIs(plans);
      renderHistoryRanking(plans);
    }

    // Display stored entries for consultants, managers or clients with editable fields
    function displayDBList(type) {
      const output = document.getElementById('dbListOutput');
      output.innerHTML = '';
      let data = [];
      let headers = [];
      if (type === 'consultant') {
        data = getDB('consultantDB');
        headers = ['#', 'Nombre', 'Especialidad', 'Correo', 'Tarifa por hora ($)', 'Acci√≥n'];
      } else if (type === 'pm') {
        data = getDB('pmDB');
        headers = ['#', 'Nombre', 'Correo', 'Tarifa por hora ($)', 'Acci√≥n'];
      } else if (type === 'client') {
        data = getDB('clientDB');
        headers = ['#', 'Nombre', 'RIF', 'Acci√≥n'];
      }
      if (!data || data.length === 0) {
        output.innerHTML = '<p>No hay datos para mostrar.</p>';
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      data.forEach((item, idx) => {
        const tr = document.createElement('tr');
        // start with index column
        let rowHtml = `<td>${idx + 1}</td>`;
        if (type === 'consultant') {
          rowHtml +=
            `<td><input type="text" id="consultant-name-${idx}" value="${item.name || ''}" /></td>` +
            `<td><input type="text" id="consultant-spec-${idx}" value="${item.spec || ''}" /></td>` +
            `<td><input type="email" id="consultant-email-${idx}" value="${item.email || ''}" /></td>` +
            `<td><input type="number" id="consultant-rate-${idx}" step="0.01" min="0" value="${item.rate || 0}" /></td>` +
            `<td><button onclick="updateEntry('consultant', ${idx})">Actualizar</button></td>`;
        } else if (type === 'pm') {
          rowHtml +=
            `<td><input type="text" id="pm-name-${idx}" value="${item.name || ''}" /></td>` +
            `<td><input type="email" id="pm-email-${idx}" value="${item.email || ''}" /></td>` +
            `<td><input type="number" id="pm-rate-${idx}" step="0.01" min="0" value="${item.rate || 0}" /></td>` +
            `<td><button onclick="updateEntry('pm', ${idx})">Actualizar</button></td>`;
        } else if (type === 'client') {
          rowHtml +=
            `<td><input type="text" id="client-name-${idx}" value="${item.name || ''}" /></td>` +
            `<td><input type="text" id="client-rif-${idx}" value="${item.rif || ''}" /></td>` +
            `<td><button onclick="updateEntry('client', ${idx})">Actualizar</button></td>`;
        }
        tr.innerHTML = rowHtml;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      output.appendChild(table);
    }

    // Update an entry in the database and refresh the display
    function updateEntry(type, idx) {
      let dbKey;
      if (type === 'consultant') dbKey = 'consultantDB';
      else if (type === 'pm') dbKey = 'pmDB';
      else if (type === 'client') dbKey = 'clientDB';
      let data = getDB(dbKey) || [];

      if (type === 'consultant') {
        const name = document.getElementById(`consultant-name-${idx}`).value.trim();
        const spec = document.getElementById(`consultant-spec-${idx}`).value.trim();
        const email = normalizeEmail(document.getElementById(`consultant-email-${idx}`).value);
        const rate = parseFloat(document.getElementById(`consultant-rate-${idx}`).value) || 0;

        if (!name || !email || rate <= 0) {
          alert('Nombre, correo y tarifa del consultor son obligatorios.');
          return;
        }
        if (!isValidEmail(email)) {
          alert('Correo de consultor inv√°lido.');
          return;
        }
        if (data.some((c, i) => i !== idx && normalizeEmail(c.email) === email)) {
          alert('Ya existe otro consultor con ese correo.');
          return;
        }

        data[idx] = { name, spec, email, rate };
      } else if (type === 'pm') {
        const name = document.getElementById(`pm-name-${idx}`).value.trim();
        const email = normalizeEmail(document.getElementById(`pm-email-${idx}`).value);
        const rate = parseFloat(document.getElementById(`pm-rate-${idx}`).value) || 0;

        if (!name || !email || rate <= 0) {
          alert('Nombre, correo y tarifa del gerente son obligatorios.');
          return;
        }
        if (!isValidEmail(email)) {
          alert('Correo de gerente inv√°lido.');
          return;
        }
        if (data.some((m, i) => i !== idx && normalizeEmail(m.email) === email)) {
          alert('Ya existe otro gerente con ese correo.');
          return;
        }

        data[idx] = { name, email, rate };
      } else if (type === 'client') {
        const name = document.getElementById(`client-name-${idx}`).value.trim();
        const rif = normalizeRif(document.getElementById(`client-rif-${idx}`).value);

        if (!name || !rif) {
          alert('Nombre y RIF del cliente son obligatorios.');
          return;
        }
        if (data.some((c, i) => i !== idx && normalizeRif(c.rif) === rif)) {
          alert('Ya existe otro cliente con ese RIF.');
          return;
        }
        if (data.some((c, i) => i !== idx && (c.name || '').trim().toLowerCase() === name.toLowerCase())) {
          alert('Ya existe otro cliente con ese nombre.');
          return;
        }

        data[idx] = { name, rif };
      }

      setDB(dbKey, data);
      updateDBSelects();
      // show updated list
      displayDBList(type);

      const labels = {
        consultant: 'Consultor',
        pm: 'Gerente',
        client: 'Cliente'
      };
      const label = labels[type] || 'Registro';
      alert(`${label} actualizado y guardado en la base de datos.`);
      cloudNotify(`${label} actualizado y sincronizado localmente.`);
    }
    document.addEventListener('DOMContentLoaded', init);
  

    // DEV v2.0: Historial de planillas (API + respaldo local)
    async function historyFetchPlanillas() {
      const token = localStorage.getItem('gf_access_token');
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      const localPlans = (getDB('planillas') || []).map(p => ({
        correlativo: p.correlativo,
        fecha: p.fecha,
        cliente: p.cliente,
        proyecto: p.proyecto,
        monto_bruto_usd: Number(parseMoney(p?.totales?.precioFinal) || 0),
        _source: 'local'
      }));

      if (token && window.APP_AUTH && !window.APP_AUTH.simulated) {
        try {
          const q = new URLSearchParams();
          if (client) q.set('cliente', client);
          if (from) q.set('from', from);
          if (to) q.set('to', to);
          q.set('limit', '500');
          const res = await fetch(`${window.API_BASE_URL}/planillas?${q.toString()}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('API planillas error');
          const data = await res.json();
          const apiPlans = (data.items || []).map(x => ({
            correlativo: x.correlativo,
            fecha: x.fecha,
            cliente: x.cliente,
            proyecto: x.proyecto,
            monto_bruto_usd: Number(x.monto_bruto_usd || 0),
            _source: 'api'
          }));

          // Si API est√° vac√≠a temporalmente, no borrar de golpe lo local en pantalla.
          if (!apiPlans.length && localPlans.length) return localPlans;

          // Merge defensivo: API manda; local rellena faltantes.
          const toNorm = (v) => String(v || '').trim().toLowerCase();
          const amount2 = (n) => Number(Number(n || 0).toFixed(2));
          const byKey = new Map();
          [...apiPlans, ...localPlans].forEach(p => {
            const k = `${toNorm(p.cliente)}|${toNorm(p.proyecto)}|${amount2(p.monto_bruto_usd)}`;
            if (!byKey.has(k) || p._source === 'api') byKey.set(k, p);
          });
          return Array.from(byKey.values());
        } catch (e) {
          console.warn('API historial fallback local:', e?.message || e);
        }
      }

      return localPlans;
    }

    async function loadPlanillas() {
      const tableBody = document.querySelector('#historyTable tbody');
      const rankingBody = document.querySelector('#historyClientRankingTable tbody');
      if (!tableBody || !rankingBody) return;

      let plans = await historyFetchPlanillas();

      // filtros cliente/fecha en frontend (para API y fallback)
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      if (client) plans = plans.filter(p => (p.cliente || '') === client);
      if (from) {
        const fd = new Date(from + 'T00:00:00');
        plans = plans.filter(p => new Date(p.fecha) >= fd);
      }
      if (to) {
        const td = new Date(to + 'T23:59:59');
        plans = plans.filter(p => new Date(p.fecha) <= td);
      }

      // refrescar opciones de cliente
      const clientSel = document.getElementById('historyClientFilter');
      if (clientSel && !clientSel.dataset.locked) {
        const prev = clientSel.value;
        const unique = [...new Set((plans.map(p => (p.cliente || '').trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b));
        clientSel.innerHTML = '<option value="">Todos</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        if (prev && unique.includes(prev)) clientSel.value = prev;
      }

      tableBody.innerHTML = '';
      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = `${formatCurrency(Number(p.monto_bruto_usd || 0))} USD`;
        tr.innerHTML = `<td>${p.correlativo || ''}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });
      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      // KPIs
      const total = plans.length;
      const amount = plans.reduce((s,p)=>s+Number(p.monto_bruto_usd||0),0);
      const avg = total ? (amount/total) : 0;
      const byClient = {};
      plans.forEach(p => {
        const c = (p.cliente||'').trim() || 'Sin cliente';
        byClient[c] = byClient[c] || { client:c, quotes:0, amount:0 };
        byClient[c].quotes += 1;
        byClient[c].amount += Number(p.monto_bruto_usd||0);
      });
      const ranking = Object.values(byClient).sort((a,b)=>b.amount-a.amount);
      const top = ranking[0];

      const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
      setTxt('repTotalQuotes', String(total));
      setTxt('repTotalAmount', `${formatCurrency(amount)} USD`);
      setTxt('repAvgTicket', `${formatCurrency(avg)} USD`);
      const topTxt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
      const topEl = document.getElementById('repTopClient');
      if (topEl) { topEl.textContent = topTxt; topEl.title = topTxt; }

      rankingBody.innerHTML = '';
      ranking.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td title="${fiscalEscape(r.client)}">${r.client}</td><td>${r.quotes}</td><td>${formatCurrency(r.amount)} USD</td>`;
        rankingBody.appendChild(tr);
      });
      if (ranking.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para el ranking.</td>';
        rankingBody.appendChild(tr);
      }
    }

</script>
  <!-- Supabase sync layer (opcional, mantiene el HTML actual) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">

    // DEV v2.0: Historial de planillas (API + respaldo local)
    async function historyFetchPlanillas() {
      const token = localStorage.getItem('gf_access_token');
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      const localPlans = (getDB('planillas') || []).map(p => ({
        correlativo: p.correlativo,
        fecha: p.fecha,
        cliente: p.cliente,
        proyecto: p.proyecto,
        monto_bruto_usd: Number(parseMoney(p?.totales?.precioFinal) || 0),
        _source: 'local'
      }));

      if (token && window.APP_AUTH && !window.APP_AUTH.simulated) {
        try {
          const q = new URLSearchParams();
          if (client) q.set('cliente', client);
          if (from) q.set('from', from);
          if (to) q.set('to', to);
          q.set('limit', '500');
          const res = await fetch(`${window.API_BASE_URL}/planillas?${q.toString()}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('API planillas error');
          const data = await res.json();
          const apiPlans = (data.items || []).map(x => ({
            correlativo: x.correlativo,
            fecha: x.fecha,
            cliente: x.cliente,
            proyecto: x.proyecto,
            monto_bruto_usd: Number(x.monto_bruto_usd || 0),
            _source: 'api'
          }));

          // Si API est√° vac√≠a temporalmente, no borrar de golpe lo local en pantalla.
          if (!apiPlans.length && localPlans.length) return localPlans;

          // Merge defensivo: API manda; local rellena faltantes.
          const toNorm = (v) => String(v || '').trim().toLowerCase();
          const amount2 = (n) => Number(Number(n || 0).toFixed(2));
          const byKey = new Map();
          [...apiPlans, ...localPlans].forEach(p => {
            const k = `${toNorm(p.cliente)}|${toNorm(p.proyecto)}|${amount2(p.monto_bruto_usd)}`;
            if (!byKey.has(k) || p._source === 'api') byKey.set(k, p);
          });
          return Array.from(byKey.values());
        } catch (e) {
          console.warn('API historial fallback local:', e?.message || e);
        }
      }

      return localPlans;
    }

    async function loadPlanillas() {
      const tableBody = document.querySelector('#historyTable tbody');
      const rankingBody = document.querySelector('#historyClientRankingTable tbody');
      if (!tableBody || !rankingBody) return;

      let plans = await historyFetchPlanillas();

      // filtros cliente/fecha en frontend (para API y fallback)
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      if (client) plans = plans.filter(p => (p.cliente || '') === client);
      if (from) {
        const fd = new Date(from + 'T00:00:00');
        plans = plans.filter(p => new Date(p.fecha) >= fd);
      }
      if (to) {
        const td = new Date(to + 'T23:59:59');
        plans = plans.filter(p => new Date(p.fecha) <= td);
      }

      // refrescar opciones de cliente
      const clientSel = document.getElementById('historyClientFilter');
      if (clientSel && !clientSel.dataset.locked) {
        const prev = clientSel.value;
        const unique = [...new Set((plans.map(p => (p.cliente || '').trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b));
        clientSel.innerHTML = '<option value="">Todos</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        if (prev && unique.includes(prev)) clientSel.value = prev;
      }

      tableBody.innerHTML = '';
      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = `${formatCurrency(Number(p.monto_bruto_usd || 0))} USD`;
        tr.innerHTML = `<td>${p.correlativo || ''}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });
      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      // KPIs
      const total = plans.length;
      const amount = plans.reduce((s,p)=>s+Number(p.monto_bruto_usd||0),0);
      const avg = total ? (amount/total) : 0;
      const byClient = {};
      plans.forEach(p => {
        const c = (p.cliente||'').trim() || 'Sin cliente';
        byClient[c] = byClient[c] || { client:c, quotes:0, amount:0 };
        byClient[c].quotes += 1;
        byClient[c].amount += Number(p.monto_bruto_usd||0);
      });
      const ranking = Object.values(byClient).sort((a,b)=>b.amount-a.amount);
      const top = ranking[0];

      const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
      setTxt('repTotalQuotes', String(total));
      setTxt('repTotalAmount', `${formatCurrency(amount)} USD`);
      setTxt('repAvgTicket', `${formatCurrency(avg)} USD`);
      const topTxt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
      const topEl = document.getElementById('repTopClient');
      if (topEl) { topEl.textContent = topTxt; topEl.title = topTxt; }

      rankingBody.innerHTML = '';
      ranking.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td title="${fiscalEscape(r.client)}">${r.client}</td><td>${r.quotes}</td><td>${formatCurrency(r.amount)} USD</td>`;
        rankingBody.appendChild(tr);
      });
      if (ranking.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para el ranking.</td>';
        rankingBody.appendChild(tr);
      }
    }

</script>
  <script>
    const CLOUD_KEYS = ['consultantDB', 'pmDB', 'clientDB', 'planillas', 'planillaCounter', 'projectKeyCounter', 'fxRateHistory', 'fiscalOps', 'fiscalRefCounter', 'liquidationReceipts', 'liquidationExpenses', 'liquidationRetentionCfg', 'liquidationInvoiceCfg', 'liquidationIssuedInvoices'];
    const CFG_URL_KEY = 'cloud_supabase_url';
    const CFG_ANON_KEY = 'cloud_supabase_anon_key';

    let sb = null;

    // Arregla el bug: esta funci√≥n era llamada pero no exist√≠a
    function updateDBSelects() {
      updateConsultantSelects();
      updateManagerSelects();
      updateClientSelect();
    }

    function getCloudConfig() {
      return {
        url: (localStorage.getItem(CFG_URL_KEY) || '').trim(),
        anonKey: (localStorage.getItem(CFG_ANON_KEY) || '').trim()
      };
    }

    function initCloudClient() {
      const cfg = getCloudConfig();
      if (!window.supabase || !cfg.url || !cfg.anonKey) {
        sb = null;
        return false;
      }
      try {
        sb = window.supabase.createClient(cfg.url, cfg.anonKey);
        return true;
      } catch (e) {
        console.error('No se pudo iniciar Supabase:', e);
        sb = null;
        return false;
      }
    }

    async function cloudPushKey(key) {
      if (!sb) return;
      try {
        const raw = localStorage.getItem(key);
        let value;
        try {
          value = raw ? JSON.parse(raw) : null;
        } catch {
          value = raw;
        }
        const { error } = await sb.from('kv_store').upsert({ key, value }, { onConflict: 'key' });
        if (error) console.error('Supabase upsert error:', key, error.message);
      } catch (e) {
        console.error('cloudPushKey error:', key, e);
      }
    }

    function hasMeaningfulData(v) {
      if (v === null || v === undefined) return false;
      if (Array.isArray(v)) return v.length > 0;
      if (typeof v === 'object') return Object.keys(v).length > 0;
      if (typeof v === 'string') return v.trim().length > 0;
      if (typeof v === 'number') return !Number.isNaN(v);
      return !!v;
    }

    async function cloudPullAll() {
      if (!sb) return;
      try {
        const { data, error } = await sb.from('kv_store').select('key,value').in('key', CLOUD_KEYS);
        if (error) {
          console.error('Supabase select error:', error.message);
          return;
        }

        (data || []).forEach(row => {
          const cloudVal = row.value;
          const localRaw = localStorage.getItem(row.key);
          let localVal = null;
          try { localVal = localRaw ? JSON.parse(localRaw) : null; } catch { localVal = localRaw; }

          const cloudHas = hasMeaningfulData(cloudVal);
          const localHas = hasMeaningfulData(localVal);

          // evita borrar datos locales v√°lidos cuando la nube viene vac√≠a
          if (!cloudHas && localHas) {
            return;
          }

          localStorage.setItem(row.key, JSON.stringify(cloudVal));
        });
      } catch (e) {
        console.error('cloudPullAll error:', e);
      }
    }

    // Sobrescribe setDB para mantener localStorage + nube (sin romper tu l√≥gica actual)
    const __originalSetDB = setDB;
    setDB = function(key, data) {
      __originalSetDB(key, data);
      if (CLOUD_KEYS.includes(key)) cloudPushKey(key);
    };

    function cloudStatusText() {
      return sb ? '‚òÅÔ∏è Nube activa (Supabase)' : 'üíæ Solo local (sin nube)';
    }

    function cloudNotify(msg, isError = false) {
      const st = document.getElementById('cloudStatus');
      if (!st) return;
      const now = new Date().toLocaleTimeString('es-VE');
      st.textContent = `${isError ? '‚ùå' : '‚úÖ'} ${msg} ¬∑ ${now}`;
      st.style.color = isError ? '#b42318' : '#0f5132';
    }

    function createCloudControls() {
      const page = document.getElementById('page-db');
      if (!page) return;

      let box = document.getElementById('cloudControls');
      if (!box) {
        box = document.createElement('div');
        box.id = 'cloudControls';
        box.className = 'section-card no-print';
        box.style.marginBottom = '12px';
        box.innerHTML = `
          <h3 style="margin-top:0;">Sincronizaci√≥n con Nube (Supabase)</h3>
          <p id="cloudStatus" style="margin: 6px 0 10px 0; font-weight: bold;">${cloudStatusText()}</p>
          <div class="actions-bar">
            <button type="button" id="btnCloudConfig">Configurar Supabase</button>
            <button type="button" id="btnCloudSync">Sincronizar ahora</button>
          </div>
        `;
        page.insertBefore(box, page.firstChild.nextSibling);
      }

      const btnCfg = document.getElementById('btnCloudConfig');
      const btnSync = document.getElementById('btnCloudSync');
      if (!btnCfg || !btnSync) return;

      if (!btnCfg.dataset.bound) {
        btnCfg.dataset.bound = '1';
        btnCfg.addEventListener('click', async () => {
          try {
            const current = getCloudConfig();
            const url = prompt('Pega tu SUPABASE_URL', current.url || '');
            if (url === null) return;
            const anonKey = prompt('Pega tu SUPABASE_ANON_KEY', current.anonKey || '');
            if (anonKey === null) return;

            localStorage.setItem(CFG_URL_KEY, url.trim());
            localStorage.setItem(CFG_ANON_KEY, anonKey.trim());

            if (!initCloudClient()) {
              cloudNotify('No se pudo activar Supabase. Revisa URL/KEY.', true);
              alert('No se pudo activar Supabase. Revisa URL y ANON KEY.');
              return;
            }

            await cloudPullAll();
            updateDBSelects();
            recalc();
            loadPlanillas();
            fiscalRefreshProjectOptions();
            fiscalRefreshReferenceOptions();
            liqRefreshClientOptions();
            cloudNotify('Supabase activado y datos sincronizados.');
            alert('Supabase activado y datos sincronizados.');
          } catch (e) {
            console.error('btnCloudConfig error:', e);
            cloudNotify('Error configurando Supabase.', true);
            alert('Error configurando Supabase. Revisa los datos e int√©ntalo de nuevo.');
          }
        });
      }

      if (!btnSync.dataset.bound) {
        btnSync.dataset.bound = '1';
        btnSync.addEventListener('click', async () => {
          try {
            const btn = document.getElementById('btnCloudSync');
            if (btn) btn.disabled = true;
            cloudNotify('Sincronizando...');

            if (!sb) {
              cloudNotify('Primero configura Supabase.', true);
              alert('Supabase no est√° configurado. Pulsa "Configurar Supabase" primero.');
              return;
            }

            await cloudPullAll();
            for (const key of CLOUD_KEYS) {
              await cloudPushKey(key);
            }

            updateDBSelects();
            recalc();
            loadPlanillas();
            fiscalRefreshProjectOptions();
            fiscalRefreshReferenceOptions();
            liqRefreshClientOptions();

            cloudNotify('Sincronizaci√≥n completada.');
            alert('Sincronizaci√≥n completada.');
          } catch (e) {
            console.error('btnCloudSync error:', e);
            cloudNotify('Error en sincronizaci√≥n. Revisa URL/KEY o conexi√≥n.', true);
            alert('Error al sincronizar con Supabase. Revisa la configuraci√≥n y conexi√≥n.');
          } finally {
            const btn = document.getElementById('btnCloudSync');
            if (btn) btn.disabled = false;
          }
        });
      }
    }

    let __appInitDone = false;
    function runAppInitOnce() {
      if (__appInitDone) return;
      __appInitDone = true;
      try { init(); } catch (e) { console.error('init error', e); }
      try {
        initCloudClient();
        createCloudControls();
        const st0 = document.getElementById('cloudStatus');
        if (st0) st0.textContent = cloudStatusText();
      } catch (e) {
        console.error('cloud controls init error', e);
      }
    }

    // Inicializa una sola vez (evita doble carga/refresh lento)
    runAppInitOnce();

    // Al abrir: asegura init √∫nico y luego sincroniza nube si aplica
    window.addEventListener('load', async () => {
      runAppInitOnce();
      initCloudClient();
      createCloudControls();
      const st = document.getElementById('cloudStatus');
      if (st) st.textContent = cloudStatusText();

      if (!sb) {
        console.log('Modo local (sin Supabase configurado).');
        return;
      }

      await cloudPullAll();
      updateDBSelects();
      recalc();
      loadPlanillas();
      fiscalRefreshProjectOptions();
      fiscalRefreshReferenceOptions();
      liqMigrateInvoiceNumbers();
      liqBackfillReceiptInvoiceNumbers();
      liqRefreshClientOptions();
      console.log('Sincronizaci√≥n con Supabase completada.');
    });
  

    // DEV v2.0: Historial de planillas (API + respaldo local)
    async function historyFetchPlanillas() {
      const token = localStorage.getItem('gf_access_token');
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      const localPlans = (getDB('planillas') || []).map(p => ({
        correlativo: p.correlativo,
        fecha: p.fecha,
        cliente: p.cliente,
        proyecto: p.proyecto,
        monto_bruto_usd: Number(parseMoney(p?.totales?.precioFinal) || 0),
        _source: 'local'
      }));

      if (token && window.APP_AUTH && !window.APP_AUTH.simulated) {
        try {
          const q = new URLSearchParams();
          if (client) q.set('cliente', client);
          if (from) q.set('from', from);
          if (to) q.set('to', to);
          q.set('limit', '500');
          const res = await fetch(`${window.API_BASE_URL}/planillas?${q.toString()}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('API planillas error');
          const data = await res.json();
          const apiPlans = (data.items || []).map(x => ({
            correlativo: x.correlativo,
            fecha: x.fecha,
            cliente: x.cliente,
            proyecto: x.proyecto,
            monto_bruto_usd: Number(x.monto_bruto_usd || 0),
            _source: 'api'
          }));

          // Si API est√° vac√≠a temporalmente, no borrar de golpe lo local en pantalla.
          if (!apiPlans.length && localPlans.length) return localPlans;

          // Merge defensivo: API manda; local rellena faltantes.
          const toNorm = (v) => String(v || '').trim().toLowerCase();
          const amount2 = (n) => Number(Number(n || 0).toFixed(2));
          const byKey = new Map();
          [...apiPlans, ...localPlans].forEach(p => {
            const k = `${toNorm(p.cliente)}|${toNorm(p.proyecto)}|${amount2(p.monto_bruto_usd)}`;
            if (!byKey.has(k) || p._source === 'api') byKey.set(k, p);
          });
          return Array.from(byKey.values());
        } catch (e) {
          console.warn('API historial fallback local:', e?.message || e);
        }
      }

      return localPlans;
    }

    async function loadPlanillas() {
      const tableBody = document.querySelector('#historyTable tbody');
      const rankingBody = document.querySelector('#historyClientRankingTable tbody');
      if (!tableBody || !rankingBody) return;

      let plans = await historyFetchPlanillas();

      // filtros cliente/fecha en frontend (para API y fallback)
      const client = (document.getElementById('historyClientFilter')?.value || '').trim();
      const from = (document.getElementById('historyFrom')?.value || '').trim();
      const to = (document.getElementById('historyTo')?.value || '').trim();

      if (client) plans = plans.filter(p => (p.cliente || '') === client);
      if (from) {
        const fd = new Date(from + 'T00:00:00');
        plans = plans.filter(p => new Date(p.fecha) >= fd);
      }
      if (to) {
        const td = new Date(to + 'T23:59:59');
        plans = plans.filter(p => new Date(p.fecha) <= td);
      }

      // refrescar opciones de cliente
      const clientSel = document.getElementById('historyClientFilter');
      if (clientSel && !clientSel.dataset.locked) {
        const prev = clientSel.value;
        const unique = [...new Set((plans.map(p => (p.cliente || '').trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b));
        clientSel.innerHTML = '<option value="">Todos</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        if (prev && unique.includes(prev)) clientSel.value = prev;
      }

      tableBody.innerHTML = '';
      plans.forEach((p) => {
        const tr = document.createElement('tr');
        const precioFinal = `${formatCurrency(Number(p.monto_bruto_usd || 0))} USD`;
        tr.innerHTML = `<td>${p.correlativo || ''}</td><td>${new Date(p.fecha).toLocaleString()}</td><td title="${fiscalEscape(p.cliente || '')}">${p.cliente || ''}</td><td title="${fiscalEscape(p.proyecto || '')}">${p.proyecto || ''}</td><td>${precioFinal}</td><td>${historyActionButtons(p.correlativo)}</td>`;
        tableBody.appendChild(tr);
      });
      if (plans.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="helper-text">No hay planillas para los filtros seleccionados.</td>';
        tableBody.appendChild(tr);
      }

      // KPIs
      const total = plans.length;
      const amount = plans.reduce((s,p)=>s+Number(p.monto_bruto_usd||0),0);
      const avg = total ? (amount/total) : 0;
      const byClient = {};
      plans.forEach(p => {
        const c = (p.cliente||'').trim() || 'Sin cliente';
        byClient[c] = byClient[c] || { client:c, quotes:0, amount:0 };
        byClient[c].quotes += 1;
        byClient[c].amount += Number(p.monto_bruto_usd||0);
      });
      const ranking = Object.values(byClient).sort((a,b)=>b.amount-a.amount);
      const top = ranking[0];

      const setTxt = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
      setTxt('repTotalQuotes', String(total));
      setTxt('repTotalAmount', `${formatCurrency(amount)} USD`);
      setTxt('repAvgTicket', `${formatCurrency(avg)} USD`);
      const topTxt = top ? `${top.client} (${formatCurrency(top.amount)} USD)` : '-';
      const topEl = document.getElementById('repTopClient');
      if (topEl) { topEl.textContent = topTxt; topEl.title = topTxt; }

      rankingBody.innerHTML = '';
      ranking.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td title="${fiscalEscape(r.client)}">${r.client}</td><td>${r.quotes}</td><td>${formatCurrency(r.amount)} USD</td>`;
        rankingBody.appendChild(tr);
      });
      if (ranking.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="helper-text">Sin datos para el ranking.</td>';
        rankingBody.appendChild(tr);
      }
    }

</script>


<script>
// DEV v2.0 patch: borrado de planillas por rol (safe append)
(function(){
  const _localDelete = window.historyDeletePlanilla;

  window.apiDeletePlanilla = async function(correlativo){
    const token = localStorage.getItem('gf_access_token');
    if (!token) throw new Error('Sin sesi√≥n API');

    const role = window.APP_AUTH?.user?.role;
    if (role !== 'admin_gerente') throw new Error('Sin permisos para eliminar planillas');

    const listRes = await fetch(`${window.API_BASE_URL}/planillas?limit=500`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!listRes.ok) throw new Error('No se pudo consultar planillas');
    const data = await listRes.json();
    const row = (data.items || []).find(x => String(x.correlativo) === String(correlativo));
    if (!row?.id) throw new Error('Planilla no encontrada en API');

    const delRes = await fetch(`${window.API_BASE_URL}/planillas/${row.id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!delRes.ok) {
      const tx = await delRes.text();
      throw new Error(`Error al eliminar (${delRes.status}): ${tx}`);
    }
    return true;
  };

  window.historyDeletePlanilla = async function(correlativo){
    if (!confirm(`¬øEliminar la planilla #${correlativo}? Esta acci√≥n no se puede deshacer.`)) return;

    try {
      if (window.APP_AUTH && window.APP_AUTH.isAuthenticated && !window.APP_AUTH.simulated) {
        await window.apiDeletePlanilla(correlativo);
        if (typeof window.loadPlanillas === 'function') await window.loadPlanillas();
        return;
      }
      if (typeof _localDelete === 'function') return _localDelete(correlativo);
    } catch (e) {
      alert(e?.message || 'No se pudo eliminar la planilla');
    }
  };
})();
</script>
</body>
</html>